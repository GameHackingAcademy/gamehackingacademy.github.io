<!DOCTYPE html>
<html lang="en">
  <head><meta charset="UTF-8">
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"><title>Code Caves &amp; DLL&#39;s · Game Hacking Academy</title><meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="description" content="Game hacking tutorials and lessons.
"><meta name="generator" content="Jekyll (using style of GitBook 3.2.3)"><meta name="author" content="attilathedud"><link rel="stylesheet" href="/assets/gitbook/style.css">
<link rel="stylesheet" href="/assets/gitbook/gitbook-plugin-fontsettings/website.css">
<link rel="stylesheet" href="/assets/gitbook/gitbook-plugin-search-pro/search.css">
<link rel="stylesheet" href="/assets/gitbook/gitbook-plugin-back-to-top-button/plugin.css">

<link rel="stylesheet" href="/assets/gitbook/rouge/base16.css">

<link rel="stylesheet" href="/assets/gitbook/custom.css">
<link rel="stylesheet" href="/assets/gitbook/custom-local.css">

<meta name="HandheldFriendly" content="true"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="/assets/gitbook/images/apple-touch-icon-precomposed-152.png">
<link rel="shortcut icon" href="/assets/images/favicon.ico" type="image/x-icon">

<script src="/assets/particles.min.js"></script>

<style>
    @media screen and (min-width: 1101px) {
      .eyecandy {
        position: fixed;
        bottom: 0;
        right: 0;
        min-height: 50%;
        height: 50%;
        width: 25%;
        pointer-events: none;
        z-index: 1;
      }
    }
    @media screen and (max-width: 1100px) {
      .eyecandy {
        display: none;
      }
    }
  </style>






    <link rel="prev" href="/pages/3/03/" />
     
    <link rel="next" href="/pages/3/05/" />
    
    
  </head>
  <body>
    <div id="particles-js" class="eyecandy"></div>

    <div class="book color-theme-2"><div class="book-summary">
    <script type="text/javascript">
        // Fixes the page links scroll problem on both desktop and mobile browsers
        function pageScrollToTop(element) {
            // both mobile and non-mobile
            $('div.body-inner').animate({scrollTop: 0});
            $(element).parent().find('li>ul>li').removeClass('active');
            return true;  // propagate
        }
        // Fixes the anchor links scroll problem on mobile browsers
        function mobilePageScrollToAnchor(element) {
            $(element).closest('li.chapter').find('ul>li').removeClass('active');
            $(element).parent().addClass('active');
            if ($(document).width() <= 1240) {
                $('div.body-inner').animate({scrollTop: $($(element).attr('href')).get(0).offsetTop});
            }
            return true;
        }
    </script>

    <nav role="navigation">
        <div id="book-search-input" role="search">
            <input type="text" placeholder="Type to search" />
        </div>
        <div id="book-search-input-link" role="search">
            <a href="/assets/search.html">Click to Search</a>
        </div>
        <ul class="summary">
            
                <!-- <p>pages</p> -->
                
                    

                    
                        
                        <li class="chapter" data-level="1.1" data-path="/">
                        
                            <a href="/" onclick="pageScrollToTop(this)">
                                About
                            </a>
                            
                                
                            
                        </li>
                        
                        
                            <li class="divider-header">
                                <a>Basics</a>
                            </li>
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/1/01/">
                        
                            <a href="/pages/1/01/" onclick="pageScrollToTop(this)">
                                Computer Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/1/02/">
                        
                            <a href="/pages/1/02/" onclick="pageScrollToTop(this)">
                                Game Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/1/03/">
                        
                            <a href="/pages/1/03/" onclick="pageScrollToTop(this)">
                                Hacking Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/1/04/">
                        
                            <a href="/pages/1/04/" onclick="pageScrollToTop(this)">
                                Setting Up a VM
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/1/05/">
                        
                            <a href="/pages/1/05/" onclick="pageScrollToTop(this)">
                                Memory Hack
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                            <li class="divider-header">
                                <a>Debugging & Reversing</a>
                            </li>
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/01/">
                        
                            <a href="/pages/2/01/" onclick="pageScrollToTop(this)">
                                Debugging Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/02/">
                        
                            <a href="/pages/2/02/" onclick="pageScrollToTop(this)">
                                Assembly Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/03/">
                        
                            <a href="/pages/2/03/" onclick="pageScrollToTop(this)">
                                Using Breakpoints
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/04/">
                        
                            <a href="/pages/2/04/" onclick="pageScrollToTop(this)">
                                Changing Game Code
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/05/">
                        
                            <a href="/pages/2/05/" onclick="pageScrollToTop(this)">
                                Reversing Code
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/06/">
                        
                            <a href="/pages/2/06/" onclick="pageScrollToTop(this)">
                                Code Caves
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/07/">
                        
                            <a href="/pages/2/07/" onclick="pageScrollToTop(this)">
                                Using Code Caves
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/08/">
                        
                            <a href="/pages/2/08/" onclick="pageScrollToTop(this)">
                                Dynamic Memory Allocation
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/09/">
                        
                            <a href="/pages/2/09/" onclick="pageScrollToTop(this)">
                                Defeating DMA
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                            <li class="divider-header">
                                <a>Programming</a>
                            </li>
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/3/01/">
                        
                            <a href="/pages/3/01/" onclick="pageScrollToTop(this)">
                                Programming Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/3/02/">
                        
                            <a href="/pages/3/02/" onclick="pageScrollToTop(this)">
                                External Memory Hack
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/3/03/">
                        
                            <a href="/pages/3/03/" onclick="pageScrollToTop(this)">
                                DLL Memory Hack
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter active" data-level="1.2" data-path="/pages/3/04/">
                        
                            <a href="/pages/3/04/" onclick="pageScrollToTop(this)">
                                Code Caves &amp; DLL&#39;s
                            </a>
                            
                                
                                    <ul><li><a href="#target" onclick="mobilePageScrollToAnchor(this)" >Target</a></li><li><a href="#identify" onclick="mobilePageScrollToAnchor(this)" >Identify</a></li><li><a href="#understand" onclick="mobilePageScrollToAnchor(this)" >Understand</a></li><li><a href="#assembly-in-c" onclick="mobilePageScrollToAnchor(this)" >Assembly in C++</a></li><li><a href="#assembled-functions" onclick="mobilePageScrollToAnchor(this)" >Assembled Functions</a></li><li><a href="#cave-skeleton" onclick="mobilePageScrollToAnchor(this)" >Cave Skeleton</a></li><li><a href="#changing-gold" onclick="mobilePageScrollToAnchor(this)" >Changing Gold</a></li><li><a href="#redirection" onclick="mobilePageScrollToAnchor(this)" >Redirection</a></li><li><a href="#redirection-function" onclick="mobilePageScrollToAnchor(this)" >Redirection Function</a></li></ul>

                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/3/05/">
                        
                            <a href="/pages/3/05/" onclick="pageScrollToTop(this)">
                                Printing Text
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                            <li class="divider-header">
                                <a>RTS/RPG Hacks</a>
                            </li>
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/4/01/">
                        
                            <a href="/pages/4/01/" onclick="pageScrollToTop(this)">
                                Stathack
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/4/02/">
                        
                            <a href="/pages/4/02/" onclick="pageScrollToTop(this)">
                                Map Hack
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/4/03/">
                        
                            <a href="/pages/4/03/" onclick="pageScrollToTop(this)">
                                Macro Bot
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/4/04/">
                        
                            <a href="/pages/4/04/" onclick="pageScrollToTop(this)">
                                Farming Bot
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                            <li class="divider-header">
                                <a>FPS Hacks</a>
                            </li>
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/01/">
                        
                            <a href="/pages/5/01/" onclick="pageScrollToTop(this)">
                                3D Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/02/">
                        
                            <a href="/pages/5/02/" onclick="pageScrollToTop(this)">
                                Wallhack (Memory)
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/03/">
                        
                            <a href="/pages/5/03/" onclick="pageScrollToTop(this)">
                                Wallhack (OpenGL)
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/04/">
                        
                            <a href="/pages/5/04/" onclick="pageScrollToTop(this)">
                                Chams (OpenGL)
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/05/">
                        
                            <a href="/pages/5/05/" onclick="pageScrollToTop(this)">
                                Triggerbot
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/06/">
                        
                            <a href="/pages/5/06/" onclick="pageScrollToTop(this)">
                                Aimbot
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/07/">
                        
                            <a href="/pages/5/07/" onclick="pageScrollToTop(this)">
                                No Recoil
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/08/">
                        
                            <a href="/pages/5/08/" onclick="pageScrollToTop(this)">
                                Radar Hack
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/09/">
                        
                            <a href="/pages/5/09/" onclick="pageScrollToTop(this)">
                                ESP
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/10/">
                        
                            <a href="/pages/5/10/" onclick="pageScrollToTop(this)">
                                Multihack
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                            <li class="divider-header">
                                <a>Multiplayer</a>
                            </li>
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/6/01/">
                        
                            <a href="/pages/6/01/" onclick="pageScrollToTop(this)">
                                Multiplayer Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/6/02/">
                        
                            <a href="/pages/6/02/" onclick="pageScrollToTop(this)">
                                Packet Analysis
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/6/03/">
                        
                            <a href="/pages/6/03/" onclick="pageScrollToTop(this)">
                                Reversing Packets
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/6/04/">
                        
                            <a href="/pages/6/04/" onclick="pageScrollToTop(this)">
                                Creating an External Client
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/6/05/">
                        
                            <a href="/pages/6/05/" onclick="pageScrollToTop(this)">
                                Proxying TCP Traffic
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                            <li class="divider-header">
                                <a>Tool Development</a>
                            </li>
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/7/01/">
                        
                            <a href="/pages/7/01/" onclick="pageScrollToTop(this)">
                                DLL Injector
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/7/02/">
                        
                            <a href="/pages/7/02/" onclick="pageScrollToTop(this)">
                                Pattern Scanner
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/7/03/">
                        
                            <a href="/pages/7/03/" onclick="pageScrollToTop(this)">
                                Memory Scanner
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/7/04/">
                        
                            <a href="/pages/7/04/" onclick="pageScrollToTop(this)">
                                Disassembler
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/7/05/">
                        
                            <a href="/pages/7/05/" onclick="pageScrollToTop(this)">
                                Debugger
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/7/06/">
                        
                            <a href="/pages/7/06/" onclick="pageScrollToTop(this)">
                                Call Logger
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                            <li class="divider-header">
                                <a>Game Resources</a>
                            </li>
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/8/01/">
                        
                            <a href="/pages/8/01/" onclick="pageScrollToTop(this)">
                                Resource Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/8/02/">
                        
                            <a href="/pages/8/02/" onclick="pageScrollToTop(this)">
                                Modifying Save Data
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/8/03/">
                        
                            <a href="/pages/8/03/" onclick="pageScrollToTop(this)">
                                Modifying Textures
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/8/04/">
                        
                            <a href="/pages/8/04/" onclick="pageScrollToTop(this)">
                                Modifying Units
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                
            
                <!-- <p>posts</p> -->
                
                    

                    
                
            
        </ul>

        &nbsp;
    </nav>
</div>
<div class="book-body">
        <div class="book-header" role="navigation">
          <!-- Title -->
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i>
            
            <a href=".">Code Caves &amp; DLL&#39;s</a>
            
          </h1>
        </div>

        <div class="body-inner"><div class="page-wrapper" tabindex="-1" role="main">
    

    <div class="page-inner">
        <div id="book-search-results">
            <div class="search-noresults">
                <section class="normal markdown-section">
                    

                    <h1 id="target">Target</h1>
<p>Our target in this lesson will be Wesnoth 1.14.9.</p>

<h1 id="identify">Identify</h1>

<p>Our goal in this lesson is to create a code cave inside a DLL. The code cave
will be executed whenever we select <em>Terrain Description</em>. The code
cave will give us 888 gold before bringing up the terrain description box.</p>

<h1 id="understand">Understand</h1>

<p>In the <a href="/pages/2/06/">Using Code Caves</a> lesson, we created a code
cave in the game’s memory. We then adjusted the opcodes in the
<em>Terrain Description</em> feature to <strong>jmp</strong> to this code
cave. We used x64dbg’s built-in instruction assembler to create the code
cave and adjust these opcodes.</p>

<p>To create this behavior inside a DLL, we will first need to create a code
cave in our DLL. We will then need to modify the opcodes in the
<em>Terrain Description</em> feature to jump to this code cave inside our
DLL.</p>

<h1 id="assembly-in-c">Assembly in C++</h1>

<p>One feature of C++ is the ability to insert assembly code into a C++
source file. This assembly will not be modified during the compiling
steps. To do this, you use the <strong>__asm</strong> keyword. For
example, the following code can be used to execute the instruction
<strong>pushad</strong> in a C++ source file:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">__asm</span> <span class="p">{</span>
    <span class="n">pushad</span>
<span class="p">}</span>
</code></pre></div></div>

<p>You can also mix C++ and assembly in a function. For example, the
following code will save all registers, create a variable
<strong>x</strong>, add 1 to it, and then restore all registers:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">__asm</span> <span class="p">{</span>
    <span class="n">pushad</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="kr">__asm</span> <span class="p">{</span>
    <span class="n">popad</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Finally, variables declared in C++ can be referenced in these assembly
blocks. We will use this behavior later when programming our hack.</p>

<h1 id="assembled-functions">Assembled Functions</h1>

<p>To jump to our code cave from Wesnoth’s code, we will need to know our
code cave’s location. The easiest way to accomplish this in C++ is to
declare our code cave as a function. We can then use the
<strong>&amp;</strong> operator on it to retrieve its address, identical
to other variables. The pseudo code for this might look like:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">codecave</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">//our codecave</span>
<span class="p">}</span>
<span class="p">...</span> 
<span class="n">terrain_description_jump_location</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">codecave</span><span class="p">;</span>
</code></pre></div></div>

<p>However, when assembled, functions are normally created with stack frames.
Stack frames allow the compiler to easily offset and compute the location
of local variables and function arguments. We will discuss this behavior
more in future lessons as we explore the stack. For this lesson, we need to
know that the <strong>codecave</strong> function above will be assembled
into:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">codecave:</span>
    <span class="n">push</span> <span class="n">ebp</span>
    <span class="n">mov</span> <span class="n">ebp</span><span class="p">,</span> <span class="n">esp</span>
    <span class="p">...</span>
    <span class="n">mov</span> <span class="n">esp</span><span class="p">,</span> <span class="n">ebp</span>
    <span class="n">pop</span> <span class="n">ebp</span>
    <span class="n">ret</span>
</code></pre></div></div>

<p>These extra instructions can cause our code cave to corrupt the game when
we jump to it. This corruption can then cause the game to crash. To avoid
this behavior, we will use the <strong>__declspec</strong> C++ keyword to
modify how the function is assembled. When using this keyword with the
<strong>naked</strong> attribute, the compiler will not add a stack frame.</p>

<h1 id="cave-skeleton">Cave Skeleton</h1>

<p>Now, we can move on to creating our code cave. First, create a DLL in
Visual Studio identically to how we have done it in previous lessons. The
name for this project will be <em>CodeCaveDLL</em>.</p>

<p>After creating the DLL, we can add our code cave function. Like we
discussed above, the function will use the
<strong>__declspec</strong> keyword to avoid the compiler adding a stack
frame. Its definition will look like:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">__declspec</span><span class="p">(</span><span class="kr">naked</span><span class="p">)</span> <span class="kt">void</span> <span class="nf">codecave</span><span class="p">()</span> <span class="p">{</span>

<span class="p">}</span>
</code></pre></div></div>

<p>As we discussed in the <a href="/pages/2/06/">Using Code Caves</a> lesson, the
first step when creating a code cave is to save and restore the registers
and then restore the overwritten instructions. We identified these
instructions in the <a href="/pages/2/06/">Using Code Caves</a> lesson.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pushad</span>
<span class="n">popad</span>
<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="n">ds</span><span class="o">:</span><span class="p">[</span><span class="n">ecx</span><span class="p">]</span>
<span class="n">lea</span> <span class="n">esi</span><span class="p">,</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="n">ds</span><span class="o">:</span><span class="p">[</span><span class="n">esi</span><span class="p">]</span>
<span class="n">jmp</span> <span class="mh">0xCCAF90</span>
</code></pre></div></div>

<p>When this code cave was created in x64dbg, it looked like:</p>

<p><img src="/assets/images/3/4/wesnoth1.png" alt="Adding a code cave to Wesnoth's Terrain Description Method" /></p>

<p>In our DLL, we will create two separate blocks of assembly instructions.
The first block will save all of the registers. The second block will
restore the registers and then execute the original instructions we have
overwritten. Between these two blocks, we will place C++ code to modify
our player’s gold.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">__asm</span> <span class="p">{</span>
    <span class="n">pushad</span>
<span class="p">}</span>

<span class="c1">// code to modify gold</span>

<span class="kr">__asm</span> <span class="p">{</span>
    <span class="n">popad</span>
    <span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="n">ds</span><span class="o">:</span><span class="p">[</span><span class="n">ecx</span><span class="p">]</span>
    <span class="n">lea</span> <span class="n">esi</span><span class="p">,</span><span class="n">dword</span> <span class="n">ptr</span> <span class="n">ds</span><span class="o">:</span><span class="p">[</span><span class="n">esi</span><span class="p">]</span>
    <span class="n">jmp</span> <span class="mh">0xCCAF90</span>
<span class="p">}</span>
</code></pre></div></div>

<p>If you attempt to compile this code, you will get an error on the
<strong>jmp</strong> instruction:</p>

<p><img src="/assets/images/3/4/ide1.png" alt="Error when jumping to a static address" /></p>

<p>This is because the compiler cannot resolve the
<strong>jmp</strong> instruction when a static address is provided. There
are many types of <strong>jmp</strong> instructions which differ based on
the length of the jump. Without this knowledge, the compiler does not know
how to encode the instruction. There are several ways to resolve this
ambiguity, the easiest of which is to create a variable. That is what we
will do in this lesson.</p>

<p>Since our code cave has no stack frame, we cannot declare variables inside
of it. To bypass this, we will declare all of our variables globally,
right below the include statements. Since we need to hold a static address
value, we will declare the address as a <strong>DWORD</strong>:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;Windows.h&gt;</span><span class="cp">
</span>
<span class="n">DWORD</span> <span class="n">ret_address</span> <span class="o">=</span> <span class="mh">0xCCAF90</span><span class="p">;</span>

<span class="kr">__declspec</span><span class="p">(</span><span class="kr">naked</span><span class="p">)</span> <span class="kt">void</span> <span class="nf">codecave</span><span class="p">()</span> <span class="p">{</span>
    <span class="kr">__asm</span> <span class="p">{</span>
        <span class="n">pushad</span>
    <span class="p">}</span>

    <span class="c1">// code to modify gold</span>

    <span class="kr">__asm</span> <span class="p">{</span>
        <span class="n">popad</span>
        <span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="n">ds</span><span class="o">:</span><span class="p">[</span><span class="n">ecx</span><span class="p">]</span>
        <span class="n">lea</span> <span class="n">esi</span><span class="p">,</span><span class="n">dword</span> <span class="n">ptr</span> <span class="n">ds</span><span class="o">:</span><span class="p">[</span><span class="n">esi</span><span class="p">]</span>
        <span class="n">jmp</span> <span class="n">ret_address</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h1 id="changing-gold">Changing Gold</h1>

<p>With our code cave function created, we can now use the same approach
discussed in the <a href="/pages/3/03/">DLL Memory Hack</a> lesson to
modify the dynamic address of our gold through the use of several
pointers.</p>

<p>As we discussed in the previous section, we will place this code between
the two assembly blocks so that our code cave properly saves and restores
all the game’s registers. The code to change our gold will be mostly
identical to the previous lesson. The only difference is that we will have to
initially declare our variables globally outside of our code cave
function:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DWORD</span><span class="o">*</span> <span class="n">player_base</span><span class="p">;</span>
<span class="n">DWORD</span><span class="o">*</span> <span class="n">game_base</span><span class="p">;</span>
<span class="n">DWORD</span><span class="o">*</span> <span class="n">gold</span><span class="p">;</span>
<span class="p">...</span>
<span class="kr">__declspec</span><span class="p">(</span><span class="kr">naked</span><span class="p">)</span> <span class="kt">void</span> <span class="nf">codecave</span><span class="p">()</span> <span class="p">{</span>
    <span class="kr">__asm</span> <span class="p">{</span>
        <span class="n">pushad</span>
    <span class="p">}</span> 

    <span class="n">player_base</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)</span><span class="mh">0x017EED18</span><span class="p">;</span>
    <span class="n">game_base</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="n">player_base</span> <span class="o">+</span> <span class="mh">0xA90</span><span class="p">);</span>
    <span class="n">gold</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="n">game_base</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
    <span class="o">*</span><span class="n">gold</span> <span class="o">=</span> <span class="mi">888</span><span class="p">;</span>

    <span class="kr">__asm</span> <span class="p">{</span>
        <span class="p">...</span>
</code></pre></div></div>

<h1 id="redirection">Redirection</h1>

<p>Next, we can work on redirecting the game’s code to call this function. To
do this, we will again use a pointer. However, this time we will declare
the pointer to point to the address of the game’s code responsible for
displaying the <em>Terrain Description</em> feature. This will be the same
hooking location we found in the previous code cave lesson at
<code class="language-plaintext highlighter-rouge">0x00CCAF8A</code>.</p>

<p>We need to take a slightly different approach to modify the game’s code
using a pointer. Since we want to modify individual bytes, we will declare
our pointer as an <strong>unsigned char</strong> (short for character).
Unlike a <strong>DWORD</strong>, an
<strong>unsigned char</strong> represents 1 byte of data. Declaring our
pointer like this will give us the flexibility to modify individual bytes.</p>

<p>Before we can modify the game’s code, we will need to change its
protection type. Code is only intended to be executed, so Windows will, by
default, not allow other processes or DLL’s to write data to code
addresses. To change this protection, we will use the API <a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualprotect">VirtualProtect</a>
and reassign the protection type.</p>

<p>Finally, we need to understand how the <strong>jmp</strong> opcode is
structured. We know that <strong>jmp</strong>’s start with the opcode
value of <code class="language-plaintext highlighter-rouge">0xE9</code>. However, there are an additional 4 bytes after
this <code class="language-plaintext highlighter-rouge">0xE9</code>. These additional bytes direct the CPU where to
jump to. These 4 bytes are not simply the new address. We can see an
example from our previous code cave that we created with x64dbg:</p>

<p><img src="/assets/images/3/4/wesnoth2.png" alt="Adding a code cave to Wesnoth's Terrain Description Method" /></p>

<p>There are several resources online that describe how this opcode is
structured. The basic formula is:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">new_location</span> <span class="o">-</span> <span class="n">original_location</span> <span class="o">+</span> <span class="mi">5</span>
</code></pre></div></div>

<p>Let’s verify this formula with the code cave above:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mh">0xCCAF90</span> <span class="o">-</span> <span class="mh">0x1343614</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">=</span> <span class="n">FF</span> <span class="mi">98</span> <span class="mi">79</span> <span class="mi">77</span>
</code></pre></div></div>

<p>This initially looks incorrect. However, bytes are stored in a “reverse”
order on all Windows-compatible CPU’s. This is a concept known as
endianness, which we will cover more in future lessons. If we reverse the
byte order from the value we found above, we find that it matches the
opcode in x64dbg:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">77</span> <span class="mi">79</span> <span class="mi">98</span> <span class="n">FF</span>
</code></pre></div></div>

<p>Since we verified that the formula works, we can implement it into our own
code to <strong>jmp</strong> to our code cave.</p>

<h1 id="redirection-function">Redirection Function</h1>

<p>We will handle the redirection in our <strong>DllMain</strong> function,
when our DLL is first injected. First, we will need to declare a pointer
to our hook location. In addition, the <strong>VirtualProtect</strong> API
requires a parameter to hold the previous protection type. We will declare
that as well:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DWORD</span> <span class="n">old_protect</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">hook_location</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="mh">0x00CCAF8A</span><span class="p">;</span>
</code></pre></div></div>

<p>Next, we will change the protection type for our hook location. The
<strong>VirtualProtect</strong> API has similar parameters to the
<strong>ReadProcessMemory</strong> and
<strong>WriteProcessMemory</strong> API’s. Like we did in our previous
code cave lesson, we will need to rewrite 6 bytes.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (fdwReason == DLL_PROCESS_ATTACH) {
    VirtualProtect((void*)hook_location, 6, PAGE_EXECUTE_READWRITE, &amp;old_protect);
    //redirection
}

return true;
</code></pre></div></div>

<p>With the location now writable, we can begin the process of reassigning
the bytes to jump to our code cave. First, we will set the first byte to
<code class="language-plaintext highlighter-rouge">0xE9</code>:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">*</span><span class="n">hook_location</span> <span class="o">=</span> <span class="mh">0xE9</span><span class="p">;</span>
</code></pre></div></div>

<p>We will then write the additional opcodes needed for the
<strong>jmp</strong> using the formula we tested above. These opcodes will
begin 1 byte after the hooking location:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">*</span><span class="p">(</span><span class="n">hook_location</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">codecave</span> <span class="o">-</span> <span class="p">(</span><span class="n">hook_location</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
</code></pre></div></div>

<p>However, this code will not work as intended. Instead of writing 4 bytes,
this will only write 1 byte. This is because
<strong>hook_location</strong> is defined as a pointer to an
<strong>unsigned char</strong>, which is 1 byte long. To write the 4 bytes
we need, we will cast <strong>hook_location</strong> as a pointer to a
<strong>DWORD</strong>. We will also cast the other variables to
<strong>DWORD</strong>’s:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">*</span><span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(</span><span class="n">hook_location</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="o">&amp;</span><span class="n">codecave</span> <span class="o">-</span> <span class="p">((</span><span class="n">DWORD</span><span class="p">)</span><span class="n">hook_location</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
</code></pre></div></div>

<p>Finally, just like we did in the previous lesson, we need to make the sixth
byte a <strong>nop</strong>. This can be done in an identical manner to
the method we used to set the first byte to a <strong>jmp</strong>. We add
5 (instead of 6) as values are indexed from 0 in C++:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">*</span><span class="p">(</span><span class="n">hook_location</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x90</span><span class="p">;</span>
</code></pre></div></div>

<p>With this done, we can build and inject the DLL identically to how we did
it in the previous lesson. When in game, select
<em>Terrain Description</em> on any tile. Before displaying the description,
your gold should be set to 888.</p>

<p>The full code is on <a href="https://github.com/GameHackingAcademy/Wesnoth_CodeCaveDLL/">github</a> for comparison.</p>

<p> </p>


                </section>
            </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div></div>
    </div>
</div>

<!-- introduce mathjax support -->
<script>
window.MathJax = {
  tex: {
    inlineMath: [ ['$', '$'], ['\\(', '\\)'] ]
  },
  svg: {
    fontCache: 'global'
  }
};
</script>
<script
  type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
</script>


<!-- introduce per-page mermaid support -->


          <a
            href="/pages/3/03/"
            class="navigation navigation-prev navigation-unique"
            aria-label="Previous page: DLL Memory Hack"
          >
            <i class="fa fa-angle-left"></i>
          </a>
           
          <a
            href="/pages/3/05/"
            class="navigation navigation-next navigation-unique"
            aria-label="Next page: Printing Text"
          >
            <i class="fa fa-angle-right"></i>
          </a>
          
        </div>
      </div>

      <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({
    "page": {
        "title": "Introduction",
        "level": "1.1",
        "depth": 1,
        
        "next": {
            "title": "Printing Text",
            "level": "1.2",
            "depth": 1,
            "path": "_pages/3/05.md",
            "ref": "_pages/3/05.md",
            "articles": []
        },
        
        "dir": "ltr"
    },    "config": {
        "plugins": ["fontsettings", "highlight", "livereload", "lunr", "search", "sharing", "theme-default", "livereload"],
        "styles": {
            "ebook": "styles/ebook.css",
            "epub": "styles/epub.css",
            "mobi": "styles/mobi.css",
            "pdf": "styles/pdf.css",
            "print": "styles/print.css",
            "website": "styles/website.css"
        },
        "pluginsConfig": {
            "fontsettings": {
                "family": "sans",
                "size": 2,
                "theme": "white"
            },
            "highlight": {},
            "livereload": {},
            "lunr": {
                "ignoreSpecialCharacters": false,
                "maxIndexSize": 1000000
            },
            "search": {},            "sharing": {
                "facebook": false,

                "google": false,

                "github": true,
                "github_link": "https://github.com/GameHackingAcademy",

                "telegram": false,
                "telegram_link": "https://t.me",

                "instapaper": false,

                "twitter": true,
                "twitter_link": "https://twitter.com/GameHackingAcad",

                "vk": false,

                "weibo": false
            },
"theme-default": {
                "showLevel": false,
                "styles": {
                    "ebook": "styles/ebook.css",
                    "epub": "styles/epub.css",
                    "mobi": "styles/mobi.css",
                    "pdf": "styles/pdf.css",
                    "print": "styles/print.css",
                    "website": "styles/website.css"
                }
            }
        },
        "theme": "default",
        "author": "Tao He",
        "pdf": {
            "pageNumbers": true,
            "fontSize": 12,
            "fontFamily": "Arial",
            "paperSize": "a4",
            "chapterMark": "pagebreak",
            "pageBreaksBefore": "/",
            "margin": {
                "right": 62,
                "left": 62,
                "top": 56,
                "bottom": 56
            }
        },
        "structure": {
            "langs": "LANGS.md",
            "readme": "README.md",
        },
        "variables": {},
        "title": "Game Hacking Academy",
        "language": "en",
        "gitbook": "*"
    },
    "file": {
        "path": "_pages/3/04.md",
        "mtime": "2023-12-25 00:00:00 -0600",
        "type": "markdown"
    },
    "gitbook": {
        "version": "3.2.3",
        "time": "2023-12-26 18:36:09 -0600"
    },
    "basePath": "",
    "book": {
        "language": ""
    }
});
        });
      </script>
    </div><script src="/assets/gitbook/gitbook.js"></script>
<script src="/assets/gitbook/theme.js"></script>

<script src="/assets/gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
<script src="/assets/gitbook/gitbook-plugin-sharing/buttons.js"></script>

<!-- <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
<script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
<script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
<script src="../gitbook/gitbook-plugin-search/search.js"></script> -->

<script src="/assets/gitbook/gitbook-plugin-search-pro/jquery.mark.min.js"></script>
<script src="/assets/gitbook/gitbook-plugin-search-pro/search.js"></script>
<script src="/assets/gitbook/gitbook-plugin-back-to-top-button/plugin.js"></script>
<script src="/assets/gitbook/gitbook-plugin-copy-code-button/toggle.js"></script>

<!-- trackers --><!-- google analytics --><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-160704775-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-160704775-1');
</script>
<script>
      particlesJS("particles-js", {
        particles: {
          number: {
            value: 20,
            density: {
              enable: true,
              value_area: 100,
            },
          },
          color: {
            value: "#6195b9",
          },
          shape: {
            type: "edge",
          },
          opacity: {
            value: 0.3,
            anim: {
              enable: true,
              speed: 0.1,
              opacity_min: 0,
              sync: false,
            },
          },
          size: {
            value: 15,
            random: true,
          },
          line_linked: {
            enable: false,
          },
          move: {
            enable: true,
            speed: 0.5,
            direction: "top",
            random: true,
            straight: true,
            out_mode: "out",
            bounce: false,
            attract: {
              enable: false,
            },
          },
        },
        interactivity: {
          detect_on: "canvas",
          events: {
            onhover: {
              enable: false,
            },
            onclick: {
              enable: false,
            },
            resize: true,
          },
        },
      });
    </script>
  </body>
</html>

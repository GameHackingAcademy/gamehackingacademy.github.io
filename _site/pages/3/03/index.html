<!DOCTYPE html>
<html lang="en">
  <head><meta charset="UTF-8">
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"><title>DLL Memory Hack · Game Hacking Academy</title><meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="description" content="Game hacking tutorials and lessons.
"><meta name="generator" content="Jekyll (using style of GitBook 3.2.3)"><meta name="author" content="attilathedud"><link rel="stylesheet" href="/assets/gitbook/style.css">
<link rel="stylesheet" href="/assets/gitbook/gitbook-plugin-fontsettings/website.css">
<link rel="stylesheet" href="/assets/gitbook/gitbook-plugin-search-pro/search.css">
<link rel="stylesheet" href="/assets/gitbook/gitbook-plugin-back-to-top-button/plugin.css">

<link rel="stylesheet" href="/assets/gitbook/rouge/base16.css">

<link rel="stylesheet" href="/assets/gitbook/custom.css">
<link rel="stylesheet" href="/assets/gitbook/custom-local.css">

<meta name="HandheldFriendly" content="true"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="/assets/gitbook/images/apple-touch-icon-precomposed-152.png">
<link rel="shortcut icon" href="/assets/images/favicon.ico" type="image/x-icon">

<script src="/assets/particles.min.js"></script>

<style>
    @media screen and (min-width: 1101px) {
      .eyecandy {
        position: fixed;
        bottom: 0;
        right: 0;
        min-height: 50%;
        height: 50%;
        width: 25%;
        pointer-events: none;
        z-index: 1;
      }
    }
    @media screen and (max-width: 1100px) {
      .eyecandy {
        display: none;
      }
    }
  </style>






    <link rel="prev" href="/pages/3/02/" />
     
    <link rel="next" href="/pages/3/04/" />
    
    
  </head>
  <body>
    <div id="particles-js" class="eyecandy"></div>

    <div class="book color-theme-2"><div class="book-summary">
    <script type="text/javascript">
        // Fixes the page links scroll problem on both desktop and mobile browsers
        function pageScrollToTop(element) {
            // both mobile and non-mobile
            $('div.body-inner').animate({scrollTop: 0});
            $(element).parent().find('li>ul>li').removeClass('active');
            return true;  // propagate
        }
        // Fixes the anchor links scroll problem on mobile browsers
        function mobilePageScrollToAnchor(element) {
            $(element).closest('li.chapter').find('ul>li').removeClass('active');
            $(element).parent().addClass('active');
            if ($(document).width() <= 1240) {
                $('div.body-inner').animate({scrollTop: $($(element).attr('href')).get(0).offsetTop});
            }
            return true;
        }
    </script>

    <nav role="navigation">
        <div id="book-search-input" role="search">
            <input type="text" placeholder="Type to search" />
        </div>
        <div id="book-search-input-link" role="search">
            <a href="/assets/search.html">Click to Search</a>
        </div>
        <ul class="summary">
            
                <!-- <p>pages</p> -->
                
                    

                    
                        
                        <li class="chapter" data-level="1.1" data-path="/">
                        
                            <a href="/" onclick="pageScrollToTop(this)">
                                About
                            </a>
                            
                                
                            
                        </li>
                        
                        
                            <li class="divider-header">
                                <a>Basics</a>
                            </li>
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/1/01/">
                        
                            <a href="/pages/1/01/" onclick="pageScrollToTop(this)">
                                Computer Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/1/02/">
                        
                            <a href="/pages/1/02/" onclick="pageScrollToTop(this)">
                                Game Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/1/03/">
                        
                            <a href="/pages/1/03/" onclick="pageScrollToTop(this)">
                                Hacking Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/1/04/">
                        
                            <a href="/pages/1/04/" onclick="pageScrollToTop(this)">
                                Setting Up a VM
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/1/05/">
                        
                            <a href="/pages/1/05/" onclick="pageScrollToTop(this)">
                                Memory Hack
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                            <li class="divider-header">
                                <a>Debugging & Reversing</a>
                            </li>
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/01/">
                        
                            <a href="/pages/2/01/" onclick="pageScrollToTop(this)">
                                Debugging Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/02/">
                        
                            <a href="/pages/2/02/" onclick="pageScrollToTop(this)">
                                Assembly Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/03/">
                        
                            <a href="/pages/2/03/" onclick="pageScrollToTop(this)">
                                Using Breakpoints
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/04/">
                        
                            <a href="/pages/2/04/" onclick="pageScrollToTop(this)">
                                Changing Game Code
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/05/">
                        
                            <a href="/pages/2/05/" onclick="pageScrollToTop(this)">
                                Reversing Code
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/06/">
                        
                            <a href="/pages/2/06/" onclick="pageScrollToTop(this)">
                                Code Caves
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/07/">
                        
                            <a href="/pages/2/07/" onclick="pageScrollToTop(this)">
                                Using Code Caves
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/08/">
                        
                            <a href="/pages/2/08/" onclick="pageScrollToTop(this)">
                                Dynamic Memory Allocation
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/09/">
                        
                            <a href="/pages/2/09/" onclick="pageScrollToTop(this)">
                                Defeating DMA
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                            <li class="divider-header">
                                <a>Programming</a>
                            </li>
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/3/01/">
                        
                            <a href="/pages/3/01/" onclick="pageScrollToTop(this)">
                                Programming Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/3/02/">
                        
                            <a href="/pages/3/02/" onclick="pageScrollToTop(this)">
                                External Memory Hack
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter active" data-level="1.2" data-path="/pages/3/03/">
                        
                            <a href="/pages/3/03/" onclick="pageScrollToTop(this)">
                                DLL Memory Hack
                            </a>
                            
                                
                                    <ul><li><a href="#target" onclick="mobilePageScrollToAnchor(this)" >Target</a></li><li><a href="#identify" onclick="mobilePageScrollToAnchor(this)" >Identify</a></li><li><a href="#understand" onclick="mobilePageScrollToAnchor(this)" >Understand</a></li><li><a href="#creating-dlls" onclick="mobilePageScrollToAnchor(this)" >Creating DLL’s</a></li><li><a href="#dll-basics" onclick="mobilePageScrollToAnchor(this)" >DLL Basics</a></li><li><a href="#messagebox" onclick="mobilePageScrollToAnchor(this)" >MessageBox</a></li><li><a href="#injecting-dlls" onclick="mobilePageScrollToAnchor(this)" >Injecting DLL’s</a></li><li><a href="#creating-threads" onclick="mobilePageScrollToAnchor(this)" >Creating Threads</a></li><li><a href="#detecting-key-presses" onclick="mobilePageScrollToAnchor(this)" >Detecting Key Presses</a></li><li><a href="#pointers" onclick="mobilePageScrollToAnchor(this)" >Pointers</a></li></ul>

                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/3/04/">
                        
                            <a href="/pages/3/04/" onclick="pageScrollToTop(this)">
                                Code Caves &amp; DLL&#39;s
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/3/05/">
                        
                            <a href="/pages/3/05/" onclick="pageScrollToTop(this)">
                                Printing Text
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                            <li class="divider-header">
                                <a>RTS/RPG Hacks</a>
                            </li>
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/4/01/">
                        
                            <a href="/pages/4/01/" onclick="pageScrollToTop(this)">
                                Stathack
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/4/02/">
                        
                            <a href="/pages/4/02/" onclick="pageScrollToTop(this)">
                                Map Hack
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/4/03/">
                        
                            <a href="/pages/4/03/" onclick="pageScrollToTop(this)">
                                Macro Bot
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/4/04/">
                        
                            <a href="/pages/4/04/" onclick="pageScrollToTop(this)">
                                Farming Bot
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                            <li class="divider-header">
                                <a>FPS Hacks</a>
                            </li>
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/01/">
                        
                            <a href="/pages/5/01/" onclick="pageScrollToTop(this)">
                                3D Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/02/">
                        
                            <a href="/pages/5/02/" onclick="pageScrollToTop(this)">
                                Wallhack (Memory)
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/03/">
                        
                            <a href="/pages/5/03/" onclick="pageScrollToTop(this)">
                                Wallhack (OpenGL)
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/04/">
                        
                            <a href="/pages/5/04/" onclick="pageScrollToTop(this)">
                                Chams (OpenGL)
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/05/">
                        
                            <a href="/pages/5/05/" onclick="pageScrollToTop(this)">
                                Triggerbot
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/06/">
                        
                            <a href="/pages/5/06/" onclick="pageScrollToTop(this)">
                                Aimbot
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/07/">
                        
                            <a href="/pages/5/07/" onclick="pageScrollToTop(this)">
                                No Recoil
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/08/">
                        
                            <a href="/pages/5/08/" onclick="pageScrollToTop(this)">
                                Radar Hack
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/09/">
                        
                            <a href="/pages/5/09/" onclick="pageScrollToTop(this)">
                                ESP
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/10/">
                        
                            <a href="/pages/5/10/" onclick="pageScrollToTop(this)">
                                Multihack
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                            <li class="divider-header">
                                <a>Multiplayer</a>
                            </li>
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/6/01/">
                        
                            <a href="/pages/6/01/" onclick="pageScrollToTop(this)">
                                Multiplayer Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/6/02/">
                        
                            <a href="/pages/6/02/" onclick="pageScrollToTop(this)">
                                Packet Analysis
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/6/03/">
                        
                            <a href="/pages/6/03/" onclick="pageScrollToTop(this)">
                                Reversing Packets
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/6/04/">
                        
                            <a href="/pages/6/04/" onclick="pageScrollToTop(this)">
                                Creating an External Client
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/6/05/">
                        
                            <a href="/pages/6/05/" onclick="pageScrollToTop(this)">
                                Proxying TCP Traffic
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                            <li class="divider-header">
                                <a>Tool Development</a>
                            </li>
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/7/01/">
                        
                            <a href="/pages/7/01/" onclick="pageScrollToTop(this)">
                                DLL Injector
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/7/02/">
                        
                            <a href="/pages/7/02/" onclick="pageScrollToTop(this)">
                                Pattern Scanner
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/7/03/">
                        
                            <a href="/pages/7/03/" onclick="pageScrollToTop(this)">
                                Memory Scanner
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/7/04/">
                        
                            <a href="/pages/7/04/" onclick="pageScrollToTop(this)">
                                Disassembler
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/7/05/">
                        
                            <a href="/pages/7/05/" onclick="pageScrollToTop(this)">
                                Debugger
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/7/06/">
                        
                            <a href="/pages/7/06/" onclick="pageScrollToTop(this)">
                                Call Logger
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                            <li class="divider-header">
                                <a>Game Resources</a>
                            </li>
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/8/01/">
                        
                            <a href="/pages/8/01/" onclick="pageScrollToTop(this)">
                                Resource Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/8/02/">
                        
                            <a href="/pages/8/02/" onclick="pageScrollToTop(this)">
                                Modifying Save Data
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/8/03/">
                        
                            <a href="/pages/8/03/" onclick="pageScrollToTop(this)">
                                Modifying Textures
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/8/04/">
                        
                            <a href="/pages/8/04/" onclick="pageScrollToTop(this)">
                                Modifying Units
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                
            
                <!-- <p>posts</p> -->
                
                    

                    
                
            
        </ul>

        &nbsp;
    </nav>
</div>
<div class="book-body">
        <div class="book-header" role="navigation">
          <!-- Title -->
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i>
            
            <a href=".">DLL Memory Hack</a>
            
          </h1>
        </div>

        <div class="body-inner"><div class="page-wrapper" tabindex="-1" role="main">
    

    <div class="page-inner">
        <div id="book-search-results">
            <div class="search-noresults">
                <section class="normal markdown-section">
                    

                    <h1 id="target">Target</h1>

<p>Our target in this lesson will be Wesnoth 1.14.9.</p>

<h1 id="identify">Identify</h1>

<p>In this lesson, we will create a dynamic-link library (DLL) that will modify
the player’s gold in Wesnoth. This DLL will modify the player’s gold every
time the user presses a certain key.</p>

<h1 id="understand">Understand</h1>

<p>In the <a href="/lesson/3/2">previous lesson</a>, we created an external
C++ program that used <strong>ReadProcessMemory</strong> and
<strong>WriteProcessMemory</strong> to modify the player’s gold. While
these API’s are useful, they also have several limitations. Due to their
definitions, they require us to cast parameters into a defined type. Their
definitions make it easy to modify simple values like gold, but they make
it difficult to read and write full classes or complex data types.</p>

<p>Since these API’s are executed from an external program, we would struggle
to do things like listen to key presses from the game. In addition, if we
wanted to create a code cave in the game, we would have to manually
convert that code cave into its opcode representation. We would then need
to find a memory location to place it at for
<strong>WriteProcessMemory</strong> to work.</p>

<p>To bypass all of these limitations, we can instead inject a DLL into
Wesnoth. Once injected, this DLL will be loaded into the game and can
directly access the game’s memory through the use of pointers. We can also
create threads that execute inside the game, allowing us to listen for
user input and other events.</p>

<h1 id="creating-dlls">Creating DLL’s</h1>

<p>First, create an empty project, this time named <em>InternalMemoryHack</em>.
After the project is created, add a <em>main.cpp</em> file. The process to
do these steps is identical to the previous lesson.</p>

<p>By default, empty projects in Visual Studios are set to build as
executables. To build a DLL, we will need to change the project’s
<em>Configuration Type</em>. This can be done in the project’s preferences.
First, right-click on the project’s name and select the
<em>Properties</em> menu item.</p>

<p><img src="/assets/images/3/3/ide1.png" alt="Project Properties Menu Item" /></p>

<p>Next, under <em>Configuration Properties</em>, choose <em>General</em>. Then,
change the <em>Configuration Type</em> from <em>Application</em> to
<em>Dynamic Library</em>. Choose <em>Apply</em> and then hit <em>OK</em> to
close the modal.</p>

<p><img src="/assets/images/3/3/ide2.png" alt="Project Configuration Menus" /></p>

<p>Our project will now be built as a DLL instead of an executable.</p>

<h1 id="dll-basics">DLL Basics</h1>

<p>DLL’s cannot be executed by themselves. Instead, they need to be loaded
into an executable. DLL’s allow developers to create libraries of
functions that can be loaded dynamically. These libraries can then be used
across several executables and reduce the amount of code that developers
need to write.</p>

<p>For example, user32.dll contains code that displays modals, alerts, and
other Windows UI elements. Most executables released for Windows load this
DLL automatically and gain access to this functionality without needing
the original code. If Microsoft updates this code and changes how an alert
box looks, all executables that load this library will benefit from this
change.</p>

<p>DLL’s have several differences from normal executables. For our purposes,
we need to know three of them:</p>

<ol>
  <li>DLL’s have a <strong>DllMain</strong> function instead of a <strong>main</strong> function.</li>
  <li>This <strong>DllMain</strong> function is called when a process loads or unloads a DLL.</li>
  <li>DLL’s run inside their parent process. Variables declared in DLL’s are created in the parent’s memory.</li>
</ol>

<p>The <strong>DllMain</strong> function has different parameters from a
<strong>main</strong> function. Its <a href="https://docs.microsoft.com/en-us/windows/win32/dlls/dllmain">definition</a> is:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BOOL</span> <span class="n">WINAPI</span> <span class="nf">DllMain</span><span class="p">(</span>
    <span class="n">_In_</span> <span class="n">HINSTANCE</span> <span class="n">hinstDLL</span><span class="p">,</span>
    <span class="n">_In_</span> <span class="n">DWORD</span>     <span class="n">fdwReason</span><span class="p">,</span>
    <span class="n">_In_</span> <span class="n">LPVOID</span>    <span class="n">lpvReserved</span>
<span class="p">);</span>
</code></pre></div></div>

<p>The <strong>fdwReason</strong> parameter contains the reason that the
<strong>DllMain</strong> function was called. For example, when the DLL is
loaded into a process, this parameter will hold the value of 1. This value
is also defined by the constant <strong>DLL_PROCESS_ATTACH</strong>. To
ensure that our code only executes once, we will check this parameter in
our final hack.</p>

<p>Since DLL’s execute in another process’s memory, we will need to load them
in some manner. In hacking, this is often known as injecting, as we are
falsely loading our DLL into a process. It can often be hard to detect if
a DLL has injected successfully. One approach is to attach a debugger to a
process and observe all of the process’s loaded modules. However, this
approach can be time-consuming and is not always feasible. Another
approach is to create a DLL that will display an obvious indicator when it
is injected. This is the approach we will use to test our DLL injection.</p>

<h1 id="messagebox">MessageBox</h1>

<p>The Windows API has a function to display a message box in a process. The <a href="https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-messagebox">definition</a> for this function is:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">MessageBox</span><span class="p">(</span>
    <span class="n">HWND</span>    <span class="n">hWnd</span><span class="p">,</span>
    <span class="n">LPCTSTR</span> <span class="n">lpText</span><span class="p">,</span>
    <span class="n">LPCTSTR</span> <span class="n">lpCaption</span><span class="p">,</span>
    <span class="n">UINT</span>    <span class="n">uType</span>
<span class="p">);</span>
</code></pre></div></div>

<p>However, due to how C++ handles parameter casting, we can ignore the types
for these values. By calling the <strong>MessageBox</strong> function like
below, we will display a blank message box with an <em>Error</em> title and
no text.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">MessageBox</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</code></pre></div></div>

<p>We can use this behavior to ensure that our DLL is injected successfully
into Wesnoth. In main.cpp, add the following code:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;Windows.h&gt;</span><span class="cp">
</span>
<span class="n">BOOL</span> <span class="n">WINAPI</span> <span class="nf">DllMain</span><span class="p">(</span> <span class="n">HINSTANCE</span> <span class="n">hinstDLL</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">fdwReason</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">lpvReserved</span> <span class="p">)</span> <span class="p">{</span>
<span class="n">MessageBox</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>

<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This code will make our DLL display a message box inside the parent
process whenever the DLL is loaded or unloaded. We will use this behavior
to ensure that our DLL is being injected successfully. Build this code
using the <em>Build</em> option to produce a DLL. This DLL will be placed in
the location you specified when creating the project. By default on our
lab machine, this will be
<em>C:\Users\IEUser\source\repos\InternalMemoryHack\Debug\InternalMemoryHack.dll</em>.</p>

<h1 id="injecting-dlls">Injecting DLL’s</h1>

<p>DLL’s are normally loaded into a process through the use of the
<strong>LoadLibrary</strong> API. However, since we are not modifying the
original source code of the game, we will need to find another way to load
our DLL into Wesnoth.</p>

<p>One approach we can use is a DLL injector. DLL injectors are external
programs that create a thread inside the target process. This is done
through the use of the API <strong>CreateRemoteThread</strong>. This
thread then calls the <strong>LoadLibrary</strong> API inside the process.
In the <a href="/pages/7/01/">DLL Injector</a> lesson, we will cover how to
create a DLL injector.</p>

<p>For this lesson, we will use a feature of Windows that will inject
user-defined DLL’s into every executable that is started. This feature is
called AppInit_DLLs and can be controlled via the registry.</p>

<p>Since this feature is often used by malware, Windows 10 requires
<em>Secure Boot</em> to be disabled for the feature to work. By default,
VirtualBox does not support this feature and it will be disabled. If you
are using actual hardware, you will need to disable it through the BIOS.
Its current state can be determined through the
<em>System Information</em> program:</p>

<p><img src="/assets/images/3/3/inject1.png" alt="Secure Boot State" /></p>

<p>Once <em>Secure Boot</em> is disabled, we need to modify the registry to
enable AppInit_DLLs. This can be done by first opening up the regedit
program. The Windows registry contains keys and values that change OS and
individual program functionality. It is similar to the file system on
Windows in that these keys and values are contained in paths. The path for
the AppInit_DLL feature on 64-bit Windows computers is
<em>Computer\HKEY_LOCAL_MACHINE\SOFTWARE\WOW6432Node\Microsoft\Windows
NT\CurrentVersion\Windows</em>. Navigate to this location in regedit.</p>

<p><img src="/assets/images/3/3/inject2.png" alt="AppInit_DLL path" /></p>

<p>AppInit_DLLs will load any DLL’s specified in the AppInit_DLLs value into
all started programs. Double-click on the <em>AppInit_DLLs</em> value and
change the string to the location of our DLL:</p>

<p><img src="/assets/images/3/3/inject3.png" alt="AppInit_DLL injection path" /></p>

<p>Next, we need to enable the feature by changing the value of
<em>LoadAppInit_DLLs</em>. After making this change, our DLL will be loaded
into every new process. When the value is set at 1, this feature will be
enabled. When it is 0, this feature will be disabled.</p>

<p><img src="/assets/images/3/3/inject4.png" alt="LoadAppInit_DLL value" /></p>

<p>After these changes, the registry key should look like:</p>

<p><img src="/assets/images/3/3/inject5.png" alt="AppInit_DLL registry entry" /></p>

<p>We can now start Wesnoth. Upon starting the game, several message boxes
should appear, indicating that our DLL was injected successfully and is
being both loaded and unloaded.</p>

<p><img src="/assets/images/3/3/inject6.png" alt="Injected DLL displaying message box" /></p>

<p>One important thing to remember is that AppInit_DLL will inject DLL’s into
every started process. This includes the process spawned to build our DLL
as we make changes. To avoid any issues, we will have to disable this
feature when we build our DLL. Make sure, after testing the DLL, to set
the value of LoadAppInit_DLLs to 0. After building our DLL, set this value
back to 1 to re-enable DLL injection.</p>

<h1 id="creating-threads">Creating Threads</h1>

<p>Now that we have verified that DLL injection is working, we can start
programming our hack. We want this DLL to wait for a user to press a key
before changing the gold. To do this, we will create a thread in the
Wesnoth process. This thread will run until the game is exited.</p>

<p>First, we will change our <strong>DllMain</strong> to only execute our
code when our DLL is first loaded into the process. This will ensure that
we only create one thread in the game. We can do this by checking the
<strong>fdwReason</strong> parameter:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BOOL</span> <span class="n">WINAPI</span> <span class="nf">DllMain</span><span class="p">(</span> <span class="n">HINSTANCE</span> <span class="n">hinstDLL</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">fdwReason</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">lpvReserved</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fdwReason</span> <span class="o">==</span> <span class="n">DLL_PROCESS_ATTACH</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Code to execute when the process is loaded</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>To create threads in a process, we can use the <a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createthread">CreateThread</a> API. Its definition is:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">HANDLE</span> <span class="nf">CreateThread</span><span class="p">(</span>
    <span class="n">LPSECURITY_ATTRIBUTES</span>   <span class="n">lpThreadAttributes</span><span class="p">,</span>
    <span class="n">SIZE_T</span>                  <span class="n">dwStackSize</span><span class="p">,</span>
    <span class="n">LPTHREAD_START_ROUTINE</span>  <span class="n">lpStartAddress</span><span class="p">,</span>
    <span class="n">__drv_aliasesMem</span> <span class="n">LPVOID</span> <span class="n">lpParameter</span><span class="p">,</span>
    <span class="n">DWORD</span>                   <span class="n">dwCreationFlags</span><span class="p">,</span>
    <span class="n">LPDWORD</span>                 <span class="n">lpThreadId</span>
<span class="p">);</span>
</code></pre></div></div>

<p>Since we are creating a thread within Wesnoth with no special attributes,
we can ignore most of these parameters. The only parameter we are
concerned with is <strong>lpStartAddress</strong>, which represents the
function we want to execute when the thread is started. Because this
function does not need to return, we will create it as a
<strong>void</strong> function.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">injected_thread</span><span class="p">()</span> <span class="p">{</span>

<span class="p">}</span>

<span class="n">BOOL</span> <span class="n">WINAPI</span> <span class="nf">DllMain</span><span class="p">(</span> <span class="n">HINSTANCE</span> <span class="n">hinstDLL</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">fdwReason</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">lpvReserved</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fdwReason</span> <span class="o">==</span> <span class="n">DLL_PROCESS_ATTACH</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">CreateThread</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPTHREAD_START_ROUTINE</span><span class="p">)</span><span class="n">injected_thread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>When loaded, this code will create a thread that will execute the
<strong>injected_thread</strong> function and then exit. To ensure that
our thread remains active, we will use an infinite
<strong>while</strong> loop in our <strong>injected_thread</strong> function:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">Sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>while</strong> loops will execute until their condition is false.
Since true can never equal false, this while loop will run until our
thread is exited by the closure of the game. To prevent our thread from
causing slowdowns, we can use the <strong>Sleep</strong> API to pause its
execution for a millisecond.</p>

<h1 id="detecting-key-presses">Detecting Key Presses</h1>

<p>To detect a keypress, we can use the <a href="https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-getasynckeystate">GetAsyncKeyState</a> API. This takes a single parameter, which is the key to check for. If the
key is down, it will return true. Otherwise, it will return false. For
this lesson, we will check for the user to press <strong>M</strong>:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">GetAsyncKeyState</span><span class="p">(</span><span class="sc">'M'</span><span class="p">))</span> <span class="p">{</span>
        <span class="c1">// Change the player's gold</span>
    <span class="p">}</span>

    <span class="n">Sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>One important caveat about <strong>GetAsyncKeyState</strong> is that it
will constantly return true if the key is held down. This will not affect
us in this lesson, but if we want to toggle a value off and on in the future,
we will need to account for this behavior.</p>

<h1 id="pointers">Pointers</h1>

<p>In the <a href="/pages/3/01/">Programming Fundamentals</a> lesson,
we discussed pointers. Since our DLL is injected into Wesnoth, we can
access memory in the game through the use of pointers. This allows us to
bypass <strong>ReadProcessMemory</strong> and
<strong>WriteProcessMemory</strong>. However, we will still use the same
offsets and addresses that we used in the previous lesson.</p>

<p>First, we will get the player’s base address by reading the value at
<code class="language-plaintext highlighter-rouge">0x017EED18</code>:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DWORD</span><span class="o">*</span> <span class="n">player_base</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)</span><span class="mh">0x017EED18</span><span class="p">;</span>
</code></pre></div></div>

<p>This will declare <strong>player_base</strong> as a pointer to a
<strong>DWORD</strong> value. The location it will point at is our
player’s base address at <code class="language-plaintext highlighter-rouge">0x017EED18</code>. We can then dereference
this pointer to “read” or retrieve this value. Using this, we can get our
game base address by adding an offset:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DWORD</span><span class="o">*</span> <span class="n">game_base</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="n">player_base</span> <span class="o">+</span> <span class="mh">0xA90</span><span class="p">);</span>
</code></pre></div></div>

<p>Finally, we can dereference the <strong>game_base</strong> address and add
an offset to retrieve our gold value. We can then dereference this gold
value and set its value directly:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DWORD</span><span class="o">*</span> <span class="n">gold</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="n">game_base</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
<span class="o">*</span><span class="n">gold</span> <span class="o">=</span> <span class="mi">999</span><span class="p">;</span>
</code></pre></div></div>

<p>After building the DLL and re-enabling LoadAppInit_DLLs, we can inject
this hack into Wesnoth. Create a game and then hit the “M” key. After you
move your camera, the gold value will be updated to our new value. The
full code for comparison is available on <a href="https://github.com/GameHackingAcademy/Wesnoth_InternalGoldHack/">github.</a></p>

<p><img src="/assets/images/3/3/inject7.png" alt="Injected hack changing gold" /></p>

<p> </p>


                </section>
            </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div></div>
    </div>
</div>

<!-- introduce mathjax support -->
<script>
window.MathJax = {
  tex: {
    inlineMath: [ ['$', '$'], ['\\(', '\\)'] ]
  },
  svg: {
    fontCache: 'global'
  }
};
</script>
<script
  type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
</script>


<!-- introduce per-page mermaid support -->


          <a
            href="/pages/3/02/"
            class="navigation navigation-prev navigation-unique"
            aria-label="Previous page: External Memory Hack"
          >
            <i class="fa fa-angle-left"></i>
          </a>
           
          <a
            href="/pages/3/04/"
            class="navigation navigation-next navigation-unique"
            aria-label="Next page: Code Caves & DLL's"
          >
            <i class="fa fa-angle-right"></i>
          </a>
          
        </div>
      </div>

      <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({
    "page": {
        "title": "Introduction",
        "level": "1.1",
        "depth": 1,
        
        "next": {
            "title": "Code Caves & DLL's",
            "level": "1.2",
            "depth": 1,
            "path": "_pages/3/04.md",
            "ref": "_pages/3/04.md",
            "articles": []
        },
        
        "dir": "ltr"
    },    "config": {
        "plugins": ["fontsettings", "highlight", "livereload", "lunr", "search", "sharing", "theme-default", "livereload"],
        "styles": {
            "ebook": "styles/ebook.css",
            "epub": "styles/epub.css",
            "mobi": "styles/mobi.css",
            "pdf": "styles/pdf.css",
            "print": "styles/print.css",
            "website": "styles/website.css"
        },
        "pluginsConfig": {
            "fontsettings": {
                "family": "sans",
                "size": 2,
                "theme": "white"
            },
            "highlight": {},
            "livereload": {},
            "lunr": {
                "ignoreSpecialCharacters": false,
                "maxIndexSize": 1000000
            },
            "search": {},            "sharing": {
                "facebook": false,

                "google": false,

                "github": true,
                "github_link": "https://github.com/GameHackingAcademy",

                "telegram": false,
                "telegram_link": "https://t.me",

                "instapaper": false,

                "twitter": true,
                "twitter_link": "https://twitter.com/GameHackingAcad",

                "vk": false,

                "weibo": false
            },
"theme-default": {
                "showLevel": false,
                "styles": {
                    "ebook": "styles/ebook.css",
                    "epub": "styles/epub.css",
                    "mobi": "styles/mobi.css",
                    "pdf": "styles/pdf.css",
                    "print": "styles/print.css",
                    "website": "styles/website.css"
                }
            }
        },
        "theme": "default",
        "author": "Tao He",
        "pdf": {
            "pageNumbers": true,
            "fontSize": 12,
            "fontFamily": "Arial",
            "paperSize": "a4",
            "chapterMark": "pagebreak",
            "pageBreaksBefore": "/",
            "margin": {
                "right": 62,
                "left": 62,
                "top": 56,
                "bottom": 56
            }
        },
        "structure": {
            "langs": "LANGS.md",
            "readme": "README.md",
        },
        "variables": {},
        "title": "Game Hacking Academy",
        "language": "en",
        "gitbook": "*"
    },
    "file": {
        "path": "_pages/3/03.md",
        "mtime": "2023-12-25 00:00:00 -0600",
        "type": "markdown"
    },
    "gitbook": {
        "version": "3.2.3",
        "time": "2023-12-31 12:09:34 -0600"
    },
    "basePath": "",
    "book": {
        "language": ""
    }
});
        });
      </script>
    </div><script src="/assets/gitbook/gitbook.js"></script>
<script src="/assets/gitbook/theme.js"></script>

<script src="/assets/gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
<script src="/assets/gitbook/gitbook-plugin-sharing/buttons.js"></script>

<!-- <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
<script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
<script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
<script src="../gitbook/gitbook-plugin-search/search.js"></script> -->

<script src="/assets/gitbook/gitbook-plugin-search-pro/jquery.mark.min.js"></script>
<script src="/assets/gitbook/gitbook-plugin-search-pro/search.js"></script>
<script src="/assets/gitbook/gitbook-plugin-back-to-top-button/plugin.js"></script>
<script src="/assets/gitbook/gitbook-plugin-copy-code-button/toggle.js"></script>

<!-- trackers --><!-- google analytics --><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-160704775-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-160704775-1');
</script>
<script>
      particlesJS("particles-js", {
        particles: {
          number: {
            value: 20,
            density: {
              enable: true,
              value_area: 100,
            },
          },
          color: {
            value: "#6195b9",
          },
          shape: {
            type: "edge",
          },
          opacity: {
            value: 0.3,
            anim: {
              enable: true,
              speed: 0.1,
              opacity_min: 0,
              sync: false,
            },
          },
          size: {
            value: 15,
            random: true,
          },
          line_linked: {
            enable: false,
          },
          move: {
            enable: true,
            speed: 0.5,
            direction: "top",
            random: true,
            straight: true,
            out_mode: "out",
            bounce: false,
            attract: {
              enable: false,
            },
          },
        },
        interactivity: {
          detect_on: "canvas",
          events: {
            onhover: {
              enable: false,
            },
            onclick: {
              enable: false,
            },
            resize: true,
          },
        },
      });
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="en">
  <head><meta charset="UTF-8">
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"><title>Wallhack (OpenGL) · Game Hacking Academy</title><meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="description" content="Game hacking tutorials and lessons.
"><meta name="generator" content="Jekyll (using style of GitBook 3.2.3)"><meta name="author" content="attilathedud"><link rel="stylesheet" href="/assets/gitbook/style.css">
<link rel="stylesheet" href="/assets/gitbook/gitbook-plugin-fontsettings/website.css">
<link rel="stylesheet" href="/assets/gitbook/gitbook-plugin-search-pro/search.css">
<link rel="stylesheet" href="/assets/gitbook/gitbook-plugin-back-to-top-button/plugin.css">

<link rel="stylesheet" href="/assets/gitbook/rouge/base16.css">

<link rel="stylesheet" href="/assets/gitbook/custom.css">
<link rel="stylesheet" href="/assets/gitbook/custom-local.css">

<meta name="HandheldFriendly" content="true"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="/assets/gitbook/images/apple-touch-icon-precomposed-152.png">
<link rel="shortcut icon" href="/assets/images/favicon.ico" type="image/x-icon">

<script src="/assets/particles.min.js"></script>

<style>
    @media screen and (min-width: 1101px) {
      .eyecandy {
        position: fixed;
        bottom: 0;
        right: 0;
        min-height: 50%;
        height: 50%;
        width: 25%;
        pointer-events: none;
        z-index: 1;
      }
    }
    @media screen and (max-width: 1100px) {
      .eyecandy {
        display: none;
      }
    }
  </style>






    <link rel="prev" href="/pages/5/02/" />
     
    <link rel="next" href="/pages/5/04/" />
    
    
  </head>
  <body>
    <div id="particles-js" class="eyecandy"></div>

    <div class="book color-theme-2"><div class="book-summary">
    <script type="text/javascript">
        // Fixes the page links scroll problem on both desktop and mobile browsers
        function pageScrollToTop(element) {
            // both mobile and non-mobile
            $('div.body-inner').animate({scrollTop: 0});
            $(element).parent().find('li>ul>li').removeClass('active');
            return true;  // propagate
        }
        // Fixes the anchor links scroll problem on mobile browsers
        function mobilePageScrollToAnchor(element) {
            $(element).closest('li.chapter').find('ul>li').removeClass('active');
            $(element).parent().addClass('active');
            if ($(document).width() <= 1240) {
                $('div.body-inner').animate({scrollTop: $($(element).attr('href')).get(0).offsetTop});
            }
            return true;
        }
    </script>

    <nav role="navigation">
        <div id="book-search-input" role="search">
            <input type="text" placeholder="Type to search" />
        </div>
        <div id="book-search-input-link" role="search">
            <a href="/assets/search.html">Click to Search</a>
        </div>
        <ul class="summary">
            
                <!-- <p>pages</p> -->
                
                    

                    
                        
                        <li class="chapter" data-level="1.1" data-path="/">
                        
                            <a href="/" onclick="pageScrollToTop(this)">
                                About
                            </a>
                            
                                
                            
                        </li>
                        
                        
                            <li class="divider-header">
                                <a>Basics</a>
                            </li>
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/1/01/">
                        
                            <a href="/pages/1/01/" onclick="pageScrollToTop(this)">
                                Computer Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/1/02/">
                        
                            <a href="/pages/1/02/" onclick="pageScrollToTop(this)">
                                Game Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/1/03/">
                        
                            <a href="/pages/1/03/" onclick="pageScrollToTop(this)">
                                Hacking Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/1/04/">
                        
                            <a href="/pages/1/04/" onclick="pageScrollToTop(this)">
                                Setting Up a VM
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/1/05/">
                        
                            <a href="/pages/1/05/" onclick="pageScrollToTop(this)">
                                Memory Hack
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                            <li class="divider-header">
                                <a>Debugging & Reversing</a>
                            </li>
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/01/">
                        
                            <a href="/pages/2/01/" onclick="pageScrollToTop(this)">
                                Debugging Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/02/">
                        
                            <a href="/pages/2/02/" onclick="pageScrollToTop(this)">
                                Assembly Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/03/">
                        
                            <a href="/pages/2/03/" onclick="pageScrollToTop(this)">
                                Using Breakpoints
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/04/">
                        
                            <a href="/pages/2/04/" onclick="pageScrollToTop(this)">
                                Changing Game Code
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/05/">
                        
                            <a href="/pages/2/05/" onclick="pageScrollToTop(this)">
                                Reversing Code
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/06/">
                        
                            <a href="/pages/2/06/" onclick="pageScrollToTop(this)">
                                Code Caves
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/07/">
                        
                            <a href="/pages/2/07/" onclick="pageScrollToTop(this)">
                                Using Code Caves
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/08/">
                        
                            <a href="/pages/2/08/" onclick="pageScrollToTop(this)">
                                Dynamic Memory Allocation
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/09/">
                        
                            <a href="/pages/2/09/" onclick="pageScrollToTop(this)">
                                Defeating DMA
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                            <li class="divider-header">
                                <a>Programming</a>
                            </li>
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/3/01/">
                        
                            <a href="/pages/3/01/" onclick="pageScrollToTop(this)">
                                Programming Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/3/02/">
                        
                            <a href="/pages/3/02/" onclick="pageScrollToTop(this)">
                                External Memory Hack
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/3/03/">
                        
                            <a href="/pages/3/03/" onclick="pageScrollToTop(this)">
                                DLL Memory Hack
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/3/04/">
                        
                            <a href="/pages/3/04/" onclick="pageScrollToTop(this)">
                                Code Caves &amp; DLL&#39;s
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/3/05/">
                        
                            <a href="/pages/3/05/" onclick="pageScrollToTop(this)">
                                Printing Text
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                            <li class="divider-header">
                                <a>RTS/RPG Hacks</a>
                            </li>
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/4/01/">
                        
                            <a href="/pages/4/01/" onclick="pageScrollToTop(this)">
                                Stathack
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/4/02/">
                        
                            <a href="/pages/4/02/" onclick="pageScrollToTop(this)">
                                Map Hack
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/4/03/">
                        
                            <a href="/pages/4/03/" onclick="pageScrollToTop(this)">
                                Macro Bot
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/4/04/">
                        
                            <a href="/pages/4/04/" onclick="pageScrollToTop(this)">
                                Farming Bot
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                            <li class="divider-header">
                                <a>FPS Hacks</a>
                            </li>
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/01/">
                        
                            <a href="/pages/5/01/" onclick="pageScrollToTop(this)">
                                3D Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/02/">
                        
                            <a href="/pages/5/02/" onclick="pageScrollToTop(this)">
                                Wallhack (Memory)
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter active" data-level="1.2" data-path="/pages/5/03/">
                        
                            <a href="/pages/5/03/" onclick="pageScrollToTop(this)">
                                Wallhack (OpenGL)
                            </a>
                            
                                
                                    <ul><li><a href="#target" onclick="mobilePageScrollToAnchor(this)" >Target</a></li><li><a href="#overview" onclick="mobilePageScrollToAnchor(this)" >Overview</a></li><li><a href="#identify" onclick="mobilePageScrollToAnchor(this)" >Identify</a></li><li><a href="#understand" onclick="mobilePageScrollToAnchor(this)" >Understand</a></li><li><a href="#locating-drawing-library" onclick="mobilePageScrollToAnchor(this)" >Locating Drawing Library</a></li><li><a href="#locating-the-drawing-function" onclick="mobilePageScrollToAnchor(this)" >Locating the Drawing Function</a></li><li><a href="#hooking-gldrawelements" onclick="mobilePageScrollToAnchor(this)" >Hooking glDrawElements</a></li><li><a href="#function-pointers" onclick="mobilePageScrollToAnchor(this)" >Function Pointers</a></li><li><a href="#gldrawelements-code-cave" onclick="mobilePageScrollToAnchor(this)" >glDrawElements Code Cave</a></li><li><a href="#calling-conventions" onclick="mobilePageScrollToAnchor(this)" >Calling Conventions</a></li><li><a href="#checking-counts" onclick="mobilePageScrollToAnchor(this)" >Checking Counts</a></li><li><a href="#clipping-planes" onclick="mobilePageScrollToAnchor(this)" >Clipping Planes</a></li></ul>

                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/04/">
                        
                            <a href="/pages/5/04/" onclick="pageScrollToTop(this)">
                                Chams (OpenGL)
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/05/">
                        
                            <a href="/pages/5/05/" onclick="pageScrollToTop(this)">
                                Triggerbot
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/06/">
                        
                            <a href="/pages/5/06/" onclick="pageScrollToTop(this)">
                                Aimbot
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/07/">
                        
                            <a href="/pages/5/07/" onclick="pageScrollToTop(this)">
                                No Recoil
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/08/">
                        
                            <a href="/pages/5/08/" onclick="pageScrollToTop(this)">
                                Radar Hack
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/09/">
                        
                            <a href="/pages/5/09/" onclick="pageScrollToTop(this)">
                                ESP
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/10/">
                        
                            <a href="/pages/5/10/" onclick="pageScrollToTop(this)">
                                Multihack
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                            <li class="divider-header">
                                <a>Multiplayer</a>
                            </li>
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/6/01/">
                        
                            <a href="/pages/6/01/" onclick="pageScrollToTop(this)">
                                Multiplayer Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/6/02/">
                        
                            <a href="/pages/6/02/" onclick="pageScrollToTop(this)">
                                Packet Analysis
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/6/03/">
                        
                            <a href="/pages/6/03/" onclick="pageScrollToTop(this)">
                                Reversing Packets
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/6/04/">
                        
                            <a href="/pages/6/04/" onclick="pageScrollToTop(this)">
                                Creating an External Client
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/6/05/">
                        
                            <a href="/pages/6/05/" onclick="pageScrollToTop(this)">
                                Proxying TCP Traffic
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                            <li class="divider-header">
                                <a>Tool Development</a>
                            </li>
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/7/01/">
                        
                            <a href="/pages/7/01/" onclick="pageScrollToTop(this)">
                                DLL Injector
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/7/02/">
                        
                            <a href="/pages/7/02/" onclick="pageScrollToTop(this)">
                                Pattern Scanner
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/7/03/">
                        
                            <a href="/pages/7/03/" onclick="pageScrollToTop(this)">
                                Memory Scanner
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/7/04/">
                        
                            <a href="/pages/7/04/" onclick="pageScrollToTop(this)">
                                Disassembler
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/7/05/">
                        
                            <a href="/pages/7/05/" onclick="pageScrollToTop(this)">
                                Debugger
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/7/06/">
                        
                            <a href="/pages/7/06/" onclick="pageScrollToTop(this)">
                                Call Logger
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                            <li class="divider-header">
                                <a>Game Resources</a>
                            </li>
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/8/01/">
                        
                            <a href="/pages/8/01/" onclick="pageScrollToTop(this)">
                                Resource Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/8/02/">
                        
                            <a href="/pages/8/02/" onclick="pageScrollToTop(this)">
                                Modifying Save Data
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/8/03/">
                        
                            <a href="/pages/8/03/" onclick="pageScrollToTop(this)">
                                Modifying Textures
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/8/04/">
                        
                            <a href="/pages/8/04/" onclick="pageScrollToTop(this)">
                                Modifying Units
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                
            
                <!-- <p>posts</p> -->
                
                    

                    
                
            
        </ul>

        &nbsp;
    </nav>
</div>
<div class="book-body">
        <div class="book-header" role="navigation">
          <!-- Title -->
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i>
            
            <a href=".">Wallhack (OpenGL)</a>
            
          </h1>
        </div>

        <div class="body-inner"><div class="page-wrapper" tabindex="-1" role="main">
    

    <div class="page-inner">
        <div id="book-search-results">
            <div class="search-noresults">
                <section class="normal markdown-section">
                    

                    <h1 id="target">Target</h1>

<p>Our target for this lesson will be Urban Terror 4.3.4.</p>

<h1 id="overview">Overview</h1>

<p>Most games make use of external graphics libraries for rendering. The two
most popular graphics libraries are DirectX and OpenGL. Both of these
libraries are loaded by games dynamically. Once they are loaded, games
then invoke functions in these libraries. For example, with OpenGL, games
can make use of the <strong>glDrawElements</strong> function to draw a
series of elements from data stored in an array. Since these libraries are
external, the game’s developers do not need to implement the rendering
logic themselves.</p>

<h1 id="identify">Identify</h1>

<p>Our goal in this lesson is to create a wallhack by hooking the game’s
graphics library and modifying its logic to display entities through
walls.</p>

<h1 id="understand">Understand</h1>

<p>DirectX and OpenGL each have different functions for rendering that
require different approaches to hook. Our first goal is to identify the
library that the game is using. As each library has several functions to
handle rendering and shading, we will then need to find a function that is
used by the game for rendering. With the function identified, we can then
hook it and disable depth testing through the use of a code cave. This
will cause all entities to be rendered regardless of where they are in the
3D world.</p>

<h1 id="locating-drawing-library">Locating Drawing Library</h1>

<p>Since graphics libraries are loaded dynamically, they must expose their
functions to the main executable. Most debuggers allow you to view all the
libraries loaded into an executable when attached. In x64dbg, this
information is collected under the <em>Symbols</em> tab.</p>

<p><img src="/assets/images/5/3/urbanterror1.png" alt="Urban Terror Symbols" /></p>

<p>As we can see in the highlighted elements, <em>opengl32.dll</em> is being
loaded into the game’s process. By selecting the OpenGL module, we can see
that it exports many drawing-related functions. From this information, we
can conclude that this game is using OpenGL to render its graphics.</p>

<h1 id="locating-the-drawing-function">Locating the Drawing Function</h1>

<p>OpenGL has several rendering approaches, and different games will use
different approaches. For example, older games may use
<strong>glBegin</strong>, <strong>glVertex</strong>, and
<strong>glEnd</strong>; some games may use <strong>glDrawArrays</strong>;
and others may use <strong>glDrawElements</strong>. Some even use a
combination of these approaches to render different aspects, such as
<strong>glDrawElements</strong> for player models and
<strong>glBegin</strong> for screen effects like blood.</p>

<p>Typically, modern games will not use <strong>glBegin</strong>,
<strong>glVertex</strong>, and <strong>glEnd</strong>, as these functions
are considered deprecated. For that reason, we won’t be focusing on those
functions right now. Instead, we will first investigate
<strong>glDrawElements</strong>, as this is a commonly used function. Due
to how OpenGL works, we will expect this function to be called constantly
if it is used by the game.</p>

<p>By scrolling down to the <strong>glDrawElements</strong> export in the
<em>Symbols</em> tab, we can see that OpenGL exports it to the process,
though this is not a guarantee that it is being used:</p>

<p><img src="/assets/images/5/3/urbanterror2.png" alt="Urban Terror Symbols" /></p>

<p>By double-clicking on the export entry, x64dbg will display the function:</p>

<p><img src="/assets/images/5/3/urbanterror3.png" alt="Urban Terror glDrawElements" /></p>

<p>Next, we can start a game and set a breakpoint on
<strong>glDrawElements</strong>. You will notice that it will immediately
pop, and pop continuously every time the game is resumed. This is a good
indication that this function is responsible for rendering entities. To
verify that this is the case, we can replace the first instruction with
the <strong>ret</strong> statement we see at the end of the function. The
effect of this will be to immediately return to the calling code without
executing any of the <strong>glDrawElements</strong> logic:</p>

<p><img src="/assets/images/5/3/urbanterror4.png" alt="Urban Terror glDrawElements" /></p>

<p>If you then resume execution and attempt to play the game, you will notice
that no new entities are being rendered to the screen:</p>

<p><img src="/assets/images/5/3/urbanterror5.png" alt="Urban Terror glDrawElements" /></p>

<p>This gives us strong proof that Urban Terror is using
<strong>glDrawElements</strong>. to display entities.</p>

<h1 id="hooking-gldrawelements">Hooking glDrawElements</h1>

<p>Examining the <strong>glDrawElements</strong> function, we can see that it
has very few instructions. Given the complexity of rendering entities to a
screen, the majority of the code must be contained in the two calls near
the end of the function:</p>

<p><img src="/assets/images/5/3/urbanterror6.png" alt="Urban Terror glDrawElements" /></p>

<p>Therefore, if we hook an instruction before these calls, we should be able
to accomplish our goal of disabling depth testing. A good candidate
instruction is the <strong>mov</strong> at <code class="language-plaintext highlighter-rouge">0x61B9C526</code>.</p>

<p>Since OpenGL is loaded dynamically, our hooking approach will have to be
slightly different. First, we will need to ensure that OpenGL is actually
loaded. As we are injecting our DLL into the application when it is first
started, this will not be the case. After we ensure that OpenGL is loaded,
we need to figure out where it is loaded. Once we determine the base
address of OpenGL, we can then determine where
<strong>glDrawElements</strong> is located inside the OpenGL module.</p>

<p>We will use a combination of techniques that we explored in previous
lessons. To address the issue that OpenGL will not be loaded when our DLL
is injected, we will create a thread to handle the hooking logic. This
will allow us to create an infinite loop that waits until OpenGL is
loaded, similar to the thread we saw in the <a href="/pages/3/03/">DLL Memory Hack</a> lesson:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">fdwReason</span> <span class="o">==</span> <span class="n">DLL_PROCESS_ATTACH</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">CreateThread</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPTHREAD_START_ROUTINE</span><span class="p">)</span><span class="n">injected_thread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In our thread, we will create an infinite loop that will call <a href="https://docs.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-getmodulehandlea">GetModuleHandle.</a> This API returns the module handle, or base address, for a loaded module.
If the module is not loaded, it will return <strong>NULL</strong>:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">HMODULE</span> <span class="n">openGLHandle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">injected_thread</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">openGLHandle</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">openGLHandle</span> <span class="o">=</span> <span class="n">GetModuleHandle</span><span class="p">(</span><span class="s">L"opengl32.dll"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="p">...</span> 
    <span class="n">Sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</code></pre></div></div>

<p>When we have the base address of OpenGL, we can then find where
<strong>glDrawElements</strong> is located. To do this, we will make use
of the <a href="https://docs.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress">GetProcAddress</a> API. When given a module and the name of a function, this API returns the
address of the function:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">hook_location</span><span class="p">;</span>
<span class="p">...</span>
<span class="k">if</span> <span class="p">(</span><span class="n">openGLHandle</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">hook_location</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">openGLHandle</span><span class="p">,</span> <span class="s">"glDrawElements"</span><span class="p">);</span>
</code></pre></div></div>

<p>This API will return the location of the first instruction in the
function, in this case <strong>nop</strong>. Since we want to hook the
<strong>mov</strong> instruction, we can subtract its distance from the
first instruction and then add that difference to the result of
<strong>GetProcAddress</strong>. The distance between these two
instructions will always be the same, as they are part of the library’s
code and not loaded dynamically.</p>

<p><img src="/assets/images/5/3/urbanterror7.png" alt="Urban Terror glDrawElements" /></p>

<p>This offset can be added directly to the
<strong>hook_location</strong> variable to get our location:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">hook_location</span> <span class="o">+=</span> <span class="mh">0x16</span><span class="p">;</span>
</code></pre></div></div>

<p>Finally, we can hook the code as we have done in previous lessons:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">VirtualProtect</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">hook_location</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_protect</span><span class="p">);</span>
<span class="o">*</span><span class="n">hook_location</span> <span class="o">=</span> <span class="mh">0xE9</span><span class="p">;</span>
<span class="o">*</span><span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(</span><span class="n">hook_location</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="o">&amp;</span><span class="n">codecave</span> <span class="o">-</span> <span class="p">((</span><span class="n">DWORD</span><span class="p">)</span><span class="n">hook_location</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
<span class="o">*</span><span class="p">(</span><span class="n">hook_location</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x90</span><span class="p">;</span>
</code></pre></div></div>

<h1 id="function-pointers">Function Pointers</h1>

<p>With <strong>glDrawElements</strong> hooked, we can start working on the
code cave. Our goal is to disable depth testing when an element is being
drawn. To do this, we can use an OpenGL function called <a href="https://www.khronos.org/registry/OpenGL-Refpages/gl4/html/glDepthFunc.xhtml">glDepthFunc.</a> <strong>glDepthFunc</strong> allows you to set the function used for depth
comparisons when OpenGL attempts to render the screen. This can be several
values, but the ones we are interested in are
<strong>GL_LEQUAL</strong> (draw if the element is in front of another
element) and <strong>GL_ALWAYS</strong> (always draw).</p>

<p>For our wallhack, we will set the depth function to
<strong>GL_ALWAYS</strong> right before any element is drawn. This will
have the effect of making all elements always appear, regardless of where
they actually are in the 3D space.</p>

<p>To start, we will need to locate <strong>glDepthFunc</strong>. We can use
<strong>GetProcAddress</strong> in a similar manner to
<strong>glDrawElements</strong>. However, instead of finding an address to
hook, our goal with this call to <strong>GetProcAddress</strong> is to
store the function’s address in a way that we can then invoke in our code
cave. The easiest way to do this is through a function pointer.</p>

<p>Just like pointers we have used in previous lessons, function pointers point
to an address. However, unlike the pointers we have been using to modify
data and code, we can also declare a pointer to point to a function. We
can then call this function, or address, like we would call any other C++
function.</p>

<p>To declare a function pointer, we need to know the original function’s
definition. The definition of a function includes its return type and its
parameters. We can get this information from the <a href="https://www.khronos.org/opengl/">Khronos Group</a> site:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">glDepthFunc</span><span class="p">(</span><span class="n">GLenum</span> <span class="n">func</span><span class="p">);</span>
</code></pre></div></div>

<p>Looking at the <a href="https://www.khronos.org/registry/OpenGL/api/GLES/1.0/gl.h">gl.h header file</a> header file, we can find out what <strong>GLenum</strong> is:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">GLenum</span><span class="p">;</span>
</code></pre></div></div>

<p>So far, we can define our <strong>glDepthFunc</strong> function like so:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">glDepthFunc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</code></pre></div></div>

<p>Next, we will modify this declaration to have it act as a pointer to this
function:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">glDepthFunc</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</code></pre></div></div>

<p>We can now assign this to the result of <strong>GetProcAddress</strong>:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">glDepthFunc</span> <span class="o">=</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">openGLHandle</span><span class="p">,</span> <span class="s">"glDepthFunc"</span><span class="p">);</span>
</code></pre></div></div>

<p>However, if we try to build this, we will get the following error:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">error</span> <span class="n">C2440</span><span class="o">:</span> <span class="sc">'='</span><span class="o">:</span> <span class="n">cannot</span> <span class="n">convert</span> <span class="n">from</span> <span class="err">'</span><span class="n">FARPROC</span><span class="err">'</span> <span class="n">to</span> <span class="err">'</span><span class="kt">void</span> <span class="p">(</span><span class="kr">__cdecl</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="err">'</span>
<span class="n">message</span> <span class="o">:</span> <span class="n">This</span> <span class="n">conversion</span> <span class="k">requires</span> <span class="n">a</span> <span class="k">reinterpret_cast</span><span class="p">,</span> <span class="n">a</span> <span class="n">C</span><span class="o">-</span><span class="n">style</span> <span class="n">cast</span> <span class="n">or</span> <span class="n">function</span><span class="o">-</span><span class="n">style</span> <span class="n">cast</span>
</code></pre></div></div>

<p>Like we have seen in previous lessons, we need to cast the result of
<strong>GetProcAddress</strong> properly for the compiler to understand
how to translate the result. We can use the error message to quickly
figure out how we need to cast the result:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">glDepthFunc</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="p">(</span><span class="kr">__cdecl</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">))(</span><span class="n">openGLHandle</span><span class="p">,</span> <span class="s">"glDepthFunc"</span><span class="p">);</span>
</code></pre></div></div>

<h1 id="gldrawelements-code-cave">glDrawElements Code Cave</h1>

<p>Our code cave will be similar to code caves we have written previously. We
will start with our skeleton and restore the original code:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DWORD</span> <span class="n">ret_address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="kr">__declspec</span><span class="p">(</span><span class="kr">naked</span><span class="p">)</span> <span class="kt">void</span> <span class="nf">codecave</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">__asm</span> <span class="p">{</span>
    <span class="n">pushad</span>
  <span class="p">}</span>
  <span class="p">...</span>
  <span class="kr">__asm</span> <span class="p">{</span>
    <span class="n">popad</span>
    <span class="n">mov</span> <span class="n">esi</span><span class="p">,</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="n">ds</span> <span class="o">:</span> <span class="p">[</span><span class="n">esi</span> <span class="o">+</span> <span class="mh">0xA18</span><span class="p">]</span>
    <span class="n">jmp</span> <span class="n">ret_address</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>Unlike previous lessons, we do not have a static location to jump to.
Instead, we will need to calculate our return location similarly to how to
we calculated the hook location. In our thread, after we assign the hook
location, we can also dynamically assign the return location:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ret_address</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)(</span><span class="n">hook_location</span> <span class="o">+</span> <span class="mh">0x6</span><span class="p">);</span>
</code></pre></div></div>

<p>With our skeleton in place, we can now add in our call to
<strong>glDepthFunc</strong>. First, we need to find the value for
<strong>GL_ALWAYS</strong>. We can find this in the <a href="https://www.khronos.org/registry/OpenGL/api/GLES/1.0/gl.h">gl.h header file</a>:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define GL_ALWAYS 0x0207
</span></code></pre></div></div>

<p>Next, we can invoke <strong>glDepthFunc</strong> to disable depth testing.
Since it is a function pointer, we need to dereference the pointer to
invoke the function:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="o">*</span><span class="n">glDepthFunc</span><span class="p">)(</span><span class="mh">0x207</span><span class="p">);</span>
</code></pre></div></div>

<p>Our code looks like:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;Windows.h&gt;</span><span class="cp">
</span>
<span class="n">HMODULE</span> <span class="n">openGLHandle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">glDepthFunc</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">hook_location</span><span class="p">;</span>

<span class="n">DWORD</span> <span class="n">ret_address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">DWORD</span> <span class="n">old_protect</span><span class="p">;</span>

<span class="kr">__declspec</span><span class="p">(</span><span class="kr">naked</span><span class="p">)</span> <span class="kt">void</span> <span class="nf">codecave</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">__asm</span> <span class="p">{</span>
    <span class="n">pushad</span>
  <span class="p">}</span>

  <span class="p">(</span><span class="o">*</span><span class="n">glDepthFunc</span><span class="p">)(</span><span class="mh">0x207</span><span class="p">);</span>

  <span class="kr">__asm</span> <span class="p">{</span>
    <span class="n">popad</span>
    <span class="n">mov</span> <span class="n">esi</span><span class="p">,</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="n">ds</span><span class="o">:</span><span class="p">[</span><span class="n">esi</span><span class="o">+</span><span class="mh">0xA18</span><span class="p">]</span>
    <span class="n">jmp</span> <span class="n">ret_address</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">injected_thread</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">openGLHandle</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">openGLHandle</span> <span class="o">=</span> <span class="n">GetModuleHandle</span><span class="p">(</span><span class="s">L"opengl32.dll"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">openGLHandle</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">glDepthFunc</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="p">(</span><span class="kr">__cdecl</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">))</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">openGLHandle</span><span class="p">,</span> <span class="s">"glDepthFunc"</span><span class="p">);</span>

      <span class="n">hook_location</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">openGLHandle</span><span class="p">,</span> <span class="s">"glDrawElements"</span><span class="p">);</span>
      <span class="n">hook_location</span> <span class="o">+=</span> <span class="mh">0x16</span><span class="p">;</span>

      <span class="n">VirtualProtect</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">hook_location</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_protect</span><span class="p">);</span>
      <span class="o">*</span><span class="n">hook_location</span> <span class="o">=</span> <span class="mh">0xE9</span><span class="p">;</span>
      <span class="o">*</span><span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(</span><span class="n">hook_location</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="o">&amp;</span><span class="n">codecave</span> <span class="o">-</span> <span class="p">((</span><span class="n">DWORD</span><span class="p">)</span><span class="n">hook_location</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
      <span class="o">*</span><span class="p">(</span><span class="n">hook_location</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x90</span><span class="p">;</span>

      <span class="n">ret_address</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)(</span><span class="n">hook_location</span> <span class="o">+</span> <span class="mh">0x6</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">Sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">BOOL</span> <span class="n">WINAPI</span> <span class="nf">DllMain</span><span class="p">(</span><span class="n">HINSTANCE</span> <span class="n">hinstDLL</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">fdwReason</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">lpvReserved</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fdwReason</span> <span class="o">==</span> <span class="n">DLL_PROCESS_ATTACH</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">CreateThread</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPTHREAD_START_ROUTINE</span><span class="p">)</span><span class="n">injected_thread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We can now build this code and inject it into Urban Terror to see if it
works.</p>

<h1 id="calling-conventions">Calling Conventions</h1>

<p>When our DLL is injected, you will notice that the game will crash
instantly when starting with the following error:</p>

<p><img src="/assets/images/5/3/urbanterror8.png" alt="Urban Terror glDrawElements Hook Error" /></p>

<p>If we remove the call to <strong>glDepthFunc</strong> in our code cave,
the game no longer crashes. It looks like our function pointer is not
correct in some way. If we look at gl.h, we see that
<strong>glDepthFunc</strong> is defined as:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">GLAPI</span> <span class="kt">void</span> <span class="n">APIENTRY</span> <span class="nf">glDepthFunc</span> <span class="p">(</span><span class="n">GLenum</span> <span class="n">func</span><span class="p">);</span>
</code></pre></div></div>

<p>In Microsoft’s documentation on <a href="https://docs.microsoft.com/en-us/windows/win32/winprog/windows-data-types">data types,</a> we see that <strong>APIENTRY</strong> is a reference for
<strong>WINAPI</strong>. If we look at the entry for
<strong>WINAPI</strong>, we see that it is a reference for
<strong>__stdcall</strong>. Let’s try adding this prefix to our function
pointer:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="p">(</span><span class="kr">__stdcall</span> <span class="o">*</span><span class="n">glDepthFunc</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</code></pre></div></div>

<p>Building this code results in a familiar error:</p>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">error</span> <span class="n">C2440</span><span class="o">:</span> <span class="sc">'='</span><span class="o">:</span> <span class="n">cannot</span> <span class="n">convert</span> <span class="n">from</span> <span class="err">'</span><span class="kt">void</span> <span class="p">(</span><span class="kr">__cdecl</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="err">'</span> <span class="n">to</span> <span class="err">'</span><span class="kt">void</span> <span class="p">(</span><span class="kr">__stdcall</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="err">'</span>
</code></pre></div></div>

<p>This can be fixed by changing the cast as we did before:</p>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">glDepthFunc</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="p">(</span><span class="kr">__stdcall</span><span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">))</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">openGLHandle</span><span class="p">,</span> <span class="s">"glDepthFunc"</span><span class="p">);</span>
</code></pre></div></div>

<p>Calling conventions control how parameters are handled by functions when
called. There are many different types, but for our purposes, we just need
to know that Visual Studio uses <strong>__cdecl</strong> by default,
whereas OpenGL defaults to <strong>__stdcall</strong>.</p>

<p>With this change, build the code and inject it again. You will notice that
Urban Terror no longer crashes.</p>

<h1 id="checking-counts">Checking Counts</h1>

<p>If you join a game, you will notice that you are now able to see entities
through walls. The only problem is that you can see too many things:</p>

<p><img src="/assets/images/5/3/urbanterror9.png" alt="Urban Terror Wallhack" /></p>

<p>In our current hack, we are disabling depth testing for every element
drawn on the screen, including walls and stairs. Ideally, we only want to
draw players through walls. To accomplish this, we will have to filter out
elements that we do not care about.</p>

<p><strong>glDrawElements</strong> has the following <a href="https://www.khronos.org/registry/OpenGL-Refpages/gl4/html/glDrawElements.xhtml">definition</a>:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">glDrawElements</span><span class="p">(</span>    <span class="n">GLenum</span> <span class="n">mode</span><span class="p">,</span>
              <span class="n">GLsizei</span> <span class="n">count</span><span class="p">,</span>
              <span class="n">GLenum</span> <span class="n">type</span><span class="p">,</span>
              <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span> <span class="n">indices</span><span class="p">);</span>
</code></pre></div></div>

<p>The <strong>count</strong> parameter specifies the amount of elements, or
vertices, to be rendered. More detailed objects will have a higher amount
of vertices. For example, a player model will have more detail (nose,
hands, fingers, etc.) than a floor. By ensuring that the
<strong>count</strong> parameter is a certain value, we can filter out
elements that we do not want to display through walls.</p>

<p>We know that this parameter will be on the stack when our hook is jumped
to. To retrieve its exact location, we can inject our DLL and set a
breakpoint on <strong>glDrawElements</strong>. As we step through the
code, we can identify where it is on the stack at the time our code cave
gets called.</p>

<p>One feature of x64dbg is the ability to view the current parameters on the
stack in a similar manner to how they would be passed in C. This feature
is under the panel showing the values of the registers:</p>

<p><img src="/assets/images/5/3/urbanterror10.png" alt="Stack Parameters" /></p>

<p>x64dbg is not able to fill this in automatically, so you will need to set
the calling conventions and the number of parameters. If we trigger our
breakpoint on <strong>glDrawElements</strong> multiple times, we can see
that <strong>[esp+8]</strong> is the only value that appears to change. We
can assume that it holds the value for the count parameter at the start of
the function:</p>

<p><img src="/assets/images/5/3/urbanterror11.png" alt="Stack Parameters" /></p>

<p>If we look at the stack panel at the bottom right, we can see how this
information is represented on the stack. By default, the top of the stack
(<strong>esp</strong>) will always appear at the top of the window:</p>

<p><img src="/assets/images/5/3/urbanterror12.png" alt="Stack Parameters" /></p>

<p>Continue stepping through the function and then step into the jump to our
code cave. After the <strong>pushad</strong> instruction in our code cave,
examine the stack again:</p>

<p><img src="/assets/images/5/3/urbanterror13.png" alt="Stack Parameters" /></p>

<p>At this point, we can see that the <strong>count</strong> parameter is at
<strong>esp+0x10</strong>. We can reference this value in our code cave to
retrieve the current count value of the element being rendered. In the
first <strong>asm</strong> block, after the
<strong>pushad</strong> instruction, we can take the value of
<strong>esp+0x10</strong> and store it in a local variable:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DWORD</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">...</span>
<span class="kr">__asm</span> <span class="p">{</span>
  <span class="n">pushad</span>
  <span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="n">ds</span> <span class="o">:</span> <span class="p">[</span><span class="n">esp</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">]</span>
  <span class="n">mov</span> <span class="n">count</span><span class="p">,</span> <span class="n">eax</span>
  <span class="n">popad</span>
  <span class="n">pushad</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We now have a local variable <strong>count</strong> that will hold the
value of count passed to <strong>glDrawElements</strong>. We can then
compare this value to a baseline and only disable depth testing if we
exceed that baseline. If we don’t exceed it, we will re-enable depth
testing. The value for <strong>GL_LEQUAL</strong> (<code class="language-plaintext highlighter-rouge">0x203</code>) can
be found in the same way that we found the value for
<strong>GL_ALWAYS</strong>. For now, we will use 500 as a baseline value:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">(</span><span class="o">*</span><span class="n">glDepthFunc</span><span class="p">)(</span><span class="mh">0x207</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">else</span> <span class="p">{</span>
  <span class="p">(</span><span class="o">*</span><span class="n">glDepthFunc</span><span class="p">)(</span><span class="mh">0x203</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>If we build and inject this, we can see that our view is much cleaner now,
and only certain elements appear through walls:</p>

<p><img src="/assets/images/5/3/urbanterror14.png" alt="Urban Terror Wallhack with Count Filtering" /></p>

<h1 id="clipping-planes">Clipping Planes</h1>

<p>Now we are filtering many elements, but we’ve encountered the problem that
no player models are appearing. Instead, we can only see their weapons and
blood effects through walls:</p>

<p><img src="/assets/images/5/3/urbanterror15.png" alt="Urban Terror Wallhack with Count Filtering" /></p>

<p>If we enable third-person view, our player model is also invisible. The
only place our player model will appear is if we turn on no-clip and fly
out-of-bounds. This is most likely due to our player model being drawn
first, when the scene is being rendered, and then other elements of the
level drawn on top of it. When we disable depth testing, these entities
are all drawn on top of the player.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">draw_player</span><span class="p">();</span>
<span class="n">draw_guns</span><span class="p">();</span>
<span class="n">draw_doors</span><span class="p">();</span>
<span class="n">draw_level_walls</span><span class="p">();</span>
</code></pre></div></div>

<p>To force players to be drawn above these elements, we can use the <a href="https://www.khronos.org/registry/OpenGL-Refpages/gl4/html/glDepthRange.xhtml">glDepthRange</a> function. This function sets the near and far clipping planes for the
scene. Clipping planes are planes that extend across the game scene and
clip (or remove) any entities behind them. By setting these values to be
equal to 0, the planes will intersect, causing all elements to be drawn on
the same plane and “fight” for rendering space. This will result in some
flickering, but the player models will appear through walls.</p>

<p>We can create a function pointer for this function identically to the
approach we used for <strong>glDepthFunc</strong>. The only alterations we
need to make are in the parameters:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="p">(</span><span class="kr">__stdcall</span><span class="o">*</span> <span class="n">glDepthRange</span><span class="p">)(</span><span class="kt">double</span><span class="p">,</span> <span class="kt">double</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">...</span> 
<span class="n">glDepthRange</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="p">(</span><span class="kr">__stdcall</span><span class="o">*</span><span class="p">)(</span><span class="kt">double</span><span class="p">,</span> <span class="kt">double</span><span class="p">))</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">openGLHandle</span><span class="p">,</span> <span class="s">"glDepthRange"</span><span class="p">);</span>
</code></pre></div></div>

<p>We can then call this function in the same location that we change the
depth function. The default values for these planes are (0,1), which we
will reset if the count is too low.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">(</span><span class="o">*</span><span class="n">glDepthRange</span><span class="p">)(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
  <span class="p">(</span><span class="o">*</span><span class="n">glDepthFunc</span><span class="p">)(</span><span class="mh">0x207</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">else</span> <span class="p">{</span>
  <span class="p">(</span><span class="o">*</span><span class="n">glDepthRange</span><span class="p">)(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
  <span class="p">(</span><span class="o">*</span><span class="n">glDepthFunc</span><span class="p">)(</span><span class="mh">0x203</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>With this, player models will now appear through walls, indicating that
our wallhack is successful:</p>

<p><img src="/assets/images/5/3/urbanterror16.png" alt="Urban Terror Wallhack with Count Filtering" /></p>

<p>The full code for this lesson is available on <a href="https://github.com/GameHackingAcademy/UrbanTerror_OpenGLWallhack/">github.</a></p>

<p> </p>


                </section>
            </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div></div>
    </div>
</div>

<!-- introduce mathjax support -->
<script>
window.MathJax = {
  tex: {
    inlineMath: [ ['$', '$'], ['\\(', '\\)'] ]
  },
  svg: {
    fontCache: 'global'
  }
};
</script>
<script
  type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
</script>


<!-- introduce per-page mermaid support -->


          <a
            href="/pages/5/02/"
            class="navigation navigation-prev navigation-unique"
            aria-label="Previous page: Wallhack (Memory)"
          >
            <i class="fa fa-angle-left"></i>
          </a>
           
          <a
            href="/pages/5/04/"
            class="navigation navigation-next navigation-unique"
            aria-label="Next page: Chams (OpenGL)"
          >
            <i class="fa fa-angle-right"></i>
          </a>
          
        </div>
      </div>

      <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({
    "page": {
        "title": "Introduction",
        "level": "1.1",
        "depth": 1,
        
        "next": {
            "title": "Chams (OpenGL)",
            "level": "1.2",
            "depth": 1,
            "path": "_pages/5/04.md",
            "ref": "_pages/5/04.md",
            "articles": []
        },
        
        "dir": "ltr"
    },    "config": {
        "plugins": ["fontsettings", "highlight", "livereload", "lunr", "search", "sharing", "theme-default", "livereload"],
        "styles": {
            "ebook": "styles/ebook.css",
            "epub": "styles/epub.css",
            "mobi": "styles/mobi.css",
            "pdf": "styles/pdf.css",
            "print": "styles/print.css",
            "website": "styles/website.css"
        },
        "pluginsConfig": {
            "fontsettings": {
                "family": "sans",
                "size": 2,
                "theme": "white"
            },
            "highlight": {},
            "livereload": {},
            "lunr": {
                "ignoreSpecialCharacters": false,
                "maxIndexSize": 1000000
            },
            "search": {},            "sharing": {
                "facebook": false,

                "google": false,

                "github": true,
                "github_link": "https://github.com/GameHackingAcademy",

                "telegram": false,
                "telegram_link": "https://t.me",

                "instapaper": false,

                "twitter": true,
                "twitter_link": "https://twitter.com/GameHackingAcad",

                "vk": false,

                "weibo": false
            },
"theme-default": {
                "showLevel": false,
                "styles": {
                    "ebook": "styles/ebook.css",
                    "epub": "styles/epub.css",
                    "mobi": "styles/mobi.css",
                    "pdf": "styles/pdf.css",
                    "print": "styles/print.css",
                    "website": "styles/website.css"
                }
            }
        },
        "theme": "default",
        "author": "Tao He",
        "pdf": {
            "pageNumbers": true,
            "fontSize": 12,
            "fontFamily": "Arial",
            "paperSize": "a4",
            "chapterMark": "pagebreak",
            "pageBreaksBefore": "/",
            "margin": {
                "right": 62,
                "left": 62,
                "top": 56,
                "bottom": 56
            }
        },
        "structure": {
            "langs": "LANGS.md",
            "readme": "README.md",
        },
        "variables": {},
        "title": "Game Hacking Academy",
        "language": "en",
        "gitbook": "*"
    },
    "file": {
        "path": "_pages/5/03.md",
        "mtime": "2023-12-25 00:00:00 -0600",
        "type": "markdown"
    },
    "gitbook": {
        "version": "3.2.3",
        "time": "2023-12-31 12:09:34 -0600"
    },
    "basePath": "",
    "book": {
        "language": ""
    }
});
        });
      </script>
    </div><script src="/assets/gitbook/gitbook.js"></script>
<script src="/assets/gitbook/theme.js"></script>

<script src="/assets/gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
<script src="/assets/gitbook/gitbook-plugin-sharing/buttons.js"></script>

<!-- <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
<script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
<script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
<script src="../gitbook/gitbook-plugin-search/search.js"></script> -->

<script src="/assets/gitbook/gitbook-plugin-search-pro/jquery.mark.min.js"></script>
<script src="/assets/gitbook/gitbook-plugin-search-pro/search.js"></script>
<script src="/assets/gitbook/gitbook-plugin-back-to-top-button/plugin.js"></script>
<script src="/assets/gitbook/gitbook-plugin-copy-code-button/toggle.js"></script>

<!-- trackers --><!-- google analytics --><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-160704775-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-160704775-1');
</script>
<script>
      particlesJS("particles-js", {
        particles: {
          number: {
            value: 20,
            density: {
              enable: true,
              value_area: 100,
            },
          },
          color: {
            value: "#6195b9",
          },
          shape: {
            type: "edge",
          },
          opacity: {
            value: 0.3,
            anim: {
              enable: true,
              speed: 0.1,
              opacity_min: 0,
              sync: false,
            },
          },
          size: {
            value: 15,
            random: true,
          },
          line_linked: {
            enable: false,
          },
          move: {
            enable: true,
            speed: 0.5,
            direction: "top",
            random: true,
            straight: true,
            out_mode: "out",
            bounce: false,
            attract: {
              enable: false,
            },
          },
        },
        interactivity: {
          detect_on: "canvas",
          events: {
            onhover: {
              enable: false,
            },
            onclick: {
              enable: false,
            },
            resize: true,
          },
        },
      });
    </script>
  </body>
</html>

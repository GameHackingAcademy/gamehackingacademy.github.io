<!DOCTYPE html>
<html lang="en">
  <head><meta charset="UTF-8">
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"><title>Multihack · Game Hacking Academy</title><meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="description" content="Game hacking tutorials and lessons.
"><meta name="generator" content="Jekyll (using style of GitBook 3.2.3)"><meta name="author" content="attilathedud"><link rel="stylesheet" href="/assets/gitbook/style.css">
<link rel="stylesheet" href="/assets/gitbook/gitbook-plugin-fontsettings/website.css">
<link rel="stylesheet" href="/assets/gitbook/gitbook-plugin-search-pro/search.css">
<link rel="stylesheet" href="/assets/gitbook/gitbook-plugin-back-to-top-button/plugin.css">

<link rel="stylesheet" href="/assets/gitbook/rouge/base16.css">

<link rel="stylesheet" href="/assets/gitbook/custom.css">
<link rel="stylesheet" href="/assets/gitbook/custom-local.css">

<meta name="HandheldFriendly" content="true"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="/assets/gitbook/images/apple-touch-icon-precomposed-152.png">
<link rel="shortcut icon" href="/assets/images/favicon.ico" type="image/x-icon">

<script src="/assets/particles.min.js"></script>

<style>
    @media screen and (min-width: 1101px) {
      .eyecandy {
        position: fixed;
        bottom: 0;
        right: 0;
        min-height: 50%;
        height: 50%;
        width: 25%;
        pointer-events: none;
        z-index: 1;
      }
    }
    @media screen and (max-width: 1100px) {
      .eyecandy {
        display: none;
      }
    }
  </style>






    <link rel="prev" href="/pages/5/09/" />
     
    <link rel="next" href="/pages/6/01/" />
    
    
  </head>
  <body>
    <div id="particles-js" class="eyecandy"></div>

    <div class="book color-theme-2"><div class="book-summary">
    <script type="text/javascript">
        // Fixes the page links scroll problem on both desktop and mobile browsers
        function pageScrollToTop(element) {
            // both mobile and non-mobile
            $('div.body-inner').animate({scrollTop: 0});
            $(element).parent().find('li>ul>li').removeClass('active');
            return true;  // propagate
        }
        // Fixes the anchor links scroll problem on mobile browsers
        function mobilePageScrollToAnchor(element) {
            $(element).closest('li.chapter').find('ul>li').removeClass('active');
            $(element).parent().addClass('active');
            if ($(document).width() <= 1240) {
                $('div.body-inner').animate({scrollTop: $($(element).attr('href')).get(0).offsetTop});
            }
            return true;
        }
    </script>

    <nav role="navigation">
        <div id="book-search-input" role="search">
            <input type="text" placeholder="Type to search" />
        </div>
        <div id="book-search-input-link" role="search">
            <a href="/assets/search.html">Click to Search</a>
        </div>
        <ul class="summary">
            
                <!-- <p>pages</p> -->
                
                    

                    
                        
                        <li class="chapter" data-level="1.1" data-path="/">
                        
                            <a href="/" onclick="pageScrollToTop(this)">
                                About
                            </a>
                            
                                
                            
                        </li>
                        
                        
                            <li class="divider-header">
                                <a>Basics</a>
                            </li>
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/1/01/">
                        
                            <a href="/pages/1/01/" onclick="pageScrollToTop(this)">
                                Computer Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/1/02/">
                        
                            <a href="/pages/1/02/" onclick="pageScrollToTop(this)">
                                Game Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/1/03/">
                        
                            <a href="/pages/1/03/" onclick="pageScrollToTop(this)">
                                Hacking Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/1/04/">
                        
                            <a href="/pages/1/04/" onclick="pageScrollToTop(this)">
                                Setting Up a VM
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/1/05/">
                        
                            <a href="/pages/1/05/" onclick="pageScrollToTop(this)">
                                Memory Hack
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                            <li class="divider-header">
                                <a>Debugging & Reversing</a>
                            </li>
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/01/">
                        
                            <a href="/pages/2/01/" onclick="pageScrollToTop(this)">
                                Debugging Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/02/">
                        
                            <a href="/pages/2/02/" onclick="pageScrollToTop(this)">
                                Assembly Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/03/">
                        
                            <a href="/pages/2/03/" onclick="pageScrollToTop(this)">
                                Using Breakpoints
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/04/">
                        
                            <a href="/pages/2/04/" onclick="pageScrollToTop(this)">
                                Changing Game Code
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/05/">
                        
                            <a href="/pages/2/05/" onclick="pageScrollToTop(this)">
                                Reversing Code
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/06/">
                        
                            <a href="/pages/2/06/" onclick="pageScrollToTop(this)">
                                Code Caves
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/07/">
                        
                            <a href="/pages/2/07/" onclick="pageScrollToTop(this)">
                                Using Code Caves
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/08/">
                        
                            <a href="/pages/2/08/" onclick="pageScrollToTop(this)">
                                Dynamic Memory Allocation
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/09/">
                        
                            <a href="/pages/2/09/" onclick="pageScrollToTop(this)">
                                Defeating DMA
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                            <li class="divider-header">
                                <a>Programming</a>
                            </li>
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/3/01/">
                        
                            <a href="/pages/3/01/" onclick="pageScrollToTop(this)">
                                Programming Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/3/02/">
                        
                            <a href="/pages/3/02/" onclick="pageScrollToTop(this)">
                                External Memory Hack
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/3/03/">
                        
                            <a href="/pages/3/03/" onclick="pageScrollToTop(this)">
                                DLL Memory Hack
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/3/04/">
                        
                            <a href="/pages/3/04/" onclick="pageScrollToTop(this)">
                                Code Caves &amp; DLL&#39;s
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/3/05/">
                        
                            <a href="/pages/3/05/" onclick="pageScrollToTop(this)">
                                Printing Text
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                            <li class="divider-header">
                                <a>RTS/RPG Hacks</a>
                            </li>
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/4/01/">
                        
                            <a href="/pages/4/01/" onclick="pageScrollToTop(this)">
                                Stathack
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/4/02/">
                        
                            <a href="/pages/4/02/" onclick="pageScrollToTop(this)">
                                Map Hack
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/4/03/">
                        
                            <a href="/pages/4/03/" onclick="pageScrollToTop(this)">
                                Macro Bot
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/4/04/">
                        
                            <a href="/pages/4/04/" onclick="pageScrollToTop(this)">
                                Farming Bot
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                            <li class="divider-header">
                                <a>FPS Hacks</a>
                            </li>
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/01/">
                        
                            <a href="/pages/5/01/" onclick="pageScrollToTop(this)">
                                3D Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/02/">
                        
                            <a href="/pages/5/02/" onclick="pageScrollToTop(this)">
                                Wallhack (Memory)
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/03/">
                        
                            <a href="/pages/5/03/" onclick="pageScrollToTop(this)">
                                Wallhack (OpenGL)
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/04/">
                        
                            <a href="/pages/5/04/" onclick="pageScrollToTop(this)">
                                Chams (OpenGL)
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/05/">
                        
                            <a href="/pages/5/05/" onclick="pageScrollToTop(this)">
                                Triggerbot
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/06/">
                        
                            <a href="/pages/5/06/" onclick="pageScrollToTop(this)">
                                Aimbot
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/07/">
                        
                            <a href="/pages/5/07/" onclick="pageScrollToTop(this)">
                                No Recoil
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/08/">
                        
                            <a href="/pages/5/08/" onclick="pageScrollToTop(this)">
                                Radar Hack
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/09/">
                        
                            <a href="/pages/5/09/" onclick="pageScrollToTop(this)">
                                ESP
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter active" data-level="1.2" data-path="/pages/5/10/">
                        
                            <a href="/pages/5/10/" onclick="pageScrollToTop(this)">
                                Multihack
                            </a>
                            
                                
                                    <ul><li><a href="#target" onclick="mobilePageScrollToAnchor(this)" >Target</a></li><li><a href="#identify" onclick="mobilePageScrollToAnchor(this)" >Identify</a></li><li><a href="#understand" onclick="mobilePageScrollToAnchor(this)" >Understand</a></li><li><a href="#wallhack" onclick="mobilePageScrollToAnchor(this)" >Wallhack</a></li><li><a href="#combining" onclick="mobilePageScrollToAnchor(this)" >Combining</a></li><li><a href="#first-refactor" onclick="mobilePageScrollToAnchor(this)" >First Refactor</a></li><li><a href="#finish-refactor" onclick="mobilePageScrollToAnchor(this)" >Finish Refactor</a></li><li><a href="#adding-a-menu" onclick="mobilePageScrollToAnchor(this)" >Adding a Menu</a></li><li><a href="#toggling-features" onclick="mobilePageScrollToAnchor(this)" >Toggling Features</a></li><li><a href="#adding-colors" onclick="mobilePageScrollToAnchor(this)" >Adding Colors</a></li></ul>

                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                            <li class="divider-header">
                                <a>Multiplayer</a>
                            </li>
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/6/01/">
                        
                            <a href="/pages/6/01/" onclick="pageScrollToTop(this)">
                                Multiplayer Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/6/02/">
                        
                            <a href="/pages/6/02/" onclick="pageScrollToTop(this)">
                                Packet Analysis
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/6/03/">
                        
                            <a href="/pages/6/03/" onclick="pageScrollToTop(this)">
                                Reversing Packets
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/6/04/">
                        
                            <a href="/pages/6/04/" onclick="pageScrollToTop(this)">
                                Creating an External Client
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/6/05/">
                        
                            <a href="/pages/6/05/" onclick="pageScrollToTop(this)">
                                Proxying TCP Traffic
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                            <li class="divider-header">
                                <a>Tool Development</a>
                            </li>
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/7/01/">
                        
                            <a href="/pages/7/01/" onclick="pageScrollToTop(this)">
                                DLL Injector
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/7/02/">
                        
                            <a href="/pages/7/02/" onclick="pageScrollToTop(this)">
                                Pattern Scanner
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/7/03/">
                        
                            <a href="/pages/7/03/" onclick="pageScrollToTop(this)">
                                Memory Scanner
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/7/04/">
                        
                            <a href="/pages/7/04/" onclick="pageScrollToTop(this)">
                                Disassembler
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/7/05/">
                        
                            <a href="/pages/7/05/" onclick="pageScrollToTop(this)">
                                Debugger
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/7/06/">
                        
                            <a href="/pages/7/06/" onclick="pageScrollToTop(this)">
                                Call Logger
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                            <li class="divider-header">
                                <a>Game Resources</a>
                            </li>
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/8/01/">
                        
                            <a href="/pages/8/01/" onclick="pageScrollToTop(this)">
                                Resource Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/8/02/">
                        
                            <a href="/pages/8/02/" onclick="pageScrollToTop(this)">
                                Modifying Save Data
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/8/03/">
                        
                            <a href="/pages/8/03/" onclick="pageScrollToTop(this)">
                                Modifying Textures
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/8/04/">
                        
                            <a href="/pages/8/04/" onclick="pageScrollToTop(this)">
                                Modifying Units
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                
            
                <!-- <p>posts</p> -->
                
                    

                    
                
            
        </ul>

        &nbsp;
    </nav>
</div>
<div class="book-body">
        <div class="book-header" role="navigation">
          <!-- Title -->
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i>
            
            <a href=".">Multihack</a>
            
          </h1>
        </div>

        <div class="body-inner"><div class="page-wrapper" tabindex="-1" role="main">
    

    <div class="page-inner">
        <div id="book-search-results">
            <div class="search-noresults">
                <section class="normal markdown-section">
                    

                    <h1 id="target">Target</h1>

<p>Our target for this lesson will be Assault Cube 1.2.0.2.</p>

<h1 id="identify">Identify</h1>

<p>In the previous lessons, we created several hacks for Assault Cube, including
a triggerbot, an aimbot, and ESP. In this lesson, we will create a multihack
that combines these hacks together along with a wallhack. Then, we will
add an interactive menu that will allow us to toggle all the hacks we have
created at once.</p>

<p>Our result at the end of the lesson:</p>
<video controls="" autoplay="" loop="">
  <source src="/assets/images/5/10/cube.mp4" />
</video>

<h1 id="understand">Understand</h1>

<p>We have written code in the previous lessons for a wallhack, triggerbot,
aimbot, and ESP. However, if we try to combine all this code together, it
will quickly become overwhelming to add new features. To create our
multihack, we will use a software development technique known as
refactoring.</p>

<p>When refactoring code, you take existing code and alter its structure
without changing its behavior. There can be many goals when refactoring,
but in our case, our goal will be to encapsulate certain functionality
into classes so that the code can be separated out into logical sections.
This will clean up the code and make it easier to maintain. Once this is
done, we will build off this refactored code to add our menu.</p>

<p>This lesson will involve working with a lot of code. Each separate stage of
the code will be available in the <a href="https://github.com/GameHackingAcademy/AssaultCube_Multihack">github repository</a>
for this lesson. The final code will be on the master branch.</p>

<h1 id="wallhack">Wallhack</h1>

<p>In the <a href="/pages/5/03/">Wallhack (OpenGL)</a> lesson, we covered an
approach for making a wallhack for games that used OpenGL. We can use the
same technique for Assault Cube with some small modifications.</p>

<p>In the original target game (Urban Terror), we needed to check for counts
and re-enable depth testing if the model’s count was not large enough. If
we did not do this, every item would have depth testing disabled. However,
in Assault Cube, the rendering logic works differently, and this check is
not required. Additionally, Assault Cube does not require us to worry
about clipping planes. As a result, our
<strong>glDrawElements</strong> code cave can be simplified:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">__declspec</span><span class="p">(</span><span class="kr">naked</span><span class="p">)</span> <span class="kt">void</span> <span class="nf">opengl_codecave</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">__asm</span> <span class="p">{</span>
    <span class="n">pushad</span>
  <span class="p">}</span>

  <span class="p">(</span><span class="o">*</span><span class="n">glDepthFunc</span><span class="p">)(</span><span class="mh">0x207</span><span class="p">);</span>

  <span class="c1">// Finally, restore the original instruction and jump back</span>
  <span class="kr">__asm</span> <span class="p">{</span>
    <span class="n">popad</span>
    <span class="n">mov</span> <span class="n">esi</span><span class="p">,</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="n">ds</span> <span class="o">:</span> <span class="p">[</span><span class="n">esi</span> <span class="o">+</span> <span class="mh">0xA18</span><span class="p">]</span>
    <span class="n">jmp</span> <span class="n">opengl_ret_address</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>By using the same hooking technique described in the <a href="/pages/5/03/">Wallhack (OpenGL)</a> lesson, we now have a working
wallhack for Assault Cube.</p>

<h1 id="combining">Combining</h1>

<p>This combined code we are covering in this section is available on the <a href="https://github.com/GameHackingAcademy/AssaultCube_Multihack/tree/combined">“combined”</a> branch.</p>

<p>Our first task is to combine all of our code from the previous lessons into
one DLL. Our multihack will contain the following hacks:</p>

<ul>
  <li>OpenGL Wallhack</li>
  <li>Triggerbot</li>
  <li>Aimbot</li>
  <li>ESP</li>
</ul>

<p>We can combine this code by copying it all into a single main file and
changing any conflicting variable or function names (like all the versions
of injected_thread). The result of this can be seen in the github branch.</p>

<p>Looking over this code, the first thing that should jump out is that it is
over 300 lines long with 20 global variables. In addition, we can see that
we have two threads being created (one for hooking OpenGL and one for our
aimbot) and multiple code caves.</p>

<p>With our combined code, we can make two small changes to slightly improve
the size of the code. First, we can combine together the aimbot and ESP
code, since they use a majority of the same logic. Second, we can modify
the thread for OpenGL to <strong>break</strong> out of its
<strong>while</strong> loop once it hooks <strong>glDrawElements</strong>:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">openGLHandle</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">glDepthFunc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">glDepthFunc</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="p">(</span><span class="kr">__stdcall</span><span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">))</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">openGLHandle</span><span class="p">,</span> <span class="s">"glDepthFunc"</span><span class="p">);</span>
  <span class="p">...</span>
  <span class="c1">// Since OpenGL is loaded dynamically, we need to dynamically calculate the return address</span>
  <span class="n">opengl_ret_address</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)(</span><span class="n">opengl_hook_location</span> <span class="o">+</span> <span class="mh">0x6</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">else</span> <span class="p">{</span>
  <span class="k">break</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This will effectively exit the thread once we hook OpenGL, to prevent our
hack from having so many open threads.</p>

<p>In its current form, this code could be built and used as a multihack;
however, it is almost impossible to maintain. If we want to add a menu and
a method to toggle functionality, we would need to thoroughly examine all
300+ lines of code and make sure our toggles do not introduce any
unexpected behavior across the many threads. Furthermore, we do not
currently have a good way to print text outside of our ESP.</p>

<h1 id="first-refactor">First Refactor</h1>

<p>The source code we are covering in this section is available on the <a href="https://github.com/GameHackingAcademy/AssaultCube_Multihack/tree/refactor-triggerbot">“refactor-triggerbot”</a> branch.</p>

<p>There are multiple approaches that can be used to simplify our code. For
our purposes, we will encapsulate major functionality inside classes. Our
end goal is to create classes that can be easily reused in other FPS
games. We will then call those classes from the main file.</p>

<p>Classes in C++ commonly have two components: the header, which describes
what the class contains and is included by the caller, and the source,
which contains all the class’s code. Therefore, we will split our
multihack’s code into Header and Source folders for all the following
refactoring.</p>

<p>A good place to start is the triggerbot. In its most basic form, our
triggerbot sends a mouse down event whenever we are looking at a player.
To make this code reusable, we will structure the triggerbot class to
require the main hack to provide information on if we are looking at a
player.</p>

<p>Let’s start with the current triggerbot code:</p>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">__declspec</span><span class="p">(</span><span class="kr">naked</span><span class="p">)</span> <span class="kt">void</span> <span class="nf">triggerbot_codecave</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">__asm</span> <span class="p">{</span>
    <span class="n">call</span> <span class="n">triggerbot_ori_call_address</span>
    <span class="n">pushad</span>
    <span class="n">mov</span> <span class="n">edi_value</span><span class="p">,</span> <span class="n">eax</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">edi_value</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">input</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">INPUT_MOUSE</span><span class="p">;</span>
    <span class="n">input</span><span class="p">.</span><span class="n">mi</span><span class="p">.</span><span class="n">dwFlags</span> <span class="o">=</span> <span class="n">MOUSEEVENTF_LEFTDOWN</span><span class="p">;</span>
    <span class="n">SendInput</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">input</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">INPUT</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="n">input</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">INPUT_MOUSE</span><span class="p">;</span>
    <span class="n">input</span><span class="p">.</span><span class="n">mi</span><span class="p">.</span><span class="n">dwFlags</span> <span class="o">=</span> <span class="n">MOUSEEVENTF_LEFTUP</span><span class="p">;</span>
    <span class="n">SendInput</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">input</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">INPUT</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="n">_asm</span> <span class="p">{</span>
    <span class="n">popad</span>
    <span class="n">jmp</span> <span class="n">triggerbot_ori_jump_address</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In Assault Cube, the <strong>edi</strong> register holds whether a player
is being looked at. However, in other games, this will be different.
Therefore, it makes sense to only abstract out the code between the
<strong>__asm</strong> blocks. We can replace this code with a call to our
triggerbot class:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">__declspec</span><span class="p">(</span><span class="kr">naked</span><span class="p">)</span> <span class="kt">void</span> <span class="nf">triggerbot_codecave</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">__asm</span> <span class="p">{</span>
    <span class="n">call</span> <span class="n">triggerbot_ori_call_address</span>
    <span class="n">pushad</span>
    <span class="n">mov</span> <span class="n">edi_value</span><span class="p">,</span> <span class="n">eax</span>
  <span class="p">}</span>

  <span class="n">triggerbot</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">(</span><span class="n">edi_value</span><span class="p">);</span>

  <span class="n">_asm</span> <span class="p">{</span>
    <span class="n">popad</span>
    <span class="n">jmp</span> <span class="n">triggerbot_ori_jump_address</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now that we know how the calling code will look, we can create the class.
First, we can create a header that will contain the definition of our
triggerbot class:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#pragma once
</span>
<span class="cp">#include</span> <span class="cpf">&lt;Windows.h&gt;</span><span class="cp">
</span>
<span class="k">class</span> <span class="nc">Triggerbot</span> <span class="p">{</span>
<span class="nl">private:</span>
  <span class="n">INPUT</span> <span class="n">input</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">Triggerbot</span><span class="p">();</span>
  <span class="kt">void</span> <span class="nf">execute</span><span class="p">(</span><span class="kt">int</span> <span class="n">isLookingAtEnemy</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div></div>

<p>Classes have both private and public members. Public members can be
accessed by other code. For example, we can see that the
<strong>execute</strong> method will be called directly by our main file.
However, the main file will not have access to the
<strong>input</strong> variable.</p>

<p>To implement the code for our triggerbot class, we will create the source
file next. This file will include the header we defined above, but will
contain the actual code of the class:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;Windows.h&gt;</span><span class="cp">
</span>
<span class="cp">#include</span> <span class="cpf">"Triggerbot.h"</span><span class="cp">
</span>
<span class="n">Triggerbot</span><span class="o">::</span><span class="n">Triggerbot</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">input</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Triggerbot</span><span class="o">::</span><span class="n">execute</span><span class="p">(</span><span class="kt">int</span> <span class="n">isLookingAtEnemy</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">isLookingAtEnemy</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">input</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">INPUT_MOUSE</span><span class="p">;</span>
    <span class="n">input</span><span class="p">.</span><span class="n">mi</span><span class="p">.</span><span class="n">dwFlags</span> <span class="o">=</span> <span class="n">MOUSEEVENTF_LEFTDOWN</span><span class="p">;</span>
    <span class="n">SendInput</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">input</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">INPUT</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="n">input</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">INPUT_MOUSE</span><span class="p">;</span>
    <span class="n">input</span><span class="p">.</span><span class="n">mi</span><span class="p">.</span><span class="n">dwFlags</span> <span class="o">=</span> <span class="n">MOUSEEVENTF_LEFTUP</span><span class="p">;</span>
    <span class="n">SendInput</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">input</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">INPUT</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This is the same as the original triggerbot code, except now encapsulated
into this one class. We could add this class to a hack for another game
and it would work, assuming that the main source file in that hack
provided the correct value for <strong>isLookingAtEnemy</strong>.</p>

<p>To use this class in our main code, we will need to include the header and
create an instance of it:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">"Triggerbot.h"</span><span class="cp">
</span><span class="p">...</span> 
<span class="n">Triggerbot</span> <span class="o">*</span><span class="n">triggerbot</span><span class="p">;</span>
<span class="p">...</span> 
<span class="n">BOOL</span> <span class="n">WINAPI</span> <span class="nf">DllMain</span><span class="p">(</span><span class="n">HINSTANCE</span> <span class="n">hinstDLL</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">fdwReason</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">lpvReserved</span><span class="p">)</span> <span class="p">{</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">fdwReason</span> <span class="o">==</span> <span class="n">DLL_PROCESS_ATTACH</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">triggerbot</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Triggerbot</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">fdwReason</span> <span class="o">==</span> <span class="n">DLL_PROCESS_DETACH</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">delete</span> <span class="n">triggerbot</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>By structuring the code this way, our triggerbot code is now simplified
and can be easily modified. For example, to toggle the triggerbot on and
off, we could simply add a single conditional, like:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span><span class="p">(</span><span class="n">triggerbot_enabled</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">triggerbot</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">(</span><span class="n">edi_value</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We can also use this opportunity to remove the
<strong>input</strong> global variable from the main source file.</p>

<h1 id="finish-refactor">Finish Refactor</h1>

<p>The code for this section is on the <a href="https://github.com/GameHackingAcademy/AssaultCube_Multihack/tree/refactor-finished">“refactor-finished”</a> branch.</p>

<p>Another major component we would like to separate out is the code
responsible for the aimbot and ESP. Looking at the code, we see that it is
responsible for setting the following values:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">x_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)(</span><span class="mi">1200</span> <span class="o">+</span> <span class="p">(</span><span class="n">yaw_dif</span> <span class="o">*</span> <span class="o">-</span><span class="mi">30</span><span class="p">));</span>
<span class="n">y_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)(</span><span class="mi">900</span> <span class="o">+</span> <span class="p">((</span><span class="n">pitch_dif</span><span class="p">)</span> <span class="o">*</span> <span class="mi">25</span><span class="p">));</span>
<span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">enemy</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>

<span class="n">player</span><span class="o">-&gt;</span><span class="n">yaw</span> <span class="o">=</span> <span class="n">closest_yaw</span><span class="p">;</span>
<span class="n">player</span><span class="o">-&gt;</span><span class="n">pitch</span> <span class="o">=</span> <span class="n">closest_pitch</span><span class="p">;</span>
</code></pre></div></div>

<p>The X, Y, and name values are used for the ESP whereas the player’s yaw
and pitch are used for the aimbot. To calculate these values, our aimbot
and ESP require the player’s base address, the enemy list’s base address,
and the current number of players in the game.</p>

<p>To encapsulate this behavior in a class, we will separate the
functionality into two functions. The first function will be responsible
for calculating all the X, Y, and name values for the ESP, as well as the
closest yaw and pitch. The second function will be responsible for setting
the player’s view to the calculated location. Separating these functions
will allow us to easily toggle both the ESP and aimbot.</p>

<p>Since this class is responsible for player geometry and the player’s
relation to the world, we will call it <strong>PlayerGeometry</strong>.
Like we did with the triggerbot, we can change our aimbot thread to:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">aimbot_thread</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">playerGeometry</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">();</span>
    <span class="n">playerGeometry</span><span class="o">-&gt;</span><span class="n">set_player_view</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Since this code is now easily maintainable, we can combine the two threads
in the main file:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">injected_thread</span><span class="p">()</span> <span class="p">{</span>

  <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">openGLHandle</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">glDepthFunc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="p">...</span>
    <span class="p">}</span>

    <span class="n">playerGeometry</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">();</span>
    <span class="n">playerGeometry</span><span class="o">-&gt;</span><span class="n">set_player_view</span><span class="p">();</span>

    <span class="n">Sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Our <strong>PlayerGeometry</strong> class will contain all player-relevant
functions. To handle printing the ESP in our main file, the class will
expose the array of X, Y, and name values:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">PlayerGeometry</span> <span class="p">{</span>
<span class="nl">private:</span>
  <span class="n">DWORD</span> <span class="n">player_offset_address</span><span class="p">;</span>
  <span class="n">DWORD</span> <span class="n">enemy_list_address</span><span class="p">;</span>
  <span class="n">DWORD</span> <span class="n">current_players_address</span><span class="p">;</span>

  <span class="kt">float</span> <span class="n">closest_yaw</span><span class="p">;</span>
  <span class="kt">float</span> <span class="n">closest_pitch</span><span class="p">;</span>

  <span class="n">Player</span><span class="o">*</span> <span class="n">player</span><span class="p">;</span>

  <span class="kt">float</span> <span class="n">euclidean_distance</span><span class="p">(</span><span class="kt">float</span><span class="p">,</span> <span class="kt">float</span><span class="p">);</span>
<span class="nl">public:</span>
  <span class="n">DWORD</span> <span class="n">x_values</span><span class="p">[</span><span class="n">MAX_PLAYERS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
  <span class="n">DWORD</span> <span class="n">y_values</span><span class="p">[</span><span class="n">MAX_PLAYERS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
  <span class="kt">char</span><span class="o">*</span> <span class="n">names</span><span class="p">[</span><span class="n">MAX_PLAYERS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">NULL</span> <span class="p">};</span>

  <span class="kt">int</span><span class="o">*</span> <span class="n">current_players</span><span class="p">;</span>

  <span class="n">PlayerGeometry</span><span class="p">(</span><span class="n">DWORD</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">);</span>
  <span class="kt">void</span> <span class="nf">update</span><span class="p">();</span>
  <span class="kt">void</span> <span class="nf">set_player_view</span><span class="p">();</span>
<span class="p">};</span>
</code></pre></div></div>

<p>Unlike the triggerbot class, which just needed a parameter, this class
requires the player’s base address, the enemy list’s base address, and the
current number of players in the game. We will pass these in the
constructor of the class, which is a special function that executes when
the class is created:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PlayerGeometry</span><span class="o">::</span><span class="n">PlayerGeometry</span><span class="p">(</span><span class="n">DWORD</span> <span class="n">p_address</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">e_address</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">cp_address</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">player_offset_address</span> <span class="o">=</span> <span class="n">p_address</span><span class="p">;</span>
  <span class="n">enemy_list_address</span> <span class="o">=</span> <span class="n">e_address</span><span class="p">;</span>
  <span class="n">current_players_address</span> <span class="o">=</span> <span class="n">cp_address</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We can then use these values in the class’s code:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">PlayerGeometry</span><span class="o">::</span><span class="n">update</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">DWORD</span><span class="o">*</span> <span class="n">player_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(</span><span class="n">player_offset_address</span><span class="p">);</span>
  <span class="n">player</span> <span class="o">=</span> <span class="p">(</span><span class="n">Player</span><span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="n">player_offset</span><span class="p">);</span>
  <span class="p">...</span> <span class="n">rest</span> <span class="n">of</span> <span class="n">aimbot</span> <span class="n">and</span> <span class="n">ESP</span> <span class="n">code</span> <span class="p">...</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">PlayerGeometry</span><span class="o">::</span><span class="n">set_player_view</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">player</span><span class="o">-&gt;</span><span class="n">yaw</span> <span class="o">=</span> <span class="n">closest_yaw</span><span class="p">;</span>
  <span class="n">player</span><span class="o">-&gt;</span><span class="n">pitch</span> <span class="o">=</span> <span class="n">closest_pitch</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>When we create this class in our main file, we will pass these values. In
this way, we can reuse the aimbot code in any game that has a similar
memory layout:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">playerGeometry</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">PlayerGeometry</span><span class="p">(</span><span class="mh">0x509B74</span><span class="p">,</span> <span class="mh">0x50F4F8</span><span class="p">,</span> <span class="mh">0x50F500</span><span class="p">);</span>
</code></pre></div></div>

<p>We will also need to adjust the ESP code to use the values from this
class:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="o">*</span><span class="n">playerGeometry</span><span class="o">-&gt;</span><span class="n">current_players</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">playerGeometry</span><span class="o">-&gt;</span><span class="n">x_values</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">playerGeometry</span><span class="o">-&gt;</span><span class="n">y_values</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
  <span class="n">text</span> <span class="o">=</span> <span class="n">playerGeometry</span><span class="o">-&gt;</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</code></pre></div></div>

<p>Finally, we can move some variables that never change to a constants
header, just to separate the variables out from the main file.</p>

<h1 id="adding-a-menu">Adding a Menu</h1>

<p>The code for the rest of this lesson is on the <a href="https://github.com/GameHackingAcademy/AssaultCube_Multihack">“master”</a> branch.</p>

<p>With our code refactored, we can add a menu. First, we will extract out
the text printing functionality to its own function:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">print_text</span><span class="p">(</span><span class="n">DWORD</span> <span class="n">x</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">y</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">text</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">2400</span> <span class="o">||</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="mi">1800</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s">""</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">x</span> <span class="o">+=</span> <span class="mi">200</span><span class="p">;</span>

  <span class="kr">__asm</span> <span class="p">{</span>
    <span class="n">mov</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">text</span>
    <span class="n">push</span> <span class="n">y</span>
    <span class="n">push</span> <span class="n">x</span>
    <span class="n">call</span> <span class="n">text_address</span>
    <span class="n">add</span> <span class="n">esp</span><span class="p">,</span> <span class="mi">8</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Like we have done with our refactoring, we will place our menu
functionality in its own class. Our menu needs to handle two things:</p>

<ul>
  <li>Toggling items on and off</li>
  <li>Displaying a cursor and set of menu items</li>
</ul>

<p>We will focus on displaying the menu first. To make the job of displaying
the menu easier, we will create two arrays in our menu class definition:
one that contains item display texts, and one that contains item states:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define MAX_ITEMS 4
</span>
<span class="k">public</span><span class="o">:</span>
  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">items</span><span class="p">[</span><span class="n">MAX_ITEMS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">"Wallhack"</span><span class="p">,</span> <span class="s">"ESP"</span><span class="p">,</span> <span class="s">"Aimbot"</span><span class="p">,</span> <span class="s">"Triggerbot"</span> <span class="p">};</span>
  <span class="kt">bool</span> <span class="n">item_enabled</span><span class="p">[</span><span class="n">MAX_ITEMS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">false</span> <span class="p">};</span>
</code></pre></div></div>

<p>We will also need a way to return a string of <strong>On</strong> or
<strong>Off</strong> depending on the item’s state:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">Menu</span><span class="o">::</span><span class="n">get_state</span><span class="p">(</span><span class="kt">int</span> <span class="n">item</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">item_enabled</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">?</span> <span class="s">"On"</span> <span class="o">:</span> <span class="s">"Off"</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>With these pieces in place, we can now add a loop in the text code cave to
display all the menu items:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_ITEMS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">print_text</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">250</span> <span class="o">+</span> <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">i</span><span class="p">),</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="n">print_text</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">250</span> <span class="o">+</span> <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">i</span><span class="p">),</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">get_state</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<p>With our items printed, we can move on to adding a cursor. Our cursor will
need to have a character and a position, so we will add these in the class
definition. We also need to create an external function to handle all
input for our menu:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">public:</span>
  <span class="kt">int</span> <span class="n">cursor_position</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">cursor</span> <span class="o">=</span> <span class="s">"&gt;"</span><span class="p">;</span>

  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="nf">get_state</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
</code></pre></div></div>

<p>To handle our input, we will use <strong>GetAsyncKeyState</strong>,
similar to what we did in previous lessons. First, we will handle up and
down:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">Menu</span><span class="o">::</span><span class="n">handle_input</span><span class="p">()</span> <span class="p">{</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">GetAsyncKeyState</span><span class="p">(</span><span class="n">VK_DOWN</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cursor_position</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">GetAsyncKeyState</span><span class="p">(</span><span class="n">VK_UP</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cursor_position</span><span class="o">--</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>The <strong>&amp;1</strong> has the effect of only registering the key
press a single time for a short period of time instead of spamming it. The <a href="https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-getasynckeystate">API documentation</a> discusses this behavior.</p>

<p>If we press left and right, we want to enable or disable an item. Since
all the item states are either true or false, we can simply switch their
current value with the not (!) operator:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">else</span> <span class="nf">if</span> <span class="p">((</span><span class="n">GetAsyncKeyState</span><span class="p">(</span><span class="n">VK_LEFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">GetAsyncKeyState</span><span class="p">(</span><span class="n">VK_RIGHT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
  <span class="n">item_enabled</span><span class="p">[</span><span class="n">cursor_position</span><span class="p">]</span> <span class="o">=</span> <span class="o">!</span><span class="n">item_enabled</span><span class="p">[</span><span class="n">cursor_position</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div>

<p>If we navigate past the boundaries of our menu, we want the cursor to
appear at the other end. We can do that by adding a few checks:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">cursor_position</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">cursor_position</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">cursor_position</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">cursor_position</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We can now add our menu to our main file. First, we need the text code
cave to also print the cursor. We will make it look like it’s moving by
offsetting the current position with a multiple of 100:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">print_text</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">250</span> <span class="o">+</span> <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">cursor_position</span><span class="p">),</span> <span class="n">menu</span><span class="o">-&gt;</span><span class="n">cursor</span><span class="p">);</span>
</code></pre></div></div>

<p>In our thread, we also need to pass input to the menu to check for key
presses:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">menu</span><span class="o">-&gt;</span><span class="n">handle_input</span><span class="p">();</span>

<span class="n">playerGeometry</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">();</span>
</code></pre></div></div>

<h1 id="toggling-features">Toggling Features</h1>

<p>Finally, we need to toggle features based on their menu state. We already
created an array of all the item states. To determine the current value of
one of the features, we can query this array via:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">menu</span><span class="o">-&gt;</span><span class="n">item_enabled</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</code></pre></div></div>

<p>To make these entries more readable, we can create constants in our menu
header that reference the positions for each item:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define WALLHACK 0
#define ESP 1
#define AIMBOT 2
#define TRIGGERBOT 3
</span></code></pre></div></div>

<p>We can implement checks in our code by using these values. For example, to
toggle the wallhack, we can change the code to:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">menu</span><span class="o">-&gt;</span><span class="n">item_enabled</span><span class="p">[</span><span class="n">WALLHACK</span><span class="p">])</span> <span class="p">{</span>
  <span class="p">(</span><span class="o">*</span><span class="n">glDepthFunc</span><span class="p">)(</span><span class="mh">0x207</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This builds off of our refactoring efforts from before. To toggle our
aimbot, we can easily do the following in the thread:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">menu</span><span class="o">-&gt;</span><span class="n">item_enabled</span><span class="p">[</span><span class="n">AIMBOT</span><span class="p">])</span> <span class="p">{</span>
  <span class="n">playerGeometry</span><span class="o">-&gt;</span><span class="n">set_player_view</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Similar checks can be done for the triggerbot and ESP.</p>

<h1 id="adding-colors">Adding Colors</h1>

<p>Just for some visual flair, we can add colors to the menu items to make
them easier to read. By issuing votes in game, we can see that some text
in the game already has color, like the <em>Press F1 to vote</em> text. If
we examine this string in x64dbg, we see that it has the following data:</p>

<p><img src="/assets/images/5/10/cube1.png" alt="Text String" /></p>

<p>It looks like strings prefixed with <code class="language-plaintext highlighter-rouge">0x0C 33</code> are given a
color. If we look for other strings, we see that <code class="language-plaintext highlighter-rouge">0x0C</code> is
always there, but occasionally the value of <code class="language-plaintext highlighter-rouge">0x33</code> will be
different. Let’s incorporate these bytes into our on/off strings:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Menu</span> <span class="p">{</span>
<span class="nl">private:</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="n">on_text</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xc</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="sc">'O'</span><span class="p">,</span> <span class="sc">'N'</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="n">off_text</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xc</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="sc">'O'</span><span class="p">,</span> <span class="sc">'F'</span><span class="p">,</span> <span class="sc">'F'</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
</code></pre></div></div>

<p>If you go into the game, you will see both our strings are now red. If you
play around with the <code class="language-plaintext highlighter-rouge">0x33</code> and try different values
(<code class="language-plaintext highlighter-rouge">0x31</code>, <code class="language-plaintext highlighter-rouge">0x38</code>, etc.), you will eventually see that
<code class="language-plaintext highlighter-rouge">0x30</code> is green. Now we can modify our code to change the
<strong>On</strong> text to green:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">const</span> <span class="kt">char</span> <span class="n">on_text</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xc</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="sc">'O'</span><span class="p">,</span> <span class="sc">'N'</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
</code></pre></div></div>

<p>With this, our multihack is complete.</p>

<p> </p>


                </section>
            </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div></div>
    </div>
</div>

<!-- introduce mathjax support -->
<script>
window.MathJax = {
  tex: {
    inlineMath: [ ['$', '$'], ['\\(', '\\)'] ]
  },
  svg: {
    fontCache: 'global'
  }
};
</script>
<script
  type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
</script>


<!-- introduce per-page mermaid support -->


          <a
            href="/pages/5/09/"
            class="navigation navigation-prev navigation-unique"
            aria-label="Previous page: ESP"
          >
            <i class="fa fa-angle-left"></i>
          </a>
           
          <a
            href="/pages/6/01/"
            class="navigation navigation-next navigation-unique"
            aria-label="Next page: Multiplayer Fundamentals"
          >
            <i class="fa fa-angle-right"></i>
          </a>
          
        </div>
      </div>

      <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({
    "page": {
        "title": "Introduction",
        "level": "1.1",
        "depth": 1,
        
        "next": {
            "title": "Multiplayer Fundamentals",
            "level": "1.2",
            "depth": 1,
            "path": "_pages/6/01.md",
            "ref": "_pages/6/01.md",
            "articles": []
        },
        
        "dir": "ltr"
    },    "config": {
        "plugins": ["fontsettings", "highlight", "livereload", "lunr", "search", "sharing", "theme-default", "livereload"],
        "styles": {
            "ebook": "styles/ebook.css",
            "epub": "styles/epub.css",
            "mobi": "styles/mobi.css",
            "pdf": "styles/pdf.css",
            "print": "styles/print.css",
            "website": "styles/website.css"
        },
        "pluginsConfig": {
            "fontsettings": {
                "family": "sans",
                "size": 2,
                "theme": "white"
            },
            "highlight": {},
            "livereload": {},
            "lunr": {
                "ignoreSpecialCharacters": false,
                "maxIndexSize": 1000000
            },
            "search": {},            "sharing": {
                "facebook": false,

                "google": false,

                "github": true,
                "github_link": "https://github.com/GameHackingAcademy",

                "telegram": false,
                "telegram_link": "https://t.me",

                "instapaper": false,

                "twitter": true,
                "twitter_link": "https://twitter.com/GameHackingAcad",

                "vk": false,

                "weibo": false
            },
"theme-default": {
                "showLevel": false,
                "styles": {
                    "ebook": "styles/ebook.css",
                    "epub": "styles/epub.css",
                    "mobi": "styles/mobi.css",
                    "pdf": "styles/pdf.css",
                    "print": "styles/print.css",
                    "website": "styles/website.css"
                }
            }
        },
        "theme": "default",
        "author": "Tao He",
        "pdf": {
            "pageNumbers": true,
            "fontSize": 12,
            "fontFamily": "Arial",
            "paperSize": "a4",
            "chapterMark": "pagebreak",
            "pageBreaksBefore": "/",
            "margin": {
                "right": 62,
                "left": 62,
                "top": 56,
                "bottom": 56
            }
        },
        "structure": {
            "langs": "LANGS.md",
            "readme": "README.md",
        },
        "variables": {},
        "title": "Game Hacking Academy",
        "language": "en",
        "gitbook": "*"
    },
    "file": {
        "path": "_pages/5/10.md",
        "mtime": "2023-12-25 00:00:00 -0600",
        "type": "markdown"
    },
    "gitbook": {
        "version": "3.2.3",
        "time": "2023-12-31 12:09:34 -0600"
    },
    "basePath": "",
    "book": {
        "language": ""
    }
});
        });
      </script>
    </div><script src="/assets/gitbook/gitbook.js"></script>
<script src="/assets/gitbook/theme.js"></script>

<script src="/assets/gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
<script src="/assets/gitbook/gitbook-plugin-sharing/buttons.js"></script>

<!-- <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
<script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
<script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
<script src="../gitbook/gitbook-plugin-search/search.js"></script> -->

<script src="/assets/gitbook/gitbook-plugin-search-pro/jquery.mark.min.js"></script>
<script src="/assets/gitbook/gitbook-plugin-search-pro/search.js"></script>
<script src="/assets/gitbook/gitbook-plugin-back-to-top-button/plugin.js"></script>
<script src="/assets/gitbook/gitbook-plugin-copy-code-button/toggle.js"></script>

<!-- trackers --><!-- google analytics --><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-160704775-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-160704775-1');
</script>
<script>
      particlesJS("particles-js", {
        particles: {
          number: {
            value: 20,
            density: {
              enable: true,
              value_area: 100,
            },
          },
          color: {
            value: "#6195b9",
          },
          shape: {
            type: "edge",
          },
          opacity: {
            value: 0.3,
            anim: {
              enable: true,
              speed: 0.1,
              opacity_min: 0,
              sync: false,
            },
          },
          size: {
            value: 15,
            random: true,
          },
          line_linked: {
            enable: false,
          },
          move: {
            enable: true,
            speed: 0.5,
            direction: "top",
            random: true,
            straight: true,
            out_mode: "out",
            bounce: false,
            attract: {
              enable: false,
            },
          },
        },
        interactivity: {
          detect_on: "canvas",
          events: {
            onhover: {
              enable: false,
            },
            onclick: {
              enable: false,
            },
            resize: true,
          },
        },
      });
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="en">
  <head><meta charset="UTF-8">
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"><title>Disassembler Â· Game Hacking Academy</title><meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="description" content="Game hacking tutorials and lessons.
"><meta name="generator" content="Jekyll (using style of GitBook 3.2.3)"><meta name="author" content="attilathedud"><link rel="stylesheet" href="/assets/gitbook/style.css">
<link rel="stylesheet" href="/assets/gitbook/gitbook-plugin-fontsettings/website.css">
<link rel="stylesheet" href="/assets/gitbook/gitbook-plugin-search-pro/search.css">
<link rel="stylesheet" href="/assets/gitbook/gitbook-plugin-back-to-top-button/plugin.css">

<link rel="stylesheet" href="/assets/gitbook/rouge/base16.css">

<link rel="stylesheet" href="/assets/gitbook/custom.css">
<link rel="stylesheet" href="/assets/gitbook/custom-local.css">

<meta name="HandheldFriendly" content="true"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="/assets/gitbook/images/apple-touch-icon-precomposed-152.png">
<link rel="shortcut icon" href="/assets/images/favicon.ico" type="image/x-icon">

<script src="/assets/particles.min.js"></script>

<style>
    @media screen and (min-width: 1101px) {
      .eyecandy {
        position: fixed;
        bottom: 0;
        right: 0;
        min-height: 50%;
        height: 50%;
        width: 25%;
        pointer-events: none;
        z-index: 1;
      }
    }
    @media screen and (max-width: 1100px) {
      .eyecandy {
        display: none;
      }
    }
  </style>






    <link rel="prev" href="/pages/7/03/" />
     
    <link rel="next" href="/pages/7/05/" />
    
    
  </head>
  <body>
    <div id="particles-js" class="eyecandy"></div>

    <div class="book color-theme-2"><div class="book-summary">
    <script type="text/javascript">
        // Fixes the page links scroll problem on both desktop and mobile browsers
        function pageScrollToTop(element) {
            // both mobile and non-mobile
            $('div.body-inner').animate({scrollTop: 0});
            $(element).parent().find('li>ul>li').removeClass('active');
            return true;  // propagate
        }
        // Fixes the anchor links scroll problem on mobile browsers
        function mobilePageScrollToAnchor(element) {
            $(element).closest('li.chapter').find('ul>li').removeClass('active');
            $(element).parent().addClass('active');
            if ($(document).width() <= 1240) {
                $('div.body-inner').animate({scrollTop: $($(element).attr('href')).get(0).offsetTop});
            }
            return true;
        }
    </script>

    <nav role="navigation">
        <div id="book-search-input" role="search">
            <input type="text" placeholder="Type to search" />
        </div>
        <div id="book-search-input-link" role="search">
            <a href="/assets/search.html">Click to Search</a>
        </div>
        <ul class="summary">
            
                <!-- <p>pages</p> -->
                
                    

                    
                        
                        <li class="chapter" data-level="1.1" data-path="/">
                        
                            <a href="/" onclick="pageScrollToTop(this)">
                                About
                            </a>
                            
                                
                            
                        </li>
                        
                        
                            <li class="divider-header">
                                <a>Basics</a>
                            </li>
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/1/01/">
                        
                            <a href="/pages/1/01/" onclick="pageScrollToTop(this)">
                                Computer Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/1/02/">
                        
                            <a href="/pages/1/02/" onclick="pageScrollToTop(this)">
                                Game Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/1/03/">
                        
                            <a href="/pages/1/03/" onclick="pageScrollToTop(this)">
                                Hacking Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/1/04/">
                        
                            <a href="/pages/1/04/" onclick="pageScrollToTop(this)">
                                Setting Up a VM
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/1/05/">
                        
                            <a href="/pages/1/05/" onclick="pageScrollToTop(this)">
                                Memory Hack
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                            <li class="divider-header">
                                <a>Debugging & Reversing</a>
                            </li>
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/01/">
                        
                            <a href="/pages/2/01/" onclick="pageScrollToTop(this)">
                                Debugging Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/02/">
                        
                            <a href="/pages/2/02/" onclick="pageScrollToTop(this)">
                                Assembly Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/03/">
                        
                            <a href="/pages/2/03/" onclick="pageScrollToTop(this)">
                                Using Breakpoints
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/04/">
                        
                            <a href="/pages/2/04/" onclick="pageScrollToTop(this)">
                                Changing Game Code
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/05/">
                        
                            <a href="/pages/2/05/" onclick="pageScrollToTop(this)">
                                Reversing Code
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/06/">
                        
                            <a href="/pages/2/06/" onclick="pageScrollToTop(this)">
                                Code Caves
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/07/">
                        
                            <a href="/pages/2/07/" onclick="pageScrollToTop(this)">
                                Using Code Caves
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/08/">
                        
                            <a href="/pages/2/08/" onclick="pageScrollToTop(this)">
                                Dynamic Memory Allocation
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/09/">
                        
                            <a href="/pages/2/09/" onclick="pageScrollToTop(this)">
                                Defeating DMA
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                            <li class="divider-header">
                                <a>Programming</a>
                            </li>
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/3/01/">
                        
                            <a href="/pages/3/01/" onclick="pageScrollToTop(this)">
                                Programming Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/3/02/">
                        
                            <a href="/pages/3/02/" onclick="pageScrollToTop(this)">
                                External Memory Hack
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/3/03/">
                        
                            <a href="/pages/3/03/" onclick="pageScrollToTop(this)">
                                DLL Memory Hack
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/3/04/">
                        
                            <a href="/pages/3/04/" onclick="pageScrollToTop(this)">
                                Code Caves &amp; DLL&#39;s
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/3/05/">
                        
                            <a href="/pages/3/05/" onclick="pageScrollToTop(this)">
                                Printing Text
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                            <li class="divider-header">
                                <a>RTS/RPG Hacks</a>
                            </li>
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/4/01/">
                        
                            <a href="/pages/4/01/" onclick="pageScrollToTop(this)">
                                Stathack
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/4/02/">
                        
                            <a href="/pages/4/02/" onclick="pageScrollToTop(this)">
                                Map Hack
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/4/03/">
                        
                            <a href="/pages/4/03/" onclick="pageScrollToTop(this)">
                                Macro Bot
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/4/04/">
                        
                            <a href="/pages/4/04/" onclick="pageScrollToTop(this)">
                                Farming Bot
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                            <li class="divider-header">
                                <a>FPS Hacks</a>
                            </li>
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/01/">
                        
                            <a href="/pages/5/01/" onclick="pageScrollToTop(this)">
                                3D Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/02/">
                        
                            <a href="/pages/5/02/" onclick="pageScrollToTop(this)">
                                Wallhack (Memory)
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/03/">
                        
                            <a href="/pages/5/03/" onclick="pageScrollToTop(this)">
                                Wallhack (OpenGL)
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/04/">
                        
                            <a href="/pages/5/04/" onclick="pageScrollToTop(this)">
                                Chams (OpenGL)
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/05/">
                        
                            <a href="/pages/5/05/" onclick="pageScrollToTop(this)">
                                Triggerbot
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/06/">
                        
                            <a href="/pages/5/06/" onclick="pageScrollToTop(this)">
                                Aimbot
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/07/">
                        
                            <a href="/pages/5/07/" onclick="pageScrollToTop(this)">
                                No Recoil
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/08/">
                        
                            <a href="/pages/5/08/" onclick="pageScrollToTop(this)">
                                Radar Hack
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/09/">
                        
                            <a href="/pages/5/09/" onclick="pageScrollToTop(this)">
                                ESP
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/10/">
                        
                            <a href="/pages/5/10/" onclick="pageScrollToTop(this)">
                                Multihack
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                            <li class="divider-header">
                                <a>Multiplayer</a>
                            </li>
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/6/01/">
                        
                            <a href="/pages/6/01/" onclick="pageScrollToTop(this)">
                                Multiplayer Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/6/02/">
                        
                            <a href="/pages/6/02/" onclick="pageScrollToTop(this)">
                                Packet Analysis
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/6/03/">
                        
                            <a href="/pages/6/03/" onclick="pageScrollToTop(this)">
                                Reversing Packets
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/6/04/">
                        
                            <a href="/pages/6/04/" onclick="pageScrollToTop(this)">
                                Creating an External Client
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/6/05/">
                        
                            <a href="/pages/6/05/" onclick="pageScrollToTop(this)">
                                Proxying TCP Traffic
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                            <li class="divider-header">
                                <a>Tool Development</a>
                            </li>
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/7/01/">
                        
                            <a href="/pages/7/01/" onclick="pageScrollToTop(this)">
                                DLL Injector
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/7/02/">
                        
                            <a href="/pages/7/02/" onclick="pageScrollToTop(this)">
                                Pattern Scanner
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/7/03/">
                        
                            <a href="/pages/7/03/" onclick="pageScrollToTop(this)">
                                Memory Scanner
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter active" data-level="1.2" data-path="/pages/7/04/">
                        
                            <a href="/pages/7/04/" onclick="pageScrollToTop(this)">
                                Disassembler
                            </a>
                            
                                
                                    <ul><li><a href="#target" onclick="mobilePageScrollToAnchor(this)" >Target</a></li><li><a href="#overview" onclick="mobilePageScrollToAnchor(this)" >Overview</a></li><li><a href="#disclaimer" onclick="mobilePageScrollToAnchor(this)" >Disclaimer</a></li><li><a href="#instructions" onclick="mobilePageScrollToAnchor(this)" >Instructions</a></li><li><a href="#instruction-set-reference" onclick="mobilePageScrollToAnchor(this)" >Instruction Set Reference</a></li><li><a href="#dumping-a-processs-opcodes" onclick="mobilePageScrollToAnchor(this)" >Dumping a Processâs Opcodes</a></li><li><a href="#the-add-instruction" onclick="mobilePageScrollToAnchor(this)" >The add Instruction</a></li><li><a href="#decoding-operands" onclick="mobilePageScrollToAnchor(this)" >Decoding Operands</a></li><li><a href="#other-instructions" onclick="mobilePageScrollToAnchor(this)" >Other Instructions</a></li><li><a href="#calls-and-jumps" onclick="mobilePageScrollToAnchor(this)" >Calls and Jumps</a></li><li><a href="#final-result" onclick="mobilePageScrollToAnchor(this)" >Final Result</a></li></ul>

                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/7/05/">
                        
                            <a href="/pages/7/05/" onclick="pageScrollToTop(this)">
                                Debugger
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/7/06/">
                        
                            <a href="/pages/7/06/" onclick="pageScrollToTop(this)">
                                Call Logger
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                            <li class="divider-header">
                                <a>Game Resources</a>
                            </li>
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/8/01/">
                        
                            <a href="/pages/8/01/" onclick="pageScrollToTop(this)">
                                Resource Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/8/02/">
                        
                            <a href="/pages/8/02/" onclick="pageScrollToTop(this)">
                                Modifying Save Data
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/8/03/">
                        
                            <a href="/pages/8/03/" onclick="pageScrollToTop(this)">
                                Modifying Textures
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/8/04/">
                        
                            <a href="/pages/8/04/" onclick="pageScrollToTop(this)">
                                Modifying Units
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                
            
                <!-- <p>posts</p> -->
                
                    

                    
                
            
        </ul>

        &nbsp;
    </nav>
</div>
<div class="book-body">
        <div class="book-header" role="navigation">
          <!-- Title -->
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i>
            
            <a href=".">Disassembler</a>
            
          </h1>
        </div>

        <div class="body-inner"><div class="page-wrapper" tabindex="-1" role="main">
    

    <div class="page-inner">
        <div id="book-search-results">
            <div class="search-noresults">
                <section class="normal markdown-section">
                    

                    <h1 id="target">Target</h1>

<p>Our target in this lesson will be Wesnoth 1.14.9.</p>

<h1 id="overview">Overview</h1>

<p>In previous lessons, we used x64dbg to debug and reverse games. When viewing
these games in x64dbg, we are able to see the instructions that the games
are executing. For example, we saw that the following instructions were
responsible for decreasing a playerâs gold when recruiting a unit in
Wesnoth:</p>

<p><img src="/assets/images/7/4/dis1.png" alt="Disassembly" /></p>

<p>From the <a href="/pages/7/02/">Pattern Scanner</a> lesson, we know that these
instructions are all stored as opcodes, which are byte values. The process
of converting these opcodes to instructions is known as disassembly. In
this lesson, we will cover how to create a limited disassembler.</p>

<p>The full source code discussed in this lesson is available on <a href="https://github.com/GameHackingAcademy/Disassembler">github.</a></p>

<h1 id="disclaimer">Disclaimer</h1>

<p>Writing a disassembler is a complex task that takes a large amount of
time. Even supporting a single instruction set in an efficient way takes
many weeks of reading specifications and implementation. The approach
covered here should be used as a starting point, but with the caveat that
the approach will not scale. The main goal for this lesson is to explain how
these concepts work. For an example of a feature-complete disassembler,
check out the <a href="https://www.capstone-engine.org/">Capstone Engine.</a></p>

<h1 id="instructions">Instructions</h1>

<p>For a CPU to understand and execute each opcode encountered, these opcodes
must have a consistent format. Each opcode must be assigned a specific
instruction. For example, we have seen from previous lessons that the opcode
<code class="language-plaintext highlighter-rouge">0xE8</code> always represents a <strong>call</strong> instruction.
This mapping of opcodes to instructions is known as a processorâs
instruction set.</p>

<p>Each CPU can implement a unique instruction set. However, most
Windows-based games are compiled with the expectation that they will be
running on 32-bit, Intel-based processors. These processors typically
implement a version of the x86 instruction set. For Intel processors
specifically, this is referred to as IA-32.</p>

<p>The x86 instruction set is complex and has many different operations.
These operations can also be a different length. For example, in the
screenshot on the page above, we see that the
<strong>mov</strong> instruction on the second line
(<code class="language-plaintext highlighter-rouge">0x7ccd93</code>) is 2 bytes (<code class="language-plaintext highlighter-rouge">0x89C2</code>), whereas the
<strong>mov</strong> instruction on the third line is 6 bytes (<code class="language-plaintext highlighter-rouge">0x8985 78FCFFFF</code>). For the CPU to understand the length of the instruction, this data
must be encoded in the bytes in some way.</p>

<h1 id="instruction-set-reference">Instruction Set Reference</h1>

<p>Imagine you want to create a compiler that will take the following C++
code and produce a binary that can run on an x86-compatible processor:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</code></pre></div></div>

<p>This code could be converted into assembly in multiple ways, such as:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mov</span> <span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="mi">2</span>
</code></pre></div></div>

<p>or</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="mi">2</span>
<span class="n">mov</span> <span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">eax</span>
</code></pre></div></div>

<p>We have seen that there are multiple forms of the
<strong>mov</strong> instruction, with different lengths. As the compiler
developer, we need to know which form to use to produce our binary code.</p>

<p>To solve this problem, companies like Intel release instruction set
references. These contain a full listing of all public instructions and
their associated opcodes, along with other architectural information, such
as how to encode the length of the instruction. The IA-32 reference is
available <a href="https://software.intel.com/content/www/us/en/develop/download/intel-64-and-ia-32-architectures-sdm-combined-volumes-1-2a-2b-2c-2d-3a-3b-3c-3d-and-4.html">here.</a></p>

<p>As we build our disassembler, we will use that reference to understand
instructions. In addition, we will use another reference (<a href="http://ref.x86asm.net/coder64.html">here</a>) to help figure out unknown opcodes and which instruction they are
associated with.</p>

<h1 id="dumping-a-processs-opcodes">Dumping a Processâs Opcodes</h1>

<p>Like in the <a href="/pages/7/02/">Pattern Scanner</a> lesson, our target in
this lesson will be Wesnoth. We will use the same code from that lesson to
locate, attach, and read the gameâs opcodes into a buffer:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">HANDLE</span> <span class="n">process_snapshot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">HANDLE</span> <span class="n">module_snapshot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">PROCESSENTRY32</span> <span class="n">pe32</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
  <span class="n">MODULEENTRY32</span> <span class="n">me32</span><span class="p">;</span>

  <span class="n">DWORD</span> <span class="n">exitCode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="n">pe32</span><span class="p">.</span><span class="n">dwSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PROCESSENTRY32</span><span class="p">);</span>
  <span class="n">me32</span><span class="p">.</span><span class="n">dwSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MODULEENTRY32</span><span class="p">);</span>

  <span class="n">process_snapshot</span> <span class="o">=</span> <span class="n">CreateToolhelp32Snapshot</span><span class="p">(</span><span class="n">TH32CS_SNAPPROCESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">Process32First</span><span class="p">(</span><span class="n">process_snapshot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pe32</span><span class="p">);</span>

  <span class="k">do</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">wcscmp</span><span class="p">(</span><span class="n">pe32</span><span class="p">.</span><span class="n">szExeFile</span><span class="p">,</span> <span class="s">L"wesnoth.exe"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">module_snapshot</span> <span class="o">=</span> <span class="n">CreateToolhelp32Snapshot</span><span class="p">(</span><span class="n">TH32CS_SNAPMODULE</span><span class="p">,</span> <span class="n">pe32</span><span class="p">.</span><span class="n">th32ProcessID</span><span class="p">);</span>

      <span class="n">HANDLE</span> <span class="n">process</span> <span class="o">=</span> <span class="n">OpenProcess</span><span class="p">(</span><span class="n">PROCESS_ALL_ACCESS</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">pe32</span><span class="p">.</span><span class="n">th32ProcessID</span><span class="p">);</span>

      <span class="n">Module32First</span><span class="p">(</span><span class="n">module_snapshot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">me32</span><span class="p">);</span>
      <span class="k">do</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">wcscmp</span><span class="p">(</span><span class="n">me32</span><span class="p">.</span><span class="n">szModule</span><span class="p">,</span> <span class="s">L"wesnoth.exe"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">me32</span><span class="p">.</span><span class="n">modBaseSize</span><span class="p">);</span>
          <span class="n">DWORD</span> <span class="n">bytes_read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

          <span class="n">ReadProcessMemory</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">me32</span><span class="p">.</span><span class="n">modBaseAddr</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">me32</span><span class="p">.</span><span class="n">modBaseSize</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_read</span><span class="p">);</span>

          <span class="c1">// buffer contains the game's opcodes</span>

          <span class="n">free</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

      <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">Module32Next</span><span class="p">(</span><span class="n">module_snapshot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">me32</span><span class="p">));</span>

      <span class="n">CloseHandle</span><span class="p">(</span><span class="n">process</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">Process32Next</span><span class="p">(</span><span class="n">process_snapshot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pe32</span><span class="p">));</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We will validate our disassembler on the same instruction set seen in the
beginning of this lesson (starting at the address <code class="language-plaintext highlighter-rouge">0x7ccd91</code>).
We will also only disassemble <code class="language-plaintext highlighter-rouge">0x50</code> bytesâ worth of
instructions. First, we will simply dump all the opcodes:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define START_ADDRESS 0x7ccd91
</span><span class="p">...</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">START_ADDRESS</span> <span class="o">-</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">me32</span><span class="p">.</span><span class="n">modBaseAddr</span><span class="p">;</span>
<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">START_ADDRESS</span> <span class="o">+</span> <span class="mh">0x50</span> <span class="o">-</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">me32</span><span class="p">.</span><span class="n">modBaseAddr</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"%x"</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="n">i</span><span class="o">++</span><span class="p">;</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Our code above needs to offset <strong>i</strong> in this manner due to
how the opcodes are read into our buffer. Like we saw in the <a href="/pages/7/02/">Pattern Scanner</a> lesson, the gameâs main module is
loaded at address <code class="language-plaintext highlighter-rouge">0x400000</code>. However, this instruction is
stored at position 0 in our buffer. To gain access to the opcodes starting
at <code class="language-plaintext highlighter-rouge">0x7ccd91</code>, we need to determine the distance from
<code class="language-plaintext highlighter-rouge">0x7ccd91</code> to <code class="language-plaintext highlighter-rouge">0x400000</code> and use that position in
our buffer.</p>

<p>When executed, this code will produce the following result:</p>

<p><img src="/assets/images/7/4/dis2.png" alt="Disassembly" /></p>

<p>We can see that these opcodes line up with the values observed in x64dbg.</p>

<h1 id="the-add-instruction">The add Instruction</h1>

<p>Starting at the very top, we see that the first opcode is
<code class="language-plaintext highlighter-rouge">0x01</code>. Looking at our reference site <a href="ref.x86asm.net/coder64.html">here,</a> we see that this is an
<strong>add</strong> instruction:</p>

<p><img src="/assets/images/7/4/dis3.png" alt="Disassembly" /></p>

<p>If we look in section 3.2 of the reference, we can see that this
instruction adds a 32-bit register to a 32-bit register:</p>

<p><img src="/assets/images/7/4/dis4.png" alt="Disassembly" /></p>

<p>We still need to figure out how these registers are encoded, but for now,
we can modify our main loop to print out an
<strong>add</strong> instruction whenever we encounter <code class="language-plaintext highlighter-rouge">0x01</code>.
Since we know that this instruction is 2 bytes, we will increment past the
next opcode when we encounter it as well. We can also add code to print
out the current address of the instruction:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">START_ADDRESS</span> <span class="o">+</span> <span class="mh">0x50</span> <span class="o">-</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">me32</span><span class="p">.</span><span class="n">modBaseAddr</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"%x:</span><span class="se">\t</span><span class="s">"</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">me32</span><span class="p">.</span><span class="n">modBaseAddr</span><span class="p">);</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
    <span class="k">case</span> <span class="mh">0x1</span><span class="p">:</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"ADD "</span><span class="p">);</span>
      <span class="n">i</span><span class="o">++</span><span class="p">;</span>
      <span class="n">i</span><span class="o">++</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"%x"</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
      <span class="n">i</span><span class="o">++</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>When running this code, we will now see that the first
<strong>add</strong> instruction is correctly disassembled:</p>

<p><img src="/assets/images/7/4/dis5.png" alt="Disassembly" /></p>

<h1 id="decoding-operands">Decoding Operands</h1>

<p>After <code class="language-plaintext highlighter-rouge">0x01</code>, the next opcode is <code class="language-plaintext highlighter-rouge">0xD8</code>. We know
that this <code class="language-plaintext highlighter-rouge">0xD8</code> is somehow responsible for encoding the value
of <strong>eax, ebx</strong>. Just like with opcodes, the exact method to
decode this value must exist somewhere in this manual. If we look at the
reference manualâs section 2.1, we see that directly following the opcode
is a <em>ModR/M</em> value that is 1 byte long:</p>

<p><img src="/assets/images/7/4/dis6.png" alt="Disassembly" /></p>

<p>If we scroll down to table 2-2, we can see how this value is laid out:</p>

<p><img src="/assets/images/7/4/dis7.png" alt="Disassembly" /></p>

<p>Finding the value of <code class="language-plaintext highlighter-rouge">0xD8</code>, we see that it is in the
<strong>eax</strong> row and <strong>ebx</strong> column. Since this value
is stored in a consistent manner, we can write a function to retrieve it:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">decode_operand</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">location</span><span class="p">)</span> <span class="p">{</span>

  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>So far, we have seen that operands are 1 byte long, so we will return a
value of 1 to correctly increment the loop. We can call this function from
our main loop:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="mh">0x1</span><span class="p">:</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"ADD "</span><span class="p">);</span>
  <span class="n">i</span><span class="o">++</span><span class="p">;</span>
  <span class="n">i</span> <span class="o">+=</span> <span class="n">decode_operand</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
  <span class="k">break</span><span class="p">;</span>
</code></pre></div></div>

<p>Going back to the table, we can see that we have 8 possible values:
<strong>eax</strong>, <strong>ecx</strong>, <strong>edx</strong>,
<strong>ebx</strong>, <strong>esp</strong>, <strong>ebp</strong>,
<strong>esi</strong>, and <strong>edi</strong>. We can lay these out in an
array of character arrays to reference in our function:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">const</span> <span class="kt">char</span> <span class="n">modrm_value</span><span class="p">[</span><span class="mi">8</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s">"eax"</span><span class="p">,</span>
  <span class="s">"ecx"</span><span class="p">,</span>
  <span class="s">"edx"</span><span class="p">,</span>
  <span class="s">"ebx"</span><span class="p">,</span>
  <span class="s">"esp"</span><span class="p">,</span>
  <span class="s">"ebp"</span><span class="p">,</span>
  <span class="s">"esi"</span><span class="p">,</span>
  <span class="s">"edi"</span>
<span class="p">};</span>
</code></pre></div></div>

<p>If we look at the table, we can see that <strong>eax</strong> will be the
first operand whenever the byte value ends in 0 or 8:</p>

<p><img src="/assets/images/7/4/dis8.png" alt="Disassembly" /></p>

<p>This pattern continues for the other registers as well. For example,
<strong>ecx</strong> always ends in 1 or 9, and <strong>edx</strong> in 2
or A. We can see that these values line up with the remainder when we
divide the operand value by 8. Therefore, we can use the modulo operator
to retrieve our first operand from the <em>ModR/M</em> value:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">modrm_value</span><span class="p">[</span><span class="n">buffer</span><span class="p">[</span><span class="n">location</span><span class="p">]</span> <span class="o">%</span> <span class="mi">8</span><span class="p">]</span>
</code></pre></div></div>

<p>To retrieve the second operand, we can use a similar operation. If we look
at the <em>ModR/M</em> structure, we can see that the first value is stored
at bits 0, 1, and 2:</p>

<p><img src="/assets/images/7/4/dis6.png" alt="Disassembly" /></p>

<p>For example, when converted to binary, <code class="language-plaintext highlighter-rouge">0xD8</code> is represented
as:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">1101</span> <span class="mi">1000</span>
</code></pre></div></div>

<p>For our first operand, we see that the three 000 bits are associated with
the <strong>eax</strong> row. If we then shift these bits to the right, we
get the following value:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mo">0001</span> <span class="mi">1011</span>
</code></pre></div></div>

<p>If we look at the columns on the top of the table, 011 is associated with
the <strong>ebx</strong> column, in the same way as the first operand. As
such, we can use the same approach once we shift the bits to retrieve the
second operand via the modulo operator:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">modrm_value</span><span class="p">[(</span><span class="n">buffer</span><span class="p">[</span><span class="n">location</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">%</span> <span class="mi">8</span><span class="p">]</span>
</code></pre></div></div>

<p>With these two pieces, we can implement our function:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">location</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mh">0xC0</span> <span class="o">&amp;&amp;</span> <span class="n">buffer</span><span class="p">[</span><span class="n">location</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"%s, %s"</span><span class="p">,</span> <span class="n">modrm_value</span><span class="p">[</span><span class="n">buffer</span><span class="p">[</span><span class="n">location</span><span class="p">]</span> <span class="o">%</span> <span class="mi">8</span><span class="p">],</span> <span class="n">modrm_value</span><span class="p">[(</span><span class="n">buffer</span><span class="p">[</span><span class="n">location</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">%</span> <span class="mi">8</span><span class="p">]);</span>
  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Running this code will correctly print the operands for the
<strong>add</strong> operation:</p>

<p><img src="/assets/images/7/4/dis9.png" alt="Disassembly" /></p>

<h1 id="other-instructions">Other Instructions</h1>

<p>Now that we can disassemble the <strong>add</strong> instruction, we can
begin working on other instructions. First, letâs implement the
<strong>mov</strong> instruction at <code class="language-plaintext highlighter-rouge">0x7ccd93</code>:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="mh">0x89</span><span class="p">:</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"MOV "</span><span class="p">);</span>
  <span class="n">i</span><span class="o">++</span><span class="p">;</span>
  <span class="n">i</span> <span class="o">+=</span> <span class="n">decode_operand</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
  <span class="k">break</span><span class="p">;</span>
</code></pre></div></div>

<p>Running this, we can verify that our operand decoding is working
correctly, as <code class="language-plaintext highlighter-rouge">0xC2</code> (the operand associated with the second
move) correctly decodes to <strong>edx, eax</strong>:</p>

<p><img src="/assets/images/7/4/dis10.png" alt="Disassembly" /></p>

<p>However, the next <strong>mov</strong> instruction does not decode
correctly. Despite being the same opcode (<code class="language-plaintext highlighter-rouge">0x89</code>), it has an
operand that we have not seen before, <code class="language-plaintext highlighter-rouge">0x85</code>. If we look at the
table, we see that this is associated with
<strong>[ebp] + displacement</strong>, or an offset. If we look at the
x64dbg version, we can see that this offset is <code class="language-plaintext highlighter-rouge">-0x388</code>. We
know that this value must be encoded somewhere in the instruction. Since
<code class="language-plaintext highlighter-rouge">0x89 85</code> are already accounted for, this value must be in the
<code class="language-plaintext highlighter-rouge">0x78fcffff</code> bytes.</p>

<p>In previous lessons, we talked about endianness, or the order of bytes. We
identified that bytes are stored in a little-endian format. As a result,
we need to reverse these bytes:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">FF</span> <span class="n">FF</span> <span class="n">FC</span> <span class="mi">78</span>
</code></pre></div></div>

<p>This value does not match <code class="language-plaintext highlighter-rouge">0x388</code>. This is due to the signed
nature of the value. Since this is a negative value, we need to subtract
the maximum value of an integer (<code class="language-plaintext highlighter-rouge">0xFF FF FF FF</code>) to get the
correct value:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">FF</span> <span class="n">FF</span> <span class="n">FF</span> <span class="n">FF</span> <span class="o">-</span>
<span class="n">FF</span> <span class="n">FF</span> <span class="n">FC</span> <span class="mi">78</span> <span class="o">=</span>
<span class="mi">387</span>
</code></pre></div></div>

<p>We then need to add 1 to account for the sign change, resulting in the
correct value of <code class="language-plaintext highlighter-rouge">-0x388</code>.</p>

<p>Since we now understand how this is working, we can add this to our decode
operation:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">location</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mh">0x80</span> <span class="o">&amp;&amp;</span> <span class="n">buffer</span><span class="p">[</span><span class="n">location</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mh">0xBF</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">DWORD</span> <span class="n">displacement</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="n">location</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">location</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">location</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">location</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"[%s+%x], %s"</span><span class="p">,</span> <span class="n">modrm_value</span><span class="p">[</span><span class="n">buffer</span><span class="p">[</span><span class="n">location</span><span class="p">]</span> <span class="o">%</span> <span class="mi">8</span><span class="p">],</span> <span class="n">displacement</span><span class="p">,</span> <span class="n">modrm_value</span><span class="p">[(</span><span class="n">buffer</span><span class="p">[</span><span class="n">location</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">%</span> <span class="mi">8</span><span class="p">]);</span>
  <span class="k">return</span> <span class="mi">5</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Like we saw with the first decoding operation, we can use bit shifting to
retrieve each of the bytes in the displacement. With this included, the
third operation now correctly decodes:</p>

<p><img src="/assets/images/7/4/dis11.png" alt="Disassembly" /></p>

<h1 id="calls-and-jumps">Calls and Jumps</h1>

<p>In previous lessons, we covered how the opcode for a call or jmp used the
following formula:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">E8</span><span class="o">/</span><span class="n">E9</span> <span class="p">(</span><span class="n">new_location</span> <span class="o">-</span> <span class="n">original_location</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span>
</code></pre></div></div>

<p>We can reverse this operation to retrieve the address of a
<strong>call</strong> from an opcode:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="mh">0xE8</span><span class="p">:</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"CALL "</span><span class="p">);</span>
  <span class="n">i</span><span class="o">++</span><span class="p">;</span>
  <span class="n">loc</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"%x"</span><span class="p">,</span> <span class="n">loc</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">me32</span><span class="p">.</span><span class="n">modBaseAddr</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
  <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
  <span class="k">break</span><span class="p">;</span>
</code></pre></div></div>

<p>We add 4 instead of 5 to account for the fact that our parser is past the
<code class="language-plaintext highlighter-rouge">0xE8</code> byte.</p>

<p>We also have a short relative jump if equal (<strong>je</strong>)
instruction in our selected example. In this case, we can observe that the
second byte of the opcode contains the amount to offset by:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">7</span><span class="n">ccda8</span>    <span class="mi">74</span> <span class="mi">23</span>   <span class="n">je</span> <span class="mi">7</span><span class="n">ccdcd</span>
<span class="mi">7</span><span class="n">ccda8</span> <span class="o">+</span> <span class="mi">23</span> <span class="o">=</span> <span class="mi">7</span><span class="n">ccdcd</span>
</code></pre></div></div>

<p>We can add this logic to our main loop as well:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="mh">0x74</span><span class="p">:</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"JE "</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"%x"</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">me32</span><span class="p">.</span><span class="n">modBaseAddr</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">buffer</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
  <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="k">break</span><span class="p">;</span>
</code></pre></div></div>

<h1 id="final-result">Final Result</h1>

<p>As stated in the disclaimer, this was not a comprehensive disassembler. In
the source linked on github, the following opcodes are implemented:</p>

<ul>
  <li><strong>ADD</strong> (<code class="language-plaintext highlighter-rouge">0x01</code>)</li>
  <li><strong>MOV</strong> (<code class="language-plaintext highlighter-rouge">0x89</code>, <code class="language-plaintext highlighter-rouge">0x8B</code>)</li>
  <li><strong>SUB</strong> (<code class="language-plaintext highlighter-rouge">0x29</code>)</li>
  <li><strong>JE</strong> (<code class="language-plaintext highlighter-rouge">0x74</code>)</li>
  <li><strong>CALL</strong> (<code class="language-plaintext highlighter-rouge">0xE8</code>)</li>
  <li><strong>CMP</strong> (<code class="language-plaintext highlighter-rouge">0x80</code>)</li>
  <li><strong>LEA</strong> (<code class="language-plaintext highlighter-rouge">0x8D</code>)</li>
</ul>

<p>With these instructions, we retrieve back the following result:</p>

<p><img src="/assets/images/7/4/dis12.png" alt="Disassembly" /></p>

<p>Â </p>


                </section>
            </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div></div>
    </div>
</div>

<!-- introduce mathjax support -->
<script>
window.MathJax = {
  tex: {
    inlineMath: [ ['$', '$'], ['\\(', '\\)'] ]
  },
  svg: {
    fontCache: 'global'
  }
};
</script>
<script
  type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
</script>


<!-- introduce per-page mermaid support -->


          <a
            href="/pages/7/03/"
            class="navigation navigation-prev navigation-unique"
            aria-label="Previous page: Memory Scanner"
          >
            <i class="fa fa-angle-left"></i>
          </a>
           
          <a
            href="/pages/7/05/"
            class="navigation navigation-next navigation-unique"
            aria-label="Next page: Debugger"
          >
            <i class="fa fa-angle-right"></i>
          </a>
          
        </div>
      </div>

      <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({
    "page": {
        "title": "Introduction",
        "level": "1.1",
        "depth": 1,
        
        "next": {
            "title": "Debugger",
            "level": "1.2",
            "depth": 1,
            "path": "_pages/7/05.md",
            "ref": "_pages/7/05.md",
            "articles": []
        },
        
        "dir": "ltr"
    },    "config": {
        "plugins": ["fontsettings", "highlight", "livereload", "lunr", "search", "sharing", "theme-default", "livereload"],
        "styles": {
            "ebook": "styles/ebook.css",
            "epub": "styles/epub.css",
            "mobi": "styles/mobi.css",
            "pdf": "styles/pdf.css",
            "print": "styles/print.css",
            "website": "styles/website.css"
        },
        "pluginsConfig": {
            "fontsettings": {
                "family": "sans",
                "size": 2,
                "theme": "white"
            },
            "highlight": {},
            "livereload": {},
            "lunr": {
                "ignoreSpecialCharacters": false,
                "maxIndexSize": 1000000
            },
            "search": {},            "sharing": {
                "facebook": false,

                "google": false,

                "github": true,
                "github_link": "https://github.com/GameHackingAcademy",

                "telegram": false,
                "telegram_link": "https://t.me",

                "instapaper": false,

                "twitter": true,
                "twitter_link": "https://twitter.com/GameHackingAcad",

                "vk": false,

                "weibo": false
            },
"theme-default": {
                "showLevel": false,
                "styles": {
                    "ebook": "styles/ebook.css",
                    "epub": "styles/epub.css",
                    "mobi": "styles/mobi.css",
                    "pdf": "styles/pdf.css",
                    "print": "styles/print.css",
                    "website": "styles/website.css"
                }
            }
        },
        "theme": "default",
        "author": "Tao He",
        "pdf": {
            "pageNumbers": true,
            "fontSize": 12,
            "fontFamily": "Arial",
            "paperSize": "a4",
            "chapterMark": "pagebreak",
            "pageBreaksBefore": "/",
            "margin": {
                "right": 62,
                "left": 62,
                "top": 56,
                "bottom": 56
            }
        },
        "structure": {
            "langs": "LANGS.md",
            "readme": "README.md",
        },
        "variables": {},
        "title": "Game Hacking Academy",
        "language": "en",
        "gitbook": "*"
    },
    "file": {
        "path": "_pages/7/04.md",
        "mtime": "2023-12-25 00:00:00 -0600",
        "type": "markdown"
    },
    "gitbook": {
        "version": "3.2.3",
        "time": "2023-12-31 12:09:34 -0600"
    },
    "basePath": "",
    "book": {
        "language": ""
    }
});
        });
      </script>
    </div><script src="/assets/gitbook/gitbook.js"></script>
<script src="/assets/gitbook/theme.js"></script>

<script src="/assets/gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
<script src="/assets/gitbook/gitbook-plugin-sharing/buttons.js"></script>

<!-- <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
<script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
<script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
<script src="../gitbook/gitbook-plugin-search/search.js"></script> -->

<script src="/assets/gitbook/gitbook-plugin-search-pro/jquery.mark.min.js"></script>
<script src="/assets/gitbook/gitbook-plugin-search-pro/search.js"></script>
<script src="/assets/gitbook/gitbook-plugin-back-to-top-button/plugin.js"></script>
<script src="/assets/gitbook/gitbook-plugin-copy-code-button/toggle.js"></script>

<!-- trackers --><!-- google analytics --><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-160704775-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-160704775-1');
</script>
<script>
      particlesJS("particles-js", {
        particles: {
          number: {
            value: 20,
            density: {
              enable: true,
              value_area: 100,
            },
          },
          color: {
            value: "#6195b9",
          },
          shape: {
            type: "edge",
          },
          opacity: {
            value: 0.3,
            anim: {
              enable: true,
              speed: 0.1,
              opacity_min: 0,
              sync: false,
            },
          },
          size: {
            value: 15,
            random: true,
          },
          line_linked: {
            enable: false,
          },
          move: {
            enable: true,
            speed: 0.5,
            direction: "top",
            random: true,
            straight: true,
            out_mode: "out",
            bounce: false,
            attract: {
              enable: false,
            },
          },
        },
        interactivity: {
          detect_on: "canvas",
          events: {
            onhover: {
              enable: false,
            },
            onclick: {
              enable: false,
            },
            resize: true,
          },
        },
      });
    </script>
  </body>
</html>

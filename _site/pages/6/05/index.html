<!DOCTYPE html>
<html lang="en">
  <head><meta charset="UTF-8">
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"><title>Proxying TCP Traffic · Game Hacking Academy</title><meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="description" content="Game hacking tutorials and lessons.
"><meta name="generator" content="Jekyll (using style of GitBook 3.2.3)"><meta name="author" content="attilathedud"><link rel="stylesheet" href="/assets/gitbook/style.css">
<link rel="stylesheet" href="/assets/gitbook/gitbook-plugin-fontsettings/website.css">
<link rel="stylesheet" href="/assets/gitbook/gitbook-plugin-search-pro/search.css">
<link rel="stylesheet" href="/assets/gitbook/gitbook-plugin-back-to-top-button/plugin.css">

<link rel="stylesheet" href="/assets/gitbook/rouge/base16.css">

<link rel="stylesheet" href="/assets/gitbook/custom.css">
<link rel="stylesheet" href="/assets/gitbook/custom-local.css">

<meta name="HandheldFriendly" content="true"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="/assets/gitbook/images/apple-touch-icon-precomposed-152.png">
<link rel="shortcut icon" href="/assets/images/favicon.ico" type="image/x-icon">

<script src="/assets/particles.min.js"></script>

<style>
    @media screen and (min-width: 1101px) {
      .eyecandy {
        position: fixed;
        bottom: 0;
        right: 0;
        min-height: 50%;
        height: 50%;
        width: 25%;
        pointer-events: none;
        z-index: 1;
      }
    }
    @media screen and (max-width: 1100px) {
      .eyecandy {
        display: none;
      }
    }
  </style>






    <link rel="prev" href="/pages/6/04/" />
     
    <link rel="next" href="/pages/7/01/" />
    
    
  </head>
  <body>
    <div id="particles-js" class="eyecandy"></div>

    <div class="book color-theme-2"><div class="book-summary">
    <script type="text/javascript">
        // Fixes the page links scroll problem on both desktop and mobile browsers
        function pageScrollToTop(element) {
            // both mobile and non-mobile
            $('div.body-inner').animate({scrollTop: 0});
            $(element).parent().find('li>ul>li').removeClass('active');
            return true;  // propagate
        }
        // Fixes the anchor links scroll problem on mobile browsers
        function mobilePageScrollToAnchor(element) {
            $(element).closest('li.chapter').find('ul>li').removeClass('active');
            $(element).parent().addClass('active');
            if ($(document).width() <= 1240) {
                $('div.body-inner').animate({scrollTop: $($(element).attr('href')).get(0).offsetTop});
            }
            return true;
        }
    </script>

    <nav role="navigation">
        <div id="book-search-input" role="search">
            <input type="text" placeholder="Type to search" />
        </div>
        <div id="book-search-input-link" role="search">
            <a href="/assets/search.html">Click to Search</a>
        </div>
        <ul class="summary">
            
                <!-- <p>pages</p> -->
                
                    

                    
                        
                        <li class="chapter" data-level="1.1" data-path="/">
                        
                            <a href="/" onclick="pageScrollToTop(this)">
                                About
                            </a>
                            
                                
                            
                        </li>
                        
                        
                            <li class="divider-header">
                                <a>Basics</a>
                            </li>
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/1/01/">
                        
                            <a href="/pages/1/01/" onclick="pageScrollToTop(this)">
                                Computer Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/1/02/">
                        
                            <a href="/pages/1/02/" onclick="pageScrollToTop(this)">
                                Game Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/1/03/">
                        
                            <a href="/pages/1/03/" onclick="pageScrollToTop(this)">
                                Hacking Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/1/04/">
                        
                            <a href="/pages/1/04/" onclick="pageScrollToTop(this)">
                                Setting Up a VM
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/1/05/">
                        
                            <a href="/pages/1/05/" onclick="pageScrollToTop(this)">
                                Memory Hack
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                            <li class="divider-header">
                                <a>Debugging & Reversing</a>
                            </li>
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/01/">
                        
                            <a href="/pages/2/01/" onclick="pageScrollToTop(this)">
                                Debugging Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/02/">
                        
                            <a href="/pages/2/02/" onclick="pageScrollToTop(this)">
                                Assembly Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/03/">
                        
                            <a href="/pages/2/03/" onclick="pageScrollToTop(this)">
                                Using Breakpoints
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/04/">
                        
                            <a href="/pages/2/04/" onclick="pageScrollToTop(this)">
                                Changing Game Code
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/05/">
                        
                            <a href="/pages/2/05/" onclick="pageScrollToTop(this)">
                                Reversing Code
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/06/">
                        
                            <a href="/pages/2/06/" onclick="pageScrollToTop(this)">
                                Code Caves
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/07/">
                        
                            <a href="/pages/2/07/" onclick="pageScrollToTop(this)">
                                Using Code Caves
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/08/">
                        
                            <a href="/pages/2/08/" onclick="pageScrollToTop(this)">
                                Dynamic Memory Allocation
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/2/09/">
                        
                            <a href="/pages/2/09/" onclick="pageScrollToTop(this)">
                                Defeating DMA
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                            <li class="divider-header">
                                <a>Programming</a>
                            </li>
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/3/01/">
                        
                            <a href="/pages/3/01/" onclick="pageScrollToTop(this)">
                                Programming Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/3/02/">
                        
                            <a href="/pages/3/02/" onclick="pageScrollToTop(this)">
                                External Memory Hack
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/3/03/">
                        
                            <a href="/pages/3/03/" onclick="pageScrollToTop(this)">
                                DLL Memory Hack
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/3/04/">
                        
                            <a href="/pages/3/04/" onclick="pageScrollToTop(this)">
                                Code Caves &amp; DLL&#39;s
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/3/05/">
                        
                            <a href="/pages/3/05/" onclick="pageScrollToTop(this)">
                                Printing Text
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                            <li class="divider-header">
                                <a>RTS/RPG Hacks</a>
                            </li>
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/4/01/">
                        
                            <a href="/pages/4/01/" onclick="pageScrollToTop(this)">
                                Stathack
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/4/02/">
                        
                            <a href="/pages/4/02/" onclick="pageScrollToTop(this)">
                                Map Hack
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/4/03/">
                        
                            <a href="/pages/4/03/" onclick="pageScrollToTop(this)">
                                Macro Bot
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/4/04/">
                        
                            <a href="/pages/4/04/" onclick="pageScrollToTop(this)">
                                Farming Bot
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                            <li class="divider-header">
                                <a>FPS Hacks</a>
                            </li>
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/01/">
                        
                            <a href="/pages/5/01/" onclick="pageScrollToTop(this)">
                                3D Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/02/">
                        
                            <a href="/pages/5/02/" onclick="pageScrollToTop(this)">
                                Wallhack (Memory)
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/03/">
                        
                            <a href="/pages/5/03/" onclick="pageScrollToTop(this)">
                                Wallhack (OpenGL)
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/04/">
                        
                            <a href="/pages/5/04/" onclick="pageScrollToTop(this)">
                                Chams (OpenGL)
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/05/">
                        
                            <a href="/pages/5/05/" onclick="pageScrollToTop(this)">
                                Triggerbot
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/06/">
                        
                            <a href="/pages/5/06/" onclick="pageScrollToTop(this)">
                                Aimbot
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/07/">
                        
                            <a href="/pages/5/07/" onclick="pageScrollToTop(this)">
                                No Recoil
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/08/">
                        
                            <a href="/pages/5/08/" onclick="pageScrollToTop(this)">
                                Radar Hack
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/09/">
                        
                            <a href="/pages/5/09/" onclick="pageScrollToTop(this)">
                                ESP
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/5/10/">
                        
                            <a href="/pages/5/10/" onclick="pageScrollToTop(this)">
                                Multihack
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                            <li class="divider-header">
                                <a>Multiplayer</a>
                            </li>
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/6/01/">
                        
                            <a href="/pages/6/01/" onclick="pageScrollToTop(this)">
                                Multiplayer Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/6/02/">
                        
                            <a href="/pages/6/02/" onclick="pageScrollToTop(this)">
                                Packet Analysis
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/6/03/">
                        
                            <a href="/pages/6/03/" onclick="pageScrollToTop(this)">
                                Reversing Packets
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/6/04/">
                        
                            <a href="/pages/6/04/" onclick="pageScrollToTop(this)">
                                Creating an External Client
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter active" data-level="1.2" data-path="/pages/6/05/">
                        
                            <a href="/pages/6/05/" onclick="pageScrollToTop(this)">
                                Proxying TCP Traffic
                            </a>
                            
                                
                                    <ul><li><a href="#target" onclick="mobilePageScrollToAnchor(this)" >Target</a></li><li><a href="#overview" onclick="mobilePageScrollToAnchor(this)" >Overview</a></li><li><a href="#reason-for-proxying" onclick="mobilePageScrollToAnchor(this)" >Reason for Proxying</a></li><li><a href="#proxying-traffic" onclick="mobilePageScrollToAnchor(this)" >Proxying Traffic</a></li><li><a href="#listening-for-client-traffic" onclick="mobilePageScrollToAnchor(this)" >Listening for Client Traffic</a></li><li><a href="#sending-traffic-to-server" onclick="mobilePageScrollToAnchor(this)" >Sending Traffic to Server</a></li><li><a href="#relaying-traffic" onclick="mobilePageScrollToAnchor(this)" >Relaying Traffic</a></li></ul>

                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                            <li class="divider-header">
                                <a>Tool Development</a>
                            </li>
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/7/01/">
                        
                            <a href="/pages/7/01/" onclick="pageScrollToTop(this)">
                                DLL Injector
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/7/02/">
                        
                            <a href="/pages/7/02/" onclick="pageScrollToTop(this)">
                                Pattern Scanner
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/7/03/">
                        
                            <a href="/pages/7/03/" onclick="pageScrollToTop(this)">
                                Memory Scanner
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/7/04/">
                        
                            <a href="/pages/7/04/" onclick="pageScrollToTop(this)">
                                Disassembler
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/7/05/">
                        
                            <a href="/pages/7/05/" onclick="pageScrollToTop(this)">
                                Debugger
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/7/06/">
                        
                            <a href="/pages/7/06/" onclick="pageScrollToTop(this)">
                                Call Logger
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                            <li class="divider-header">
                                <a>Game Resources</a>
                            </li>
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/8/01/">
                        
                            <a href="/pages/8/01/" onclick="pageScrollToTop(this)">
                                Resource Fundamentals
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/8/02/">
                        
                            <a href="/pages/8/02/" onclick="pageScrollToTop(this)">
                                Modifying Save Data
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/8/03/">
                        
                            <a href="/pages/8/03/" onclick="pageScrollToTop(this)">
                                Modifying Textures
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pages/8/04/">
                        
                            <a href="/pages/8/04/" onclick="pageScrollToTop(this)">
                                Modifying Units
                            </a>
                            
                                
                            
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    
                
            
                <!-- <p>posts</p> -->
                
                    

                    
                
            
        </ul>

        &nbsp;
    </nav>
</div>
<div class="book-body">
        <div class="book-header" role="navigation">
          <!-- Title -->
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i>
            
            <a href=".">Proxying TCP Traffic</a>
            
          </h1>
        </div>

        <div class="body-inner"><div class="page-wrapper" tabindex="-1" role="main">
    

    <div class="page-inner">
        <div id="book-search-results">
            <div class="search-noresults">
                <section class="normal markdown-section">
                    

                    <h1 id="target">Target</h1>

<p>Our target in this lesson will be Wesnoth 1.14.9.</p>

<h1 id="overview">Overview</h1>

<p>In the previous lesson, we created an external client that would connect to a
Wesnoth server and listen for and respond to specific chat messages. A
major downside to this approach is that we had to reverse the entire
authentication process so that our client could connect to the server. Our
goal in this lesson is to create a proxy. This will allow us to use a regular
game client and only intercept and modify the traffic we care about from
the client.</p>

<h1 id="reason-for-proxying">Reason for Proxying</h1>

<p>The best way to understand our purpose for creating a proxy is to observe
the network traffic when connecting to a server with two clients on the
same host. On your lesson machine, start a Wesnoth server and connect to it
with a legitimate copy of the game. Next, modify the client that we wrote
in the previous lesson and remove all the authentication. Instead, have it
simply send a chat message:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>
<span class="n">freeaddrinfo</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="n">ConnectSocket</span> <span class="o">==</span> <span class="n">INVALID_SOCKET</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"Unable to connect to server!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="n">WSACleanup</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">first_message</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"[message]</span><span class="se">\n</span><span class="s">message=</span><span class="se">\"</span><span class="s">ChatBot connected</span><span class="se">\"\n</span><span class="s">room=</span><span class="se">\"</span><span class="s">lobby</span><span class="se">\"\n</span><span class="s">sender=</span><span class="se">\"</span><span class="s">ChatBot</span><span class="se">\"\n</span><span class="s">[/message]"</span><span class="p">;</span>
<span class="n">send_data</span><span class="p">(</span><span class="n">first_message</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">first_message</span><span class="p">),</span> <span class="n">ConnectSocket</span><span class="p">);</span>
<span class="p">...</span>
</code></pre></div></div>

<p>Finally, open up Wireshark and start monitoring for traffic on the local
adapter, as we have discussed in previous lessons. When you start the
modified external client, you should see the following error on the
server:</p>

<p><img src="/assets/images/6/5/proxy1.png" alt="Failed handshake" /></p>

<p>We are familiar with this error from our initial analysis, so we know that
it occurs when we do not provide a valid handshake. Even though both our
game and external client are running on the same machine, they have
different sockets and are treated as completely separate connections by
the server:</p>

<p><img src="/assets/images/6/5/proxy2.png" alt="Failed handshake" /></p>

<p>If we examine the Wireshark traffic from the game client and our external
client, we can observe this behavior. While the game is busy sending
traffic on port 51120, we can see the TCP handshake of our external client
on port 51123:</p>

<p><img src="/assets/images/6/5/proxy3.png" alt="Failed handshake" /></p>

<p>If we want to intercept and modify a game’s client traffic, we will need
to use a different approach.</p>

<h1 id="proxying-traffic">Proxying Traffic</h1>

<p>When using TCP, we know that a connection is established between a client
and server after completing a handshake. To intercept and inject our own
traffic into this connection, the easiest approach is to be a
man-in-the-middle (MitM) of this connection.</p>

<p>At this position, we can modify requests from the client before they are
sent to the server, as well as responses from the server before they are
sent to the client. This is commonly known as a proxy, or an agent that
simply relays traffic from a source to a destination. A visualization of
this model is shown below:</p>

<p><img src="/assets/images/6/5/proxy4.png" alt="Failed handshake" /></p>

<p>The key to this model is that our proxy is acting as the server to the
client and the client to the server. This means that the server completes
a handshake with our proxy, allowing us to inject whatever traffic we
want. Since we are forwarding legitimate traffic from the client, we do
not need to reverse traffic (such as the authentication mechanism) because
the client will handle that for us.</p>

<p>A proxy consists of three main sections of code:</p>
<ol>
  <li>A socket to listen for client traffic</li>
  <li>A socket to send traffic to the server</li>
  <li>Logic to relay traffic from the client to the server and the server to
the client</li>
</ol>

<p>To simplify this lesson, we will create a proxy that will respond to the
\wave event, identical to the external client we wrote in the previous
lab. For these operations, the Wesnoth client must send data to the server
for the server to respond. When using a proxy for other operations,
additional logic will need to be added in to pass server traffic to the
client.</p>

<p>The full code for this lesson is available on <a href="https://github.com/GameHackingAcademy/Wesnoth_Proxy/">github.</a></p>

<h1 id="listening-for-client-traffic">Listening for Client Traffic</h1>

<p>To listen for client traffic, we will create a listen socket. Once we
receive a connection, we will establish a connection with the client. To
do this, we can build off the <a href="https://docs.microsoft.com/en-us/windows/win32/winsock/complete-server-code">Microsoft server example:</a></p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define DEFAULT_PORT "27015"
</span>
<span class="n">WSADATA</span> <span class="n">wsaData</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">iResult</span><span class="p">;</span>

<span class="n">SOCKET</span> <span class="n">ListenSocket</span> <span class="o">=</span> <span class="n">INVALID_SOCKET</span><span class="p">;</span>
<span class="n">SOCKET</span> <span class="n">ClientSocket</span> <span class="o">=</span> <span class="n">INVALID_SOCKET</span><span class="p">;</span>

<span class="k">struct</span> <span class="nc">addrinfo</span><span class="o">*</span> <span class="n">result</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
<span class="n">hints</span><span class="p">;</span>

<span class="n">iResult</span> <span class="o">=</span> <span class="n">WSAStartup</span><span class="p">(</span><span class="n">MAKEWORD</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">wsaData</span><span class="p">);</span>

<span class="n">ZeroMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hints</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hints</span><span class="p">));</span>
<span class="n">hints</span><span class="p">.</span><span class="n">ai_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
<span class="n">hints</span><span class="p">.</span><span class="n">ai_socktype</span> <span class="o">=</span> <span class="n">SOCK_STREAM</span><span class="p">;</span>
<span class="n">hints</span><span class="p">.</span><span class="n">ai_protocol</span> <span class="o">=</span> <span class="n">IPPROTO_TCP</span><span class="p">;</span>
<span class="n">hints</span><span class="p">.</span><span class="n">ai_flags</span> <span class="o">=</span> <span class="n">AI_PASSIVE</span><span class="p">;</span>

<span class="n">iResult</span> <span class="o">=</span> <span class="n">getaddrinfo</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">DEFAULT_PORT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hints</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>
<span class="n">ListenSocket</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">result</span><span class="o">-&gt;</span><span class="n">ai_family</span><span class="p">,</span> <span class="n">result</span><span class="o">-&gt;</span><span class="n">ai_socktype</span><span class="p">,</span> <span class="n">result</span><span class="o">-&gt;</span><span class="n">ai_protocol</span><span class="p">);</span>
<span class="n">iResult</span> <span class="o">=</span> <span class="n">bind</span><span class="p">(</span><span class="n">ListenSocket</span><span class="p">,</span> <span class="n">result</span><span class="o">-&gt;</span><span class="n">ai_addr</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">result</span><span class="o">-&gt;</span><span class="n">ai_addrlen</span><span class="p">);</span>
<span class="n">freeaddrinfo</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>

<span class="n">iResult</span> <span class="o">=</span> <span class="n">listen</span><span class="p">(</span><span class="n">ListenSocket</span><span class="p">,</span> <span class="n">SOMAXCONN</span><span class="p">);</span>
<span class="n">ClientSocket</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">ListenSocket</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="n">closesocket</span><span class="p">(</span><span class="n">ListenSocket</span><span class="p">);</span>
</code></pre></div></div>

<p>This will create a socket on port 27015 that will accept a single
connection.</p>

<h1 id="sending-traffic-to-server">Sending Traffic to Server</h1>

<p>For sending traffic to the server, we can build off the code that we
already discussed in the previous lesson:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">SOCKET</span> <span class="n">ServerSocket</span> <span class="o">=</span> <span class="n">INVALID_SOCKET</span><span class="p">;</span>

<span class="n">ZeroMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hints</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hints</span><span class="p">));</span>
<span class="n">hints</span><span class="p">.</span><span class="n">ai_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
<span class="n">hints</span><span class="p">.</span><span class="n">ai_socktype</span> <span class="o">=</span> <span class="n">SOCK_STREAM</span><span class="p">;</span>
<span class="n">hints</span><span class="p">.</span><span class="n">ai_protocol</span> <span class="o">=</span> <span class="n">IPPROTO_TCP</span><span class="p">;</span>

<span class="n">iResult</span> <span class="o">=</span> <span class="n">getaddrinfo</span><span class="p">(</span><span class="s">"127.0.0.1"</span><span class="p">,</span> <span class="s">"15000"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hints</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>
<span class="n">ServerSocket</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">result</span><span class="o">-&gt;</span><span class="n">ai_family</span><span class="p">,</span> <span class="n">result</span><span class="o">-&gt;</span><span class="n">ai_socktype</span><span class="p">,</span> <span class="n">result</span><span class="o">-&gt;</span><span class="n">ai_protocol</span><span class="p">);</span>
<span class="n">iResult</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="n">ServerSocket</span><span class="p">,</span> <span class="n">result</span><span class="o">-&gt;</span><span class="n">ai_addr</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">result</span><span class="o">-&gt;</span><span class="n">ai_addrlen</span><span class="p">);</span>
<span class="n">freeaddrinfo</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
</code></pre></div></div>

<p>Like we discussed above, our proxy will forward client packets to the
server and server packets to the client. However, not all client packets
will require a response from the server. For example, in Wesnoth, sending
a chat message does not require a response back. To ensure that our proxy
does not get stuck waiting for a server response, we need to set a timeout
on the server socket. This timeout will cause any
<strong>recv</strong> calls to fail after a set amount of time:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DWORD</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
<span class="n">setsockopt</span><span class="p">(</span><span class="n">ServerSocket</span><span class="p">,</span> <span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">SO_RCVTIMEO</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">timeout</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">timeout</span><span class="p">));</span>
</code></pre></div></div>

<h1 id="relaying-traffic">Relaying Traffic</h1>

<p>With both of our sockets created, we can now focus on relaying the traffic
between the client and server. Since Wesnoth does not send out server
responses unless a client sends a request, our proxy can be simplified to
the following events:</p>

<ol>
  <li>Wait for a request from the client.</li>
  <li>Send that request to the server.</li>
  <li>Wait for a response from the server.</li>
  <li>If a response comes back, send to the client. Otherwise, start waiting
for the next client request.</li>
</ol>

<p>After each event, our program will sleep for a short period to ensure that
the traffic between the client and server does not get desynchronized.
First, we will wait for a request from the client:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define DEFAULT_BUFLEN 512
</span>
<span class="kt">int</span> <span class="n">iSendResult</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">recvbuf</span><span class="p">[</span><span class="n">DEFAULT_BUFLEN</span><span class="p">];</span>
<span class="kt">int</span> <span class="n">recvbuflen</span> <span class="o">=</span> <span class="n">DEFAULT_BUFLEN</span><span class="p">;</span>

<span class="k">do</span> <span class="p">{</span>
  <span class="n">iResult</span> <span class="o">=</span> <span class="n">recv</span><span class="p">(</span><span class="n">ClientSocket</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">recvbuf</span><span class="p">,</span> <span class="n">recvbuflen</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">Sleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
</code></pre></div></div>

<p>If we retrieve a request, we pass this data to the server:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">iResult</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"Bytes received: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">iResult</span><span class="p">);</span>

  <span class="n">iSendResult</span> <span class="o">=</span> <span class="n">send</span><span class="p">(</span><span class="n">ServerSocket</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">recvbuf</span><span class="p">,</span> <span class="n">iResult</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">Sleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"Bytes sent: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">iSendResult</span><span class="p">);</span>
</code></pre></div></div>

<p>Next, we wait for a response from the server. If a response actually comes
back, we forward this on to the client:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">iResult</span> <span class="o">=</span> <span class="n">recv</span><span class="p">(</span><span class="n">ServerSocket</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">recvbuf</span><span class="p">,</span> <span class="n">recvbuflen</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">Sleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">iResult</span> <span class="o">!=</span> <span class="n">SOCKET_ERROR</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">iSendResult</span> <span class="o">=</span> <span class="n">send</span><span class="p">(</span><span class="n">ClientSocket</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">recvbuf</span><span class="p">,</span> <span class="n">iResult</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">Sleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Finally, we continue the loop while we have a result, or if we have a
timeout from the server:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">iResult</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">WSAGetLastError</span><span class="p">()</span> <span class="o">==</span> <span class="n">WSAETIMEDOUT</span><span class="p">);</span>
</code></pre></div></div>

<p>At this point, our proxy will properly pass traffic from a client to a
server. We can verify this by running the proxy, connecting to it in
Wesnoth by setting the server to localhost:27015, and confirming that we
can connect to the actual server running on localhost:15000.</p>

<p>As a proof-of-concept, we can now add in logic to intercept and modify
traffic. First, we can import our <strong>parse_data</strong> and
<strong>send_data</strong> functions from our last lesson. Next, we will
modify our main loop to check any client requests and see if they contain
the chat message <strong>\wave</strong>. If so, we will send an additional
packet with a <strong>Hello!</strong> message:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">iResult</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"Bytes received: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">iResult</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">parse_data</span><span class="p">(</span><span class="n">recvbuf</span><span class="p">,</span> <span class="n">iResult</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">message</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"[message]</span><span class="se">\n</span><span class="s">message=</span><span class="se">\"</span><span class="s">Hello!</span><span class="se">\"\n</span><span class="s">room=</span><span class="se">\"</span><span class="s">lobby</span><span class="se">\"\n</span><span class="s">sender=</span><span class="se">\"</span><span class="s">ChatBot</span><span class="se">\"\n</span><span class="s">[/message]"</span><span class="p">;</span>
    <span class="n">send_data</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">message</span><span class="p">),</span> <span class="n">ServerSocket</span><span class="p">);</span>
    <span class="n">Sleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>If you connect to the proxy now and send the chat message
<strong>\wave</strong>, you will see that an additional message appears on
the server, indicating that we successfully injected traffic into the
connection:</p>

<p><img src="/assets/images/6/5/proxy5.png" alt="Failed handshake" /></p>

<p> </p>


                </section>
            </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div></div>
    </div>
</div>

<!-- introduce mathjax support -->
<script>
window.MathJax = {
  tex: {
    inlineMath: [ ['$', '$'], ['\\(', '\\)'] ]
  },
  svg: {
    fontCache: 'global'
  }
};
</script>
<script
  type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
</script>


<!-- introduce per-page mermaid support -->


          <a
            href="/pages/6/04/"
            class="navigation navigation-prev navigation-unique"
            aria-label="Previous page: Creating an External Client"
          >
            <i class="fa fa-angle-left"></i>
          </a>
           
          <a
            href="/pages/7/01/"
            class="navigation navigation-next navigation-unique"
            aria-label="Next page: DLL Injector"
          >
            <i class="fa fa-angle-right"></i>
          </a>
          
        </div>
      </div>

      <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({
    "page": {
        "title": "Introduction",
        "level": "1.1",
        "depth": 1,
        
        "next": {
            "title": "DLL Injector",
            "level": "1.2",
            "depth": 1,
            "path": "_pages/7/01.md",
            "ref": "_pages/7/01.md",
            "articles": []
        },
        
        "dir": "ltr"
    },    "config": {
        "plugins": ["fontsettings", "highlight", "livereload", "lunr", "search", "sharing", "theme-default", "livereload"],
        "styles": {
            "ebook": "styles/ebook.css",
            "epub": "styles/epub.css",
            "mobi": "styles/mobi.css",
            "pdf": "styles/pdf.css",
            "print": "styles/print.css",
            "website": "styles/website.css"
        },
        "pluginsConfig": {
            "fontsettings": {
                "family": "sans",
                "size": 2,
                "theme": "white"
            },
            "highlight": {},
            "livereload": {},
            "lunr": {
                "ignoreSpecialCharacters": false,
                "maxIndexSize": 1000000
            },
            "search": {},            "sharing": {
                "facebook": false,

                "google": false,

                "github": true,
                "github_link": "https://github.com/GameHackingAcademy",

                "telegram": false,
                "telegram_link": "https://t.me",

                "instapaper": false,

                "twitter": true,
                "twitter_link": "https://twitter.com/GameHackingAcad",

                "vk": false,

                "weibo": false
            },
"theme-default": {
                "showLevel": false,
                "styles": {
                    "ebook": "styles/ebook.css",
                    "epub": "styles/epub.css",
                    "mobi": "styles/mobi.css",
                    "pdf": "styles/pdf.css",
                    "print": "styles/print.css",
                    "website": "styles/website.css"
                }
            }
        },
        "theme": "default",
        "author": "Tao He",
        "pdf": {
            "pageNumbers": true,
            "fontSize": 12,
            "fontFamily": "Arial",
            "paperSize": "a4",
            "chapterMark": "pagebreak",
            "pageBreaksBefore": "/",
            "margin": {
                "right": 62,
                "left": 62,
                "top": 56,
                "bottom": 56
            }
        },
        "structure": {
            "langs": "LANGS.md",
            "readme": "README.md",
        },
        "variables": {},
        "title": "Game Hacking Academy",
        "language": "en",
        "gitbook": "*"
    },
    "file": {
        "path": "_pages/6/05.md",
        "mtime": "2023-12-25 00:00:00 -0600",
        "type": "markdown"
    },
    "gitbook": {
        "version": "3.2.3",
        "time": "2023-12-31 12:09:34 -0600"
    },
    "basePath": "",
    "book": {
        "language": ""
    }
});
        });
      </script>
    </div><script src="/assets/gitbook/gitbook.js"></script>
<script src="/assets/gitbook/theme.js"></script>

<script src="/assets/gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
<script src="/assets/gitbook/gitbook-plugin-sharing/buttons.js"></script>

<!-- <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
<script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
<script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
<script src="../gitbook/gitbook-plugin-search/search.js"></script> -->

<script src="/assets/gitbook/gitbook-plugin-search-pro/jquery.mark.min.js"></script>
<script src="/assets/gitbook/gitbook-plugin-search-pro/search.js"></script>
<script src="/assets/gitbook/gitbook-plugin-back-to-top-button/plugin.js"></script>
<script src="/assets/gitbook/gitbook-plugin-copy-code-button/toggle.js"></script>

<!-- trackers --><!-- google analytics --><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-160704775-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-160704775-1');
</script>
<script>
      particlesJS("particles-js", {
        particles: {
          number: {
            value: 20,
            density: {
              enable: true,
              value_area: 100,
            },
          },
          color: {
            value: "#6195b9",
          },
          shape: {
            type: "edge",
          },
          opacity: {
            value: 0.3,
            anim: {
              enable: true,
              speed: 0.1,
              opacity_min: 0,
              sync: false,
            },
          },
          size: {
            value: 15,
            random: true,
          },
          line_linked: {
            enable: false,
          },
          move: {
            enable: true,
            speed: 0.5,
            direction: "top",
            random: true,
            straight: true,
            out_mode: "out",
            bounce: false,
            attract: {
              enable: false,
            },
          },
        },
        interactivity: {
          detect_on: "canvas",
          events: {
            onhover: {
              enable: false,
            },
            onclick: {
              enable: false,
            },
            resize: true,
          },
        },
      });
    </script>
  </body>
</html>
